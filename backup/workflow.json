{
  "name": "Family Tax Advisor - Full Pipeline",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "family-tax-advisor",
        "options": {}
      },
      "id": "77da7cc6-fee7-498a-b7f6-36ec2683beb3",
      "name": "T1 Webhook Form Submit",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        -832,
        352
      ],
      "webhookId": "198205a0-2c31-4493-8122-39590de44c5a"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"workflow_meta\": {\n    \"name\": \"Family Tax Advisor â€” Intake & Validation\",\n    \"version\": \"3.0.0\",\n    \"updated\": \"={{ $now.toISO() }}\",\n    \"tax_rules_version\": \"FY2025-26_v1\"\n  },\n  \"llm_config\": {\n    \"classification_model\": \"gpt-4o-mini\",\n    \"analysis_model\": \"claude-sonnet-4-5-20250929\",\n    \"narrative_model\": \"gpt-4o\",\n    \"classification_temperature\": 0.2,\n    \"analysis_temperature\": 0.4,\n    \"creative_temperature\": 0.7,\n    \"max_tokens_classification\": 16384,\n    \"max_tokens_analysis\": 30000,\n    \"max_tokens_narrative\": 16384\n  },\n  \"data_config\": {\n    \"leads_sheet_id\": \"1QBRLjJbCSoRH9l7wQm9VyJgoDmvYeBxj_jQ1N8TBDVs\",\n    \"leads_sheet_name\": \"Family_Tax_Leads\",\n    \"dlq_sheet_id\": \"1QBRLjJbCSoRH9l7wQm9VyJgoDmvYeBxj_jQ1N8TBDVs\",\n    \"dlq_sheet_name\": \"DLQ_Errors\",\n    \"cost_sheet_id\": \"1kNEmg0LY8oJvwVx-YqIZmLKJMhWeLG7ec8OnkUmsQLc\",\n    \"cost_sheet_name\": \"Workflow_Costs\"\n  },\n  \"email_config\": {\n    \"admin_email\": \"chris@lyros.com.au\",\n    \"from_name\": \"Lyros Family Tax Advisor\",\n    \"brand_color\": \"#10b981\",\n    \"brand_dark\": \"#111827\"\n  },\n  \"validation_config\": {\n    \"required_fields_quick\": [\n      \"state\",\n      \"relationship_status\",\n      \"num_dependants\",\n      \"adult_ages\",\n      \"household_income_range\",\n      \"income_split\",\n      \"income_types\",\n      \"home_status\",\n      \"first_name\",\n      \"email\",\n      \"consent_disclaimer\"\n    ],\n    \"valid_states\": [\"NSW\", \"VIC\", \"QLD\", \"SA\", \"WA\", \"TAS\", \"NT\", \"ACT\"],\n    \"valid_relationship_statuses\": [\"single\", \"married\", \"separated\", \"widowed\"],\n    \"valid_income_ranges\": [\n      \"under_45k\", \"45k_65k\", \"65k_90k\", \"90k_120k\",\n      \"120k_180k\", \"180k_250k\", \"250k_plus\"\n    ],\n    \"valid_income_splits\": [\"roughly_equal\", \"one_earner_dominant\", \"single_income\"],\n    \"valid_home_statuses\": [\"own_mortgage\", \"own_outright\", \"renting\", \"living_with_family\"],\n    \"valid_work_from_home\": [\"no\", \"1_2_days\", \"3_4_days\", \"full_time\"],\n    \"valid_private_health\": [\"hospital_extras\", \"hospital_only\", \"extras_only\", \"no\"],\n    \"valid_existing_benefits\": [\"ftb_a\", \"ftb_b\", \"ccs\", \"carer\", \"not_sure\", \"none\"]\n  },\n  \"audit_config\": {\n    \"enabled\": true,\n    \"include_timestamps\": true,\n    \"log_level\": \"info\"\n  }\n}",
        "options": {}
      },
      "id": "54a81378-a396-4126-b21a-f04816305699",
      "name": "C1 Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -608,
        352
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Parses the raw webhook form submission body into the canonical\n * trigger.v1.family_tax_form schema. Validates all required fields\n * for the quick snapshot (sections 1-3) and normalises data types.\n * If deep dive fields (sections 4-8) are present, includes them.\n *\n * v3.0.0 CHANGES:\n * - work_from_home now extracted from BASE payload (was deep dive only)\n * - private_health now extracted from BASE payload (was deep dive only)\n * - existing_benefits NEW field extracted from base payload\n * - Backward compatible: missing v3 fields default to \"unknown\" with warning\n * - Deep dive detection updated: WFH and PHI no longer trigger deep dive alone\n *\n * INPUTS\n * - Schema: trigger.v1.family_tax_form (raw webhook body)\n *   Source: $('T1 Webhook Form Submit') â€” trigger node reference\n * - Config: $('C1 Config') â€” validation rules, enums\n *\n * REMOVALS\n * - Raw webhook metadata fields not needed downstream\n *\n * ADDITIONS\n * - trigger.v1.family_tax_form structured object\n * - form_type (string): \"quick_snapshot\" or \"deep_dive\"\n * - meta object with run_id, valid, warnings\n * - __audit object\n *\n * ROW GUIDE\n * Input: { \"body\": { \"state\": \"VIC\", ... } }\n * Output: { \"trigger\": { \"v1\": { ... } }, \"meta\": { ... }, \"__audit\": { ... } }\n *\n * ASSUMPTIONS\n * - T1 Webhook delivers JSON body via POST\n * - Webflow sends form fields as strings (numbers need coercion)\n * - Multi-select fields arrive as comma-separated strings\n * - Checkbox fields arrive as \"true\"/\"false\" strings\n * - v2.0.0 payloads may arrive without work_from_home/private_health/existing_benefits in base\n *\n * AUDIT\n * Hybrid: __audit + meta.valid=false â†’ DLQ, minor â†’ meta.warnings[]\n */\n\nconst NODE = 'P1 Parse & Validate Form Data';\n\n// === INPUTS ===\nconst triggerData = $('T1 Webhook Form Submit').item.json;\nconst config = $('C1 Config').item.json;\n\n// === RUN TRACKING ===\nconst runId = $execution.id || `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;\n\n// === HELPERS ===\nfunction normaliseString(val) {\n  if (val === null || val === undefined || val === '') return null;\n  return String(val).trim().toLowerCase().replace(/[\\s-]+/g, '_');\n}\n\nfunction normaliseArray(val) {\n  if (Array.isArray(val)) return val.map(v => normaliseString(v)).filter(Boolean);\n  if (typeof val === 'string' && val.trim()) {\n    return val.split(',').map(v => normaliseString(v)).filter(Boolean);\n  }\n  return [];\n}\n\nfunction normaliseBoolean(val) {\n  if (val === true || val === 'true' || val === 'on' || val === '1' || val === 'yes') return true;\n  if (val === false || val === 'false' || val === 'off' || val === '0' || val === 'no') return false;\n  return null;\n}\n\nfunction normaliseNumber(val) {\n  if (val === null || val === undefined || val === '') return null;\n  const num = Number(val);\n  return isNaN(num) ? null : num;\n}\n\nfunction isValidEmail(email) {\n  if (!email) return false;\n  return /^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}$/.test(email);\n}\n\n// === EXTRACT SOURCE DATA ===\nconst src = triggerData.body || triggerData;\nconst beforeKeys = Object.keys(src);\n\nconst errors = [];\nconst warnings = [];\n\n// --- Section 1: Household Basics ---\nconst state = (src.state || '').trim().toUpperCase();\nconst relationship_status = normaliseString(src.relationship_status);\nconst num_dependants = normaliseNumber(src.num_dependants) ?? 0;\nconst dependant_ages = normaliseArray(src.dependant_ages);\nconst adult_ages = normaliseArray(src.adult_ages);\nconst existing_benefits = normaliseArray(src.existing_benefits);  // v3.0.0\n\n// --- Section 2: Income Profile ---\nconst household_income_range = normaliseString(src.household_income_range);\nconst income_split = normaliseString(src.income_split);\nconst income_types = normaliseArray(src.income_types);\nconst salary_sacrifice = normaliseString(src.salary_sacrifice);\nconst work_from_home = normaliseString(src.work_from_home);  // v3.0.0: promoted\n\n// --- Section 3: Property & Assets ---\nconst home_status = normaliseString(src.home_status);\nconst investment_property = normaliseString(src.investment_property);\nconst shares_or_funds = normaliseString(src.shares_or_funds);\nconst crypto = normaliseString(src.crypto);\nconst private_health = normaliseString(src.private_health);  // v3.0.0: promoted\n\n// --- Contact ---\nconst first_name = (src.first_name || '').trim();\nconst email = (src.email || '').trim().toLowerCase();\nconst phone = (src.phone || '').trim() || null;\nconst consent_marketing = normaliseBoolean(src.consent_marketing) || false;\nconst consent_disclaimer = normaliseBoolean(src.consent_disclaimer);\n\n// --- Deep Dive Detection (v3.0.0 updated) ---\n// WFH and PHI are no longer deep-dive-only signals.\n// Deep dive is detected by presence of sections 4-8 specific fields.\nconst has_deep_dive = !!(\n  src.super_balance_range || src.voluntary_contributions ||\n  src.motor_vehicle_work || src.deduction_flags ||\n  src.childcare_type || src.life_events ||\n  src.phi_cover_level || src.phi_all_covered\n);\n\n// --- Deep Dive Sections (4-8, optional) ---\nconst deep_dive = has_deep_dive ? {\n  super: {\n    super_balance_range: normaliseString(src.super_balance_range),\n    voluntary_contributions: normaliseString(src.voluntary_contributions),\n    super_fund_type: normaliseArray(src.super_fund_type),\n    spouse_super_low: normaliseString(src.spouse_super_low)\n  },\n  deductions: {\n    motor_vehicle_work: normaliseString(src.motor_vehicle_work),\n    uniform_clothing: normaliseString(src.uniform_clothing),\n    self_education: normaliseString(src.self_education),\n    union_fees: normaliseString(src.union_fees),\n    income_protection: normaliseString(src.income_protection),\n    donations: normaliseString(src.donations),\n    deduction_flags: normaliseArray(src.deduction_flags)\n  },\n  health: {\n    phi_cover_level: normaliseString(src.phi_cover_level),\n    phi_all_covered: normaliseString(src.phi_all_covered)\n  },\n  children: {\n    childcare_type: normaliseArray(src.childcare_type),\n    childcare_days: normaliseNumber(src.childcare_days),\n    child_disability: normaliseString(src.child_disability)\n  },\n  life_events: normaliseArray(src.life_events)\n} : null;\n\n// === VALIDATION ===\nconst validConfig = config.validation_config;\n\nif (!state) errors.push('Missing required: state');\nelse if (!validConfig.valid_states.includes(state)) errors.push(`Invalid state: ${state}`);\n\nif (!relationship_status) errors.push('Missing required: relationship_status');\nelse if (!validConfig.valid_relationship_statuses.includes(relationship_status))\n  errors.push(`Invalid relationship_status: ${relationship_status}`);\n\nif (num_dependants > 0 && dependant_ages.length === 0)\n  warnings.push('Dependants declared but no ages provided');\n\nif (adult_ages.length === 0) errors.push('Missing required: adult_ages');\n\nif (!household_income_range) errors.push('Missing required: household_income_range');\nelse if (!validConfig.valid_income_ranges.includes(household_income_range))\n  errors.push(`Invalid household_income_range: ${household_income_range}`);\n\nif (!income_split) errors.push('Missing required: income_split');\nelse if (!validConfig.valid_income_splits.includes(income_split))\n  errors.push(`Invalid income_split: ${income_split}`);\n\nif (income_types.length === 0) errors.push('Missing required: income_types (at least one)');\n\nif (!home_status) errors.push('Missing required: home_status');\nelse if (!validConfig.valid_home_statuses.includes(home_status))\n  errors.push(`Invalid home_status: ${home_status}`);\n\nif (!first_name) errors.push('Missing required: first_name');\nif (!email) errors.push('Missing required: email');\nelse if (!isValidEmail(email)) errors.push(`Invalid email format: ${email}`);\n\nif (consent_disclaimer !== true) errors.push('Missing required: consent_disclaimer must be true');\n\n// v3.0.0: Validate promoted fields (non-blocking â€” backward compat)\nif (work_from_home && validConfig.valid_work_from_home &&\n    !validConfig.valid_work_from_home.includes(work_from_home)) {\n  warnings.push(`Unexpected work_from_home value: ${work_from_home}`);\n}\nif (private_health && validConfig.valid_private_health &&\n    !validConfig.valid_private_health.includes(private_health)) {\n  warnings.push(`Unexpected private_health value: ${private_health}`);\n}\n\n// v3.0.0: Backward compatibility â€” flag if promoted fields missing (v2 form)\nif (!work_from_home && !has_deep_dive) {\n  warnings.push('work_from_home not provided (v2 form or unanswered) â€” defaulting to unknown');\n}\nif (!private_health && !has_deep_dive) {\n  warnings.push('private_health not provided (v2 form or unanswered) â€” defaulting to unknown');\n}\n\nif (!phone) warnings.push('No phone provided (optional)');\nif (salary_sacrifice === 'not_sure') warnings.push('User unsure about salary sacrifice status');\n\nconst isValid = errors.length === 0;\nconst formType = has_deep_dive ? 'deep_dive' : 'quick_snapshot';\nconst formVersion = (src.existing_benefits !== undefined) ? '3.0.0' : '2.0.0';\n\n// === BUILD OUTPUT ===\nconst output = {\n  trigger: {\n    v1: {\n      type: 'family_tax_form',\n      form_type: formType,\n      ts: new Date().toISOString(),\n      run_id: runId,\n      household: {\n        state,\n        relationship_status,\n        num_dependants,\n        dependant_ages,\n        adult_ages,\n        existing_benefits  // v3.0.0\n      },\n      income: {\n        household_income_range,\n        income_split,\n        income_types,\n        salary_sacrifice,\n        work_from_home: work_from_home || 'unknown'  // v3.0.0: promoted, with fallback\n      },\n      property: {\n        home_status,\n        investment_property,\n        shares_or_funds,\n        crypto,\n        private_health: private_health || 'unknown'  // v3.0.0: promoted, with fallback\n      },\n      super: deep_dive ? deep_dive.super : null,\n      deductions: deep_dive ? deep_dive.deductions : null,\n      health: deep_dive ? deep_dive.health : null,\n      children: deep_dive ? deep_dive.children : null,\n      life_events: deep_dive ? deep_dive.life_events : [],\n      contact: {\n        first_name,\n        email,\n        phone,\n        consent_marketing,\n        consent_disclaimer\n      },\n      meta_source: {\n        source: 'webflow_form',\n        page_url: src.page_url || src._page_url || null,\n        user_agent: triggerData.headers ? (triggerData.headers['user-agent'] || null) : null,\n        form_version: formVersion\n      }\n    }\n  }\n};\n\nconst afterKeys = Object.keys(output.trigger.v1);\n\nreturn [{\n  json: {\n    ...output,\n    __audit: {\n      node: NODE,\n      ts: new Date().toISOString(),\n      before_keys: beforeKeys,\n      after_keys: afterKeys,\n      added: afterKeys.filter(k => !beforeKeys.includes(k)),\n      removed: beforeKeys.filter(k => !afterKeys.includes(k)),\n      warnings,\n      errors\n    },\n    meta: {\n      run_id: runId,\n      correlation_id: runId,\n      valid: isValid,\n      form_type: formType,\n      warnings,\n      errors,\n      field_count: beforeKeys.length,\n      validation_errors_count: errors.length,\n      form_version: formVersion\n    }\n  }\n}];"
      },
      "id": "5bb549e6-6e1c-4f90-99f7-11e565316de4",
      "name": "P1 Parse & Validate Form Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -384,
        352
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "f7788a42-cfbc-466d-b09f-e192d7419a04",
              "leftValue": "={{ $json.meta.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "a37f7a94-8dcf-4c9f-aa89-45f4f9841919",
      "name": "R1 Route By Validity",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -176,
        352
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.dlq_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.dlq_sheet_name }}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ts": "={{ $json.trigger.v1.ts }}",
            "run_id": "={{ $json.trigger.v1.run_id }}",
            "first_name": "={{ $json.trigger.v1.contact.first_name }}",
            "email": "={{ $json.trigger.v1.contact.email }}",
            "node": "={{ $json.__audit.node }}",
            "form_type": "={{ $json.meta.form_type }}",
            "raw_field_count": "={{ $json.meta.field_count }}",
            "workflow_name": "Family Tax Advisor",
            "errors": "={{ $json.meta.errors.join('; ') }}",
            "warnings": "={{ $json.meta.warnings.join('; ') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "run_id",
              "displayName": "run_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "workflow_name",
              "displayName": "workflow_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "node",
              "displayName": "node",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "errors",
              "displayName": "errors",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "warnings",
              "displayName": "warnings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "raw_field_count",
              "displayName": "raw_field_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "form_type",
              "displayName": "form_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e3cee053-0abe-43a2-9983-7aa02881b740",
      "name": "S1 DLQ Store",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        64,
        464
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "abKeADxb1EcKR29m",
          "name": "Google Sheets (Lyros) - 18/11/25 10:30am"
        }
      }
    },
    {
      "parameters": {
        "content": "## ğŸ“‹ Family Tax Advisor â€” Phase 1: Intake & Validation\n\n**Webhook URL:** `POST /webhook/family-tax-advisor`\n\n**Flow:** T1 Webhook â†’ C1 Config â†’ P1 Parse & Validate â†’ R1 Route\n- âœ… Valid â†’ U1 (placeholder for Phase 2 LLM pipeline)\n- âŒ Invalid â†’ S1 DLQ Store â†’ X1 Alert Email\n\n**Schema:** `trigger.v1.family_tax_form`\n\n**Manual setup required:**\n1. Create Google Sheet with tabs: `Family_Tax_Leads` + `DLQ_Errors`\n2. Replace `REPLACE_WITH_LEADS_SHEET_ID` in C1 Config\n3. Set Google Sheets + Gmail credentials on S1 and X1\n4. Test with sample POST to webhook URL",
        "height": 428,
        "width": 420,
        "color": 4
      },
      "id": "f12e8743-e6c7-4c26-b051-66d405e0752c",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        -1376,
        224
      ]
    },
    {
      "parameters": {
        "content": "## âŒ DLQ Path\nInvalid submissions are:\n1. Stored to `DLQ_Errors` sheet\n2. Alert email sent to Chris\n\nCommon causes:\n- Missing required fields\n- Invalid state/income values\n- Disclaimer not accepted",
        "height": 268,
        "width": 328,
        "color": 2
      },
      "id": "71944dd0-3ebc-4baf-b282-bee857638b84",
      "name": "Sticky Note1",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        64,
        640
      ]
    },
    {
      "parameters": {
        "content": "## âœ… Valid Path\nPhase 2 connects here:\nâ†’ P2/P3 Prepare Payload\nâ†’ P4 Redact PII\nâ†’ L1 Classify\nâ†’ L2 Analyse\nâ†’ L3 Narrate\nâ†’ Report & Delivery",
        "height": 200,
        "width": 280,
        "color": 4
      },
      "id": "5786be43-908c-49c6-9228-f9e08807d5e4",
      "name": "Sticky Note2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.chatTrigger",
      "typeVersion": 1.4,
      "position": [
        -832,
        512
      ],
      "id": "484a3360-513c-4d91-b153-44480075e158",
      "name": "MCP",
      "webhookId": "9660dcb2-6e12-42f3-b218-a3975ca3894f"
    },
    {
      "parameters": {
        "toRecipients": "={{ $('C1 Config').item.json.email_config.admin_email }}",
        "subject": "=ğŸš¨ Family Tax Advisor â€” Validation Failed | {{ $json.run_id }}",
        "additionalFields": {
          "from": "automations@lyros.com.au"
        }
      },
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        272,
        464
      ],
      "id": "071f8a52-1347-40cf-889d-7a1c9e062bef",
      "name": "X1 Send DLQ Alert",
      "webhookId": "c0ede7f1-3685-4eef-a2a4-435f8dcca9e4",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "rniSgnqyp5rv9Xf9",
          "name": "Outlook (Lyros) - n8n OAuth (Exp 31/7/2026)"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "d1490135-6d9b-4377-ad45-f7413e4404d0",
              "leftValue": "={{ $json.meta.form_type }}",
              "rightValue": "deep_dive",
              "operator": {
                "type": "string",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "d18daa81-3fd3-4d0f-b5dd-409ee3bb1324",
      "name": "R2 Route By Form Type",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        272,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Prepares LLM payload for QUICK SNAPSHOT (sections 1-3).\n * v3.0.0: Now includes work_from_home, private_health, existing_benefits\n * which were promoted from deep dive to quick snapshot.\n *\n * INPUTS\n * - $input: trigger.v1 data from R2 route\n * - $('C1 Config'): validation config\n *\n * ADDITIONS\n * - llm_payload: structured prompt-ready data including promoted fields\n * - promoted_field_status: flags which promoted fields have real vs unknown values\n * - analysis_depth: \"quick_snapshot\"\n *\n * ROW GUIDE\n * Input: { trigger: { v1: { household: {...}, income: {...}, property: {...} } } }\n * Output: { trigger: ..., llm_payload: { analysis_depth, household, income, property }, ... }\n *\n * ASSUMPTIONS\n * - work_from_home is in tv1.income (may be \"unknown\" for v2 forms)\n * - private_health is in tv1.property (may be \"unknown\" for v2 forms)\n * - existing_benefits is in tv1.household (may be empty array)\n *\n * AUDIT\n * Hybrid: preserves run_id, passes contact separately\n */\n\nconst NODE = 'P2 Prepare Quick Analysis Payload';\nconst data = $input.item.json;\nconst tv1 = data.trigger.v1;\nconst runId = data.meta.run_id;\n\nconst llmPayload = {\n  analysis_depth: 'quick_snapshot',\n  household: tv1.household,       // includes existing_benefits (v3.0.0)\n  income: tv1.income,             // includes work_from_home (v3.0.0)\n  property: tv1.property          // includes private_health (v3.0.0)\n};\n\n// v3.0.0: Flag which promoted fields are available vs unknown\nconst promotedFieldStatus = {\n  work_from_home: tv1.income.work_from_home !== 'unknown',\n  private_health: tv1.property.private_health !== 'unknown',\n  existing_benefits: (tv1.household.existing_benefits || []).length > 0\n};\n\nreturn [{\n  json: {\n    trigger: data.trigger,\n    llm_payload: llmPayload,\n    promoted_field_status: promotedFieldStatus,\n    analysis_depth: 'quick_snapshot',\n    contact: tv1.contact,\n    __audit: {\n      node: NODE,\n      ts: new Date().toISOString(),\n      warnings: [],\n      errors: []\n    },\n    meta: {\n      run_id: runId,\n      correlation_id: runId,\n      valid: true,\n      form_type: 'quick_snapshot',\n      form_version: data.meta.form_version || '2.0.0',\n      warnings: [],\n      errors: []\n    }\n  }\n}];"
      },
      "id": "de41fe0b-1e52-49fa-bb8d-0f5b33a6ae42",
      "name": "P2 Prepare Quick Analysis Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        352
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Prepares LLM payload for DEEP DIVE (all sections 1-8).\n * v3.0.0: work_from_home and private_health are now in the base\n * trigger.v1 sections (income/property), NOT duplicated in deep_dive sub-objects.\n * Deep dive health section now only has phi_cover_level and phi_all_covered.\n * Deep dive deductions section no longer has work_from_home.\n *\n * INPUTS\n * - $input: trigger.v1 data from R2 route\n * - $('C1 Config'): validation config\n *\n * ADDITIONS\n * - llm_payload: full prompt-ready data including deep dive sections\n * - promoted_field_status: flags which promoted fields have real values\n * - analysis_depth: \"deep_dive\"\n *\n * ROW GUIDE\n * Input: { trigger: { v1: { household, income, property, super, deductions, health, children, life_events } } }\n * Output: { trigger: ..., llm_payload: { analysis_depth: \"deep_dive\", ... all sections ... }, ... }\n *\n * ASSUMPTIONS\n * - work_from_home is in tv1.income (base), not tv1.deductions (deep)\n * - private_health is in tv1.property (base), not tv1.health (deep)\n * - tv1.health now only contains phi_cover_level, phi_all_covered (detail fields)\n *\n * AUDIT\n * Hybrid: preserves run_id, passes contact separately\n */\n\nconst NODE = 'P3 Prepare Full Analysis Payload';\nconst data = $input.item.json;\nconst tv1 = data.trigger.v1;\nconst runId = data.meta.run_id;\n\nconst llmPayload = {\n  analysis_depth: 'deep_dive',\n  household: tv1.household,       // includes existing_benefits (v3.0.0)\n  income: tv1.income,             // includes work_from_home (v3.0.0)\n  property: tv1.property,         // includes private_health (v3.0.0)\n  super: tv1.super || {},\n  deductions: tv1.deductions || {},   // v3.0.0: no longer has work_from_home\n  health: tv1.health || {},           // v3.0.0: only phi_cover_level, phi_all_covered\n  children: tv1.children || {},\n  life_events: tv1.life_events || []\n};\n\n// v3.0.0: All promoted fields are guaranteed available in deep dive\nconst promotedFieldStatus = {\n  work_from_home: true,\n  private_health: true,\n  existing_benefits: (tv1.household.existing_benefits || []).length > 0\n};\n\nreturn [{\n  json: {\n    trigger: data.trigger,\n    llm_payload: llmPayload,\n    promoted_field_status: promotedFieldStatus,\n    analysis_depth: 'deep_dive',\n    contact: tv1.contact,\n    __audit: {\n      node: NODE,\n      ts: new Date().toISOString(),\n      warnings: [],\n      errors: []\n    },\n    meta: {\n      run_id: runId,\n      correlation_id: runId,\n      valid: true,\n      form_type: 'deep_dive',\n      form_version: data.meta.form_version || '2.0.0',\n      warnings: [],\n      errors: []\n    }\n  }\n}];"
      },
      "id": "b9efb140-719d-41aa-98b5-8053cad7b1bd",
      "name": "P3 Prepare Full Analysis Payload",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        496,
        192
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Redacts PII from LLM payload. Preserves original contact separately.\n *\n * INPUTS\n * - $input: P2 or P3 output with llm_payload and contact\n *\n * ADDITIONS\n * - redacted_payload: PII-free version for LLM\n * - original_contact: preserved for downstream email/storage\n *\n * AUDIT\n * Tracks redaction count\n */\n\nconst NODE = 'P4 Redact PII For LLM';\nconst data = $input.item.json;\nconst runId = data.meta.run_id;\nconst originalContact = JSON.parse(JSON.stringify(data.contact));\nlet redactionCount = 0;\n\nconst emailRx = /\\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}\\b/g;\nconst phoneRx = /(\\+?\\d{1,3}[-.\\s]?)?\\(?\\d{2,4}\\)?[-.\\s]?\\d{2,4}[-.\\s]?\\d{2,4}/g;\n\nfunction redactObj(obj) {\n  if (obj === null || obj === undefined) return obj;\n  if (typeof obj === 'string') {\n    let r = obj.replace(emailRx, () => { redactionCount++; return '[EMAIL]'; });\n    r = r.replace(phoneRx, () => { redactionCount++; return '[PHONE]'; });\n    return r;\n  }\n  if (Array.isArray(obj)) return obj.map(i => redactObj(i));\n  if (typeof obj === 'object') {\n    const result = {};\n    for (const [k, v] of Object.entries(obj)) {\n      if (['first_name','email','phone','name'].includes(k)) { result[k] = '[REDACTED]'; redactionCount++; }\n      else result[k] = redactObj(v);\n    }\n    return result;\n  }\n  return obj;\n}\n\nconst redactedPayload = redactObj(JSON.parse(JSON.stringify(data.llm_payload)));\n\nreturn [{\n  json: {\n    trigger: data.trigger,\n    redacted_payload: redactedPayload,\n    original_contact: originalContact,\n    pii_map: { first_name: originalContact.first_name, email: originalContact.email, phone: originalContact.phone },\n    analysis_depth: data.analysis_depth,\n    __audit: { node: NODE, ts: new Date().toISOString(), redaction_count: redactionCount, warnings: [], errors: [] },\n    meta: { run_id: runId, correlation_id: runId, valid: true, form_type: data.analysis_depth, warnings: [], errors: [] }\n  }\n}];"
      },
      "id": "4a41fa74-e5ba-47a2-9d73-688a0da4b464",
      "name": "P4 Redact PII For LLM",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        688,
        272
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Builds OpenAI API request for L1 classification.\n * V3: Receives promoted fields (private_health, work_from_home) and\n *     existing_benefits from Batch A schema. Each eligibility item now\n *     includes a status field (new_opportunity | confirm_existing | optimise_existing).\n *\n * INPUTS\n * - $input: P4 Redact PII output (redacted_payload, analysis_depth, etc.)\n * - $('C1 Config'): config reference (llm_config)\n *\n * REMOVALS - None\n *\n * ADDITIONS\n * - OpenAI messages array with updated system prompt\n * - Status field in output schema for confirm vs new framing\n *\n * ROW GUIDE\n * Input:  { redacted_payload: {...}, analysis_depth: \"...\", ...passthrough }\n * Output: { model, temperature, max_tokens, response_format, messages: [...] }\n *\n * ASSUMPTIONS\n * - P4 passes redacted_payload with all trigger.v1 fields (including v3 promoted fields)\n * - existing_benefits may be empty string or comma-separated values\n * - private_health and work_from_home may be \"unknown\" for backward compat (v2 forms)\n *\n * AUDIT\n * Lightweight build step â€” no validation needed.\n */\nconst NODE = 'E1 Build L1 Request';\nconst data = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst lc = config.llm_config;\n\nconst systemPrompt = `ROLE: You are an Australian tax classification engine for FY2025-26 (1 July 2025 â€“ 30 June 2026).\n\nGOAL: Analyse the household data and classify eligibility for all applicable tax benefits, offsets, deductions, and government payments. Return ONLY valid JSON.\n\nTAX RULES:\nBRACKETS: $0-$18,200=0% | $18,201-$45,000=16% | $45,001-$135,000=30% | $135,001-$190,000=37% | $190,001+=45%. Plus 2% Medicare Levy.\nLITO: <=$37,500=$700 | $37,501-$45,000=$700-5c/$1 | $45,001-$66,667=$325-1.5c/$1 | >$66,667=Nil.\nMLS (no hospital cover): Singles <=$101k/Families <=$202k=0% | T1=1.0% | T2=1.25% | T3=1.5%. Family +$1,500/child after first.\nPHI REBATE (under 65): Base(<=101k/202k)=24.608% | T1=16.405% | T2=8.202% | T3=0%.\nFTB A: Max $222.04/fn(0-12) $288.82/fn(13-19). Base $71.26/fn. Income test: max if <=$65,189, reduces 20c/$1. Supplement $938.05/child if <=$80k.\nFTB B: Couples primary <=$117,390, secondary <=$6,497. Max $188.86/fn(0-4) $131.74/fn(5-18). Supplement $448.95. Single parents: no secondary earner test.\nCCS: 90% if <=$85,279. Tapers 1%/$5,000. Zero at $535,279+. 3-Day Guarantee from Jan 2026.\nSUPER: SG 12%. CC cap $30,000. NCC cap $120,000. Carry-forward if TSB<$500k. Co-contrib $500 if <=$45,400. Spouse offset $540 if spouse<$40k. Div293 if income+super>$250k. FHSS max $50k.\nSAPTO: Single max $2,230. Couple max $1,602 each. Must be Age Pension age.\nWFH: Fixed rate 67c/hr. Covers electricity, phone, internet, stationery.\n\nINCOME MIDPOINTS: under_45k=$32k | 45k_65k=$55k | 65k_90k=$77.5k | 90k_120k=$105k | 120k_180k=$150k | 180k_250k=$215k | 250k_plus=$300k.\nSPLITS: roughly_equal=50/50 | one_earner_dominant=70/30 | single_income=100/0.\n\nEXISTING BENEFITS HANDLING:\nThe input may include an \"existing_benefits\" field (comma-separated) listing benefits the user already claims (e.g. \"ftb_a,ccs\").\n- If a benefit is listed in existing_benefits, set its status to \"confirm_existing\"\n- If a benefit is NOT listed but the user is eligible, set status to \"new_opportunity\"\n- If a benefit is listed AND the user could optimise it (e.g. increase salary sacrifice to boost FTB), set status to \"optimise_existing\"\n- If existing_benefits is empty, \"none\", or \"not_sure\", treat ALL eligible benefits as \"new_opportunity\"\n\nPRIVATE HEALTH INSURANCE:\nThe input includes \"private_health\" â€” one of: hospital_extras, hospital_only, extras_only, no, unknown.\n- \"no\" or \"extras_only\" = NO hospital cover â†’ MLS applies if income exceeds threshold\n- \"hospital_extras\" or \"hospital_only\" = HAS hospital cover â†’ MLS exempt, check PHI rebate tier\n- \"unknown\" = insufficient data, flag mls.uncertain = true\n\nWORK FROM HOME:\nThe input includes \"work_from_home\" â€” one of: no, 1_2_days, 3_4_days, full_time, unknown.\n- If not \"no\" and not \"unknown\", classify WFH deduction as applicable\n- Estimate hours: 1_2_daysâ‰ˆ400hrs/yr, 3_4_daysâ‰ˆ800hrs/yr, full_timeâ‰ˆ1,200hrs/yr\n\nCONSTRAINTS: Use midpoints. Flag uncertainty at threshold boundaries. Never fabricate amounts.\n\nOUTPUT JSON:\n{\"classification\":{\"tax_bracket\":{\"estimated_household_income\":0,\"primary_earner_bracket\":\"\",\"primary_marginal_rate\":0,\"secondary_earner_bracket\":\"\",\"secondary_marginal_rate\":0},\"lito\":{\"primary_eligible\":false,\"primary_estimated\":0,\"secondary_eligible\":false,\"secondary_estimated\":0},\"ftb_a\":{\"eligible\":\"\",\"estimated_annual\":0,\"status\":\"new_opportunity\",\"notes\":\"\"},\"ftb_b\":{\"eligible\":\"\",\"estimated_annual\":0,\"status\":\"new_opportunity\",\"notes\":\"\"},\"ccs\":{\"eligible\":false,\"estimated_percentage\":0,\"status\":\"new_opportunity\",\"notes\":\"\"},\"mls\":{\"at_risk\":false,\"estimated_annual_cost\":0,\"tier\":\"\",\"uncertain\":false,\"notes\":\"\"},\"phi_rebate\":{\"eligible\":false,\"tier\":\"\",\"rebate_percentage\":0},\"super_flags\":{\"carry_forward_eligible\":false,\"spouse_contribution_eligible\":false,\"co_contribution_eligible\":false,\"div293_risk\":false,\"fhss_eligible\":false,\"notes\":\"\"},\"sapto\":{\"eligible\":false,\"notes\":\"\"},\"wfh_deduction\":{\"applicable\":false,\"estimated_hours\":0,\"estimated_annual\":0,\"notes\":\"\"},\"deduction_categories\":[],\"applicable_concessions\":[]},\"meta\":{\"confident\":true,\"form_type\":\"\",\"income_estimate_basis\":\"\",\"notes\":\"\"}}`;\n\nconst userContent = JSON.stringify(data.redacted_payload, null, 2);\n\nreturn [{ json: {\n  model: lc.classification_model,\n  temperature: lc.classification_temperature,\n  max_tokens: lc.max_tokens_classification,\n  response_format: { type: \"json_object\" },\n  messages: [\n    { role: \"system\", content: systemPrompt },\n    { role: \"user\", content: \"Analyse this Australian household data and classify tax eligibility:\\n\\n\" + userContent }\n  ]\n}}];"
      },
      "id": "a2b22ec7-d72a-4f0f-86a1-71c5bf46a7dc",
      "name": "E1 Build L1 Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        864,
        352
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $json.model, messages: $json.messages, temperature: $json.temperature, max_tokens: $json.max_tokens, response_format: $json.response_format }) }}",
        "options": {
          "timeout": 60000
        }
      },
      "id": "7fae963e-acea-4f29-bcbf-96ce6020f098",
      "name": "L1 GPT Classify Eligibility",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1056,
        352
      ],
      "credentials": {
        "openAiApi": {
          "id": "ZfJnrcuhjWgP2JYI",
          "name": "n8n Workflows"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "9c4c16c9-5947-4303-9ea5-4e8fefcb4ac3",
      "name": "U2 Merge L1 Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        1248,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Parses L1 classification from merged HTTP response + P4 passthrough.\n * V3.1: Parses new status field per eligibility item (new_opportunity |\n *       confirm_existing | optimise_existing). Passes promoted fields\n *       (private_health, work_from_home, existing_benefits) through to L2.\n * Defensive: strips markdown fences, detects truncation.\n *\n * INPUTS\n * - $input: U2 Merge output (L1 response + P4 passthrough via combineByPosition)\n * - $('C1 Config'): config reference\n *\n * REMOVALS\n * - Raw OpenAI response fields replaced by structured l1_classification\n *\n * ADDITIONS\n * - l1_classification (object): parsed classification with status fields\n * - l1_usage (object): token counts\n *\n * ROW GUIDE\n * Input:  { choices: [{message:{content:\"{...}\"}}], usage: {...}, trigger: {...}, ...passthrough }\n * Output: { l1_classification: {...}, l1_usage: {...}, trigger: {...}, ...passthrough }\n *\n * ASSUMPTIONS\n * - OpenAI json_object mode returns clean JSON but we defend against fences\n * - U2 Merge combines L1 HTTP (input 0) + P4 passthrough (input 1)\n * - L1 now includes status field per item and wfh_deduction section\n *\n * AUDIT\n * Hybrid: validates required classification keys including new v3.1 fields.\n * Errors cascade to R3 â†’ DLQ via meta.valid.\n */\nconst NODE = 'N2 Parse L1 & Build L2 Context';\nconst m = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst warnings = [];\nconst errors = [];\nconst runId = m.meta?.run_id || $execution.id || `${Date.now()}`;\n\nfunction cleanLlmJson(raw) {\n  if (typeof raw !== 'string') return raw;\n  let s = raw.trim();\n  s = s.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?\\s*```\\s*$/i, '');\n  return s.trim();\n}\n\nlet l1 = null;\nconst l1Usage = m.usage || null;\n\nconst stopReason = m.choices?.[0]?.finish_reason;\nif (stopReason === 'length') {\n  warnings.push('L1 truncated (max_tokens) â€” output may be incomplete');\n}\n\ntry {\n  const raw = m.choices?.[0]?.message?.content;\n  if (!raw) throw new Error('No L1 content in choices[0].message.content');\n  const cleaned = cleanLlmJson(raw);\n  l1 = typeof cleaned === 'object' ? cleaned : JSON.parse(cleaned);\n\n  // --- V3.1 key validation ---\n  const cls = l1.classification || l1;\n  const classKeys = Object.keys(cls);\n\n  // Critical keys (must exist for L2 to function)\n  ['tax_bracket', 'mls', 'deduction_categories'].forEach(f => {\n    if (!classKeys.includes(f)) warnings.push('L1 missing key: ' + f);\n  });\n\n  // V3.1 new keys (desirable but not fatal)\n  if (!cls.wfh_deduction) warnings.push('L1 missing v3.1 key: wfh_deduction');\n\n  // Validate status fields exist on benefit items\n  const benefitKeys = ['ftb_a', 'ftb_b', 'ccs'];\n  benefitKeys.forEach(bk => {\n    if (cls[bk] && !cls[bk].status) {\n      warnings.push(`L1 ${bk} missing status field â€” defaulting to new_opportunity`);\n      if (cls[bk]) cls[bk].status = 'new_opportunity';\n    }\n  });\n\n  // Ensure classification is at top level for downstream\n  if (l1.classification) {\n    l1 = l1.classification;\n  }\n\n} catch (e) {\n  errors.push('L1 parse failed: ' + e.message);\n  l1 = { error: e.message };\n}\n\nreturn [{ json: {\n  l1_classification: l1,\n  l1_usage: l1Usage,\n  trigger: m.trigger,\n  redacted_payload: m.redacted_payload,\n  original_contact: m.original_contact,\n  pii_map: m.pii_map,\n  analysis_depth: m.analysis_depth,\n  // V3.1: pass promoted fields explicitly for L2 context\n  existing_benefits: m.redacted_payload?.existing_benefits || m.existing_benefits || '',\n  private_health: m.redacted_payload?.private_health || m.private_health || 'unknown',\n  work_from_home: m.redacted_payload?.work_from_home || m.work_from_home || 'unknown',\n  __audit: { node: NODE, ts: new Date().toISOString(), warnings, errors },\n  meta: {\n    run_id: runId,\n    correlation_id: runId,\n    valid: errors.length === 0,\n    form_type: m.analysis_depth || 'quick_snapshot',\n    l1_model: l1Usage?.model || config.llm_config.classification_model,\n    l1_total_tokens: l1Usage ? (l1Usage.prompt_tokens + l1Usage.completion_tokens) : 0,\n    warnings,\n    errors\n  }\n}}];"
      },
      "id": "4e707f3f-6d61-4679-93ff-c596f8854d65",
      "name": "N2 Parse L1 & Build L2 Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1456,
        256
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Builds Anthropic API request for L2 deep analysis.\n * V3.1: 8 new constraints addressing Issues 1,4,5,7,8,11,13,15,16.\n *       Consolidated opportunities, tabular calculations, scenario analysis,\n *       cross-benefit references. Receives promoted fields from Batch A.\n *\n * INPUTS\n * - $input: N2 output (l1_classification + redacted_payload + passthrough)\n * - $('C1 Config'): config reference (llm_config)\n *\n * REMOVALS - None\n * ADDITIONS - Anthropic messages array with updated system prompt\n *\n * ROW GUIDE\n * Input:  { l1_classification: {...}, redacted_payload: {...}, analysis_depth: \"...\", ...passthrough }\n * Output: { model, max_tokens, temperature, system, messages: [...] }\n *\n * ASSUMPTIONS\n * - N2 passes l1_classification with status fields per item\n * - redacted_payload includes v3 promoted fields (private_health, work_from_home, existing_benefits)\n * - existing_benefits may be empty/\"none\"/\"not_sure\" or comma-separated values\n *\n * AUDIT\n * Lightweight build step.\n */\nconst NODE = 'E2 Build L2 Request';\nconst data = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst lc = config.llm_config;\n\nconst systemPrompt = `ROLE: Senior Australian tax analyst for FY2025-26. Deep expertise in personal tax, superannuation, government benefits, and family payments. You write in Australian English (analyse, maximise, optimise, recognise, colour, defence, centre, labour, favour, etc.). Never use American spellings.\n\nGOAL: Using the classification from Pass 1 AND household data, produce a consolidated analysis where EVERY financial opportunity is in a single ranked list. Do NOT separate government benefits, deductions, and super into different sections â€” they all go into one \"opportunities\" array, ranked by estimated annual value (highest first).\n\nEach opportunity must be FULLY SELF-CONTAINED: who it applies to, why they qualify, a row-by-row calculation, what to do, and where to go.\n\nReturn ONLY valid JSON. No markdown, no code fences.\n\nLEGAL: This is general information only, NOT personal advice. Use \"you may wish to consider\", never \"you should\" or \"you must\". All figures are estimates based on the information provided. Use \"assumed income\" or \"estimated income based on your selected range\" â€” NEVER \"current income\" or \"your income\" when referencing midpoint figures derived from range selections.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nTAX RULES FY2025-26\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nBRACKETS: $0-$18,200=0% | $18,201-$45,000=16% | $45,001-$135,000=30% | $135,001-$190,000=37% | $190,001+=45%. Plus 2% Medicare Levy.\nLITO: <=$37,500=$700 | $37,501-$45,000=$700 minus 5c/$1 over $37,500 | $45,001-$66,667=$325 minus 1.5c/$1 over $45,000 | >$66,667=Nil.\nMLS (no private hospital cover): Singles<=$101k/Families<=$202k=0% | T1($101k-$134k/$202k-$268k)=1.0% | T2($134k-$168k/$268k-$336k)=1.25% | T3(>$168k/>$336k)=1.5%. Family threshold increases $1,500 per dependent child after the first.\nFTB A: Max $222.04/fn (0-12yr), $288.82/fn (13-19yr). Base rate $71.26/fn. Maximum rate if family income <=$65,189. Reduced 20c/$1 above $65,189 until base rate, then 30c/$1 above ~$117,390. End-of-year supplement $938.05 per child if family income <=$80,000.\nFTB B: Primary earner income <=$117,390. Secondary earner income <=$6,497 for max rate (COUPLES ONLY â€” single parents have no secondary earner test). Max $188.86/fn (youngest 0-4), $131.74/fn (youngest 5-18). End-of-year supplement $448.95.\nCCS: 90% subsidy if family income <=$85,279. Tapers 1% per $5,000 above. Zero at $535,279+. 3-Day Activity Test Guarantee from January 2026. Hourly rate caps apply by service type.\nSUPER: SG 12%. Concessional contributions cap $30,000. Non-concessional cap $120,000 (bring-forward 3yr if TSB<$1.9M). Carry-forward unused CC if TSB<$500k (from FY2018-19). Co-contribution $500 if income <=$45,400 (tapers to $60,400). Spouse contribution offset $540 if spouse income <$40,000. Div293 additional 15% tax if income+super >$250k. FHSS max $50k ($15k/yr). Transfer Balance Cap $1.9M.\nCGT: 50% discount if held >12 months. Main residence exempt. 6-year absence rule. Small business concessions if turnover <$2M.\nDEDUCTIONS: WFH fixed rate 67c/hr (covers electricity, phone, internet, stationery). Vehicle 88c/km (max 5,000km = $4,400) or logbook method. Laundry $1/load max $150 without receipts. Self-education if maintains/improves current employment skills. Union/professional fees 100%. Income protection premiums 100%. Donations to DGR-registered charities 100%.\nSAPTO: Single max $2,230 (income <=$50,119 for some offset). Couple max $1,602 each.\nCARER ALLOWANCE: $153.50/fn ($3,991/yr) + $600 annual supplement = $4,591/yr total. Health Care Card included.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMANDATORY CONSTRAINTS (Issues 1,4,5,7,8,11,13,15,16)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nCONSTRAINT 1 â€” CCS CARE TYPE BY AGE (Critical):\nWhen calculating Child Care Subsidy (CCS), you MUST match the care type to the child's age:\n- Children 0â€“4 (not yet at school): Use long day care or family day care rates. Hourly cap ~$13.73 (centre-based). Typical 10-hour sessions, up to 5 days/week.\n- Children 5â€“12 (school age): Use Outside School Hours Care (OSHC) rates. Hourly cap ~$13.41. Typical 3â€“4 hours on school days (before/after school), 8â€“10 hours during vacation care. Annual cost is SUBSTANTIALLY lower than long day care.\n- If child ages span both groups, calculate SEPARATELY for each age group with appropriate care type and hours.\n- NEVER apply long day care hourly rates or 10-hour day assumptions to school-age children.\n- If the form specifies childcare_type (deep dive), use that. If not specified, infer from child ages.\n\nCONSTRAINT 2 â€” SALARY SACRIFICE AFFORDABILITY (High):\nFor salary sacrifice recommendations, you MUST include:\n1. The fortnightly take-home pay REDUCTION amount (not just annual benefit)\n2. A clear statement that super contributions cannot be accessed until preservation age (currently 60) unless FHSS scheme applies\n3. Split the benefit into: \"immediate_household_benefit\" (e.g. FTB A increase from lower assessable income) vs \"long_term_wealth_building\" (super tax saving locked until age 60)\n4. If the household has dependants and income under $120k, add affordability_warning: \"This strategy reduces fortnightly take-home pay by approximately $X. Consider whether your household budget can absorb this reduction.\"\n5. Include an \"affordability_flag\" field: true if fortnightly reduction exceeds 10% of estimated fortnightly take-home pay\n\nCONSTRAINT 3 â€” PRIORITY/CONFIDENCE LABELS BY DOLLAR IMPACT (High):\nThe \"confidence\" field on opportunities MUST correlate with estimated annual dollar value:\n- \"high\": Estimated annual value >= $1,000\n- \"medium\": Estimated annual value $200â€“$999\n- \"low\": Estimated annual value < $200\nThis reflects financial impact magnitude. Do NOT use confidence to indicate data certainty â€” use the \"meta.confident\" field for that.\n\nCONSTRAINT 4 â€” TITLE MUST MATCH CALCULATION TOTAL (Medium):\nEvery opportunity's title figure and estimated_annual_value MUST exactly match the final row of its calculation_rows. If a supplement is included in the calculation, it MUST be included in the title and estimated_annual_value. No discrepancies between headline and workings.\n\nCONSTRAINT 5 â€” MOTOR VEHICLE METHOD SELECTION (Medium):\nFor motor vehicle deductions, ALWAYS calculate BOTH methods and recommend whichever produces the HIGHER deduction:\n- Cents per km: work_km Ã— $0.88 (capped at 5,000km = $4,400)\n- Logbook: total_vehicle_costs Ã— work_use_percentage\nShow both calculations in calculation_rows. Recommend the higher one. Only recommend logbook if the logbook figure exceeds the cents-per-km figure at the stated work-use percentage.\n\nCONSTRAINT 6 â€” FTB B SINGLE PARENT HANDLING (Medium):\nFor single-parent households (widowed, separated, or single with dependants):\n- Do NOT include secondary earner income test rows â€” they are irrelevant\n- FTB B eligibility depends ONLY on primary earner income (<$117,390)\n- Do NOT show \"Secondary earner income test: âœ“ Pass\" for households without a partner\n- Explain that single parents are automatically eligible for FTB B if income test is met\n\nCONSTRAINT 7 â€” EXISTING BENEFITS: CONFIRM vs NEW (Medium):\nThe input includes \"existing_benefits\" (comma-separated list of benefits the user already claims).\n- If a benefit code appears in existing_benefits (e.g. \"ftb_a\", \"ccs\", \"ftb_b\", \"carer\"):\n  â†’ Set status: \"confirm_existing\"\n  â†’ Frame as \"Confirm & Optimise\" â€” focus on whether they're receiving the MAXIMUM amount\n  â†’ Do NOT present the full benefit value as estimated_annual_value â€” instead calculate the INCREMENTAL optimisation value (e.g. \"you may be able to increase your FTB A by $X through salary sacrifice\")\n  â†’ If no optimisation available, set estimated_annual_value to 0 and note \"Already claiming â€” confirm your income estimate is accurate\"\n- If a benefit is NOT in existing_benefits: set status: \"new_opportunity\" with full value\n- If existing_benefits is empty, \"none\", or \"not_sure\": treat ALL as \"new_opportunity\" (user hasn't confirmed)\n\nCONSTRAINT 8 â€” DUAL-EARNER INCOME SCENARIOS (Low):\nFor income scenario analysis in coupled households (roughly_equal or one_earner_dominant splits):\n- Model income changes on the PRIMARY earner only (dominant income)\n- Note that marginal tax impact differs by which earner's income changes\n- For one_earner_dominant: clearly state the Â±20% applies to the primary earner's estimated income\n\nCONSTRAINT 9 â€” INTERSTATE COMPARISON (Low):\nWhen generating interstate comparison scenarios (if life_events includes \"moved_interstate\"):\n- Include indicative stamp duty concession thresholds for both states\n- Reference first home buyer exemptions where applicable\n- Note any state-specific land tax differences\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nKEY GOVERNMENT PORTAL URLS (use in url fields)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n- Services Australia FTB: https://www.servicesaustralia.gov.au/family-tax-benefit\n- Services Australia CCS: https://www.servicesaustralia.gov.au/child-care-subsidy\n- Services Australia Carer Allowance: https://www.servicesaustralia.gov.au/carer-allowance\n- ATO myTax: https://my.gov.au\n- ATO car expenses: https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/transport-and-travel-expenses/car-expenses\n- ATO WFH: https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/home-office-expenses\n- ATO clothing: https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/clothing-laundry-and-dry-cleaning-expenses\n- ATO donations: https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/gifts-and-donations\n- ATO shares: https://www.ato.gov.au/individuals-and-families/investments-and-assets/shares-and-similar-investments\n- ATO crypto: https://www.ato.gov.au/individuals-and-families/investments-and-assets/crypto-asset-investments\n- ATO salary sacrifice: https://www.ato.gov.au/individuals-and-families/super/growing-and-keeping-track-of-your-super/how-to-save-more-in-your-super/salary-sacrificing-super\n- ATO super insurance: https://www.ato.gov.au/individuals-and-families/super/in-detail/growing-your-super/super-and-insurance\n- ATO super co-contribution: https://www.ato.gov.au/individuals-and-families/super/growing-and-keeping-track-of-your-super/how-to-save-more-in-your-super/super-co-contribution\n- ATO foreign income: https://www.ato.gov.au/individuals-and-families/coming-to-australia-or-going-overseas/your-tax-residency\n- ATO MLS: https://www.ato.gov.au/individuals-and-families/medicare-and-private-health-insurance/medicare-levy-surcharge\n- PHI comparator: https://www.privatehealth.gov.au/\n- Services Australia income estimate: https://www.servicesaustralia.gov.au/income-estimate-for-family-assistance-and-child-care-subsidy-payments\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCONSOLIDATED OPPORTUNITY REQUIREMENTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nEvery benefit, deduction, super recommendation, and government payment goes into the SAME \"opportunities\" array. No separate sections. Each item must include:\n\n1. \"status\": \"new_opportunity\" | \"confirm_existing\" | \"optimise_existing\" â€” driven by CONSTRAINT 7\n2. \"applies_to\": Who specifically (e.g. \"Household\", \"Primary earner\", \"Secondary earner\")\n3. \"eligibility_reason\": Plain English why this household qualifies based on their data\n4. \"calculation_rows\": Array of {label, amount} showing line-by-line workings. Prefix additions with \"+ \" and deductions with \"â€“ \". The LAST row is the total â€” use bold-style labelling (e.g. \"Estimated annual FTB A\"). Example:\n   [\n     {\"label\": \"FTB A maximum rate (4 children Ã— $5,773.04)\", \"amount\": \"$23,092.16\"},\n     {\"label\": \"â€“ Income test reduction ($77,500 â€“ $65,189) Ã— 0.20 Ã— 4\", \"amount\": \"â€“$9,848.80\"},\n     {\"label\": \"Subtotal\", \"amount\": \"$13,243.36\"},\n     {\"label\": \"+ End-of-year supplement ($938.05 Ã— 4)\", \"amount\": \"$3,752.20\"},\n     {\"label\": \"Estimated annual FTB A\", \"amount\": \"$16,995\"}\n   ]\n5. \"related_benefits\": Array of strings explaining knock-on effects on OTHER opportunities. E.g. for salary sacrifice: [\"Reduces assessable income, which may increase FTB A by approximately $X\", \"Reduces assessable income, which may increase CCS subsidy percentage\"]. Empty array if none.\n6. \"information_needed\": What documents or information the user needs to gather before acting\n7. \"how_to_claim\": 3 key steps maximum. Concise, numbered. Link to full guide via url field.\n8. \"url\": Direct link to relevant portal (from URL list above)\n9. \"url_label\": Descriptive label (e.g. \"Check your FTB entitlement on Services Australia\", \"Claim WFH deductions via ATO myTax\")\n\nRISK FLAGS:\nKeep risk flags separate â€” compliance warnings and potential costs. Each risk flag must also include calculation_rows showing the potential cost, with + and â€“ prefixes.\n\nLIFESTYLE SCENARIOS:\nInclude practical trade-off analyses. ALSO include a \"scenario_table\" showing what happens if household income changes by Â±20%. The table should have columns for reduced income, current income, and increased income, with rows for: take-home pay (after tax), FTB A, FTB B, CCS value, other benefits, total deductions (tax saving), and a TOTAL row.\n\nCONSTRAINTS RECAP:\n- Rank opportunities by estimated_annual_value (highest first)\n- Use \"approximately\" qualifiers on all dollar figures\n- Consider benefit interactions (e.g. salary sacrifice reduces assessable income â†’ increases FTB/CCS)\n- If insufficient data, state what additional information would be needed\n- All monetary values as numbers in JSON (not strings), except in calculation_rows where formatted strings are fine\n- For deductions, show both the deduction amount AND the tax saving (deduction Ã— marginal rate)\n- APPLY ALL 9 CONSTRAINTS above\n\nOUTPUT JSON SCHEMA:\n{\n  \"opportunities\": [{\n    \"category\": \"government_benefit|tax_deduction|superannuation|investment|compliance\",\n    \"status\": \"new_opportunity|confirm_existing|optimise_existing\",\n    \"title\": \"string\",\n    \"applies_to\": \"string\",\n    \"eligibility_reason\": \"string\",\n    \"description\": \"string â€” 1-2 sentence overview\",\n    \"estimated_annual_value\": 0,\n    \"confidence\": \"high|medium|low\",\n    \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}],\n    \"related_benefits\": [\"string\"],\n    \"information_needed\": \"string\",\n    \"how_to_claim\": \"string â€” max 3 numbered steps\",\n    \"url\": \"string\",\n    \"url_label\": \"string â€” descriptive e.g. Check your FTB on Services Australia\",\n    \"affordability_warning\": \"string or null â€” only for salary sacrifice per CONSTRAINT 2\",\n    \"affordability_flag\": false\n  }],\n  \"risk_flags\": [{\n    \"type\": \"string\",\n    \"severity\": \"high|medium|low\",\n    \"description\": \"string\",\n    \"estimated_annual_cost\": 0,\n    \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}],\n    \"action\": \"string\",\n    \"url\": \"string\",\n    \"url_label\": \"string\"\n  }],\n  \"lifestyle_scenarios\": [{\n    \"title\": \"string\",\n    \"scenario\": \"string\",\n    \"option_a\": {\"label\": \"string\", \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}], \"total\": \"string\"},\n    \"option_b\": {\"label\": \"string\", \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}], \"total\": \"string\"},\n    \"bottom_line\": \"string\",\n    \"net_difference\": \"string\"\n  }],\n  \"scenario_table\": {\n    \"description\": \"Shows how a Â±20% change in household income affects take-home pay and benefits\",\n    \"columns\": [\n      {\"label\": \"â€“20% Income\", \"income\": 0},\n      {\"label\": \"Assumed Income\", \"income\": 0},\n      {\"label\": \"+20% Income\", \"income\": 0}\n    ],\n    \"rows\": [\n      {\"label\": \"Gross income\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"Tax payable\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"Take-home pay\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"FTB A\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"FTB B\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"CCS saving\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"Other benefits\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"Tax deduction savings\", \"values\": [\"string\", \"string\", \"string\"]},\n      {\"label\": \"Total household position\", \"values\": [\"string\", \"string\", \"string\"]}\n    ],\n    \"insight\": \"string\"\n  },\n  \"life_event_actions\": [{\"event\": \"string\", \"action\": \"string\", \"timing\": \"string\"}],\n  \"estimated_total_annual_savings\": 0,\n  \"total_new_opportunities\": 0,\n  \"total_confirm_existing\": 0,\n  \"meta\": {\n    \"confident\": true,\n    \"analysis_depth\": \"string\",\n    \"key_assumptions\": [],\n    \"limitations\": []\n  }\n}`;\n\nconst userContent = JSON.stringify({\n  classification: data.l1_classification,\n  form_data: data.redacted_payload,\n  analysis_depth: data.analysis_depth\n}, null, 2);\n\nreturn [{ json: {\n  model: lc.analysis_model,\n  max_tokens: lc.max_tokens_analysis,\n  temperature: lc.analysis_temperature,\n  system: systemPrompt,\n  messages: [\n    { role: \"user\", content: \"Provide detailed Australian tax analysis for FY2025-26 based on this data. Apply ALL 9 constraints. Use Australian English throughout:\\n\\n\" + userContent }\n  ]\n}}];"
      },
      "id": "b77841a3-c7ef-422e-b543-77d4280a31f1",
      "name": "E2 Build L2 Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1648,
        352
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.anthropic.com/v1/messages",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "anthropicApi",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "anthropic-version",
              "value": "2023-06-01"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $json.model, max_tokens: $json.max_tokens, temperature: $json.temperature, system: $json.system, messages: $json.messages }) }}",
        "options": {
          "timeout": 900000
        }
      },
      "id": "421af11a-9406-4d17-94de-40ac72fb3266",
      "name": "L2 Claude Deep Tax Analysis",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1840,
        352
      ],
      "credentials": {
        "anthropicApi": {
          "id": "sooFlPl5DGZ5qECx",
          "name": "Anthropic n8n Testing Key"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "02467e63-23ce-4871-9605-08f1097f8d42",
      "name": "U3 Merge L2 Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2032,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Parses L2 Claude analysis from merged HTTP response + N2 passthrough.\n * V3.1: 4 post-LLM validation guardrails (Issues 5,7,8,11).\n *   G1: Priority/confidence labels vs dollar impact\n *   G2: Title figure must match calculation total\n *   G3: Motor vehicle method must recommend higher value\n *   G4: Strip FTB B secondary earner rows for single parents\n * Handles: markdown code fences, truncated JSON (max_tokens), nested content.\n *\n * INPUTS\n * - $input: U3 Merge output (L2 Anthropic response + N2 passthrough)\n * - $('C1 Config'): config reference\n *\n * REMOVALS\n * - Raw Anthropic response fields replaced by structured l2_analysis\n *\n * ADDITIONS\n * - l2_analysis (object): parsed + guardrail-corrected analysis\n * - l2_usage (object): token counts\n * - guardrail_corrections (array): log of any corrections applied\n *\n * ROW GUIDE\n * Input:  { content: [{type:\"text\", text:\"...\"}], usage: {...}, l1_classification: {...}, ...passthrough }\n * Output: { l2_analysis: {...}, l2_usage: {...}, l1_classification: {...}, ...passthrough }\n *\n * ASSUMPTIONS\n * - Claude may wrap JSON in ```json fences despite prompt instruction\n * - Claude may hit max_tokens and truncate mid-JSON (stop_reason: \"max_tokens\")\n * - U3 Merge combines L2 HTTP (input 0) + N2 passthrough (input 1)\n * - L2 returns V3.1 schema with status, affordability_flag, total_new/confirm splits\n *\n * AUDIT\n * Hybrid: validates required keys + applies 4 guardrails.\n * Tracks all corrections for downstream visibility.\n */\nconst NODE = 'N3 Parse L2 & Build L3 Context';\nconst m = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst warnings = [];\nconst errors = [];\nconst corrections = [];\nconst runId = m.meta?.run_id || $execution.id || `${Date.now()}`;\n\n// --- Helpers ---\nfunction cleanLlmJson(raw) {\n  if (typeof raw !== 'string') return raw;\n  let s = raw.trim();\n  s = s.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?\\s*```\\s*$/i, '');\n  return s.trim();\n}\n\nfunction salvageTruncatedJson(raw) {\n  let s = raw;\n  const lastGoodComma = s.lastIndexOf('},');\n  const lastGoodBrace = s.lastIndexOf('}');\n  if (lastGoodComma > 0) {\n    s = s.substring(0, lastGoodComma + 1);\n  } else if (lastGoodBrace > 0) {\n    s = s.substring(0, lastGoodBrace + 1);\n  }\n  let openBraces = 0, openBrackets = 0;\n  for (const c of s) {\n    if (c === '{') openBraces++;\n    if (c === '}') openBraces--;\n    if (c === '[') openBrackets++;\n    if (c === ']') openBrackets--;\n  }\n  while (openBrackets > 0) { s += ']'; openBrackets--; }\n  while (openBraces > 0) { s += '}'; openBraces--; }\n  return JSON.parse(s);\n}\n\nfunction extractDollar(str) {\n  if (typeof str === 'number') return str;\n  if (typeof str !== 'string') return 0;\n  const match = str.replace(/,/g, '').match(/-?\\$?([\\d.]+)/);\n  return match ? parseFloat(match[1]) : 0;\n}\n\nfunction isSingleParent(payload) {\n  const rel = (payload?.relationship_status || payload?.relationship || '').toLowerCase();\n  const deps = parseInt(payload?.dependants || payload?.number_of_dependants || '0', 10);\n  return deps > 0 && ['widowed', 'separated', 'single'].includes(rel);\n}\n\n// --- Parse L2 ---\nlet l2 = null;\nconst l2Usage = m.usage || null;\nconst stopReason = m.stop_reason;\nconst isTruncated = stopReason === 'max_tokens';\nif (isTruncated) {\n  warnings.push('L2 truncated (max_tokens) â€” attempting partial salvage');\n}\n\ntry {\n  const raw = m.content?.[0]?.text;\n  if (!raw) throw new Error('No L2 content in content[0].text');\n  const cleaned = cleanLlmJson(raw);\n  try {\n    l2 = JSON.parse(cleaned);\n  } catch (parseErr) {\n    if (isTruncated) {\n      warnings.push('Clean parse failed â€” salvaging truncated JSON');\n      l2 = salvageTruncatedJson(cleaned);\n      warnings.push('Salvage succeeded â€” some sections may be incomplete');\n    } else {\n      throw parseErr;\n    }\n  }\n\n  // --- V3.1 schema validation ---\n  const criticalKeys = ['opportunities', 'risk_flags'];\n  criticalKeys.forEach(f => {\n    if (!l2[f]) warnings.push('L2 missing critical key: ' + f);\n  });\n\n  const importantKeys = ['lifestyle_scenarios', 'scenario_table', 'estimated_total_annual_savings'];\n  importantKeys.forEach(f => {\n    if (!l2[f]) warnings.push('L2 missing key: ' + f);\n  });\n\n  if (!l2.life_event_actions) warnings.push('L2 missing optional key: life_event_actions');\n  if (!l2.meta) warnings.push('L2 missing key: meta');\n\n  // Validate V3.1 status fields\n  if (Array.isArray(l2.opportunities)) {\n    const missingStatus = l2.opportunities.filter(o => !o.status);\n    if (missingStatus.length > 0) {\n      warnings.push(`${missingStatus.length} opportunities missing status field â€” defaulting to new_opportunity`);\n      missingStatus.forEach(o => { o.status = 'new_opportunity'; });\n    }\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // GUARDRAIL G1: Priority/confidence vs dollar impact\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  if (Array.isArray(l2.opportunities)) {\n    l2.opportunities.forEach(opp => {\n      const val = typeof opp.estimated_annual_value === 'number'\n        ? opp.estimated_annual_value\n        : extractDollar(opp.estimated_annual_value);\n      const before = opp.confidence;\n\n      if (val >= 1000 && opp.confidence !== 'high') {\n        opp.confidence = 'high';\n        corrections.push(`G1: ${opp.title} â€” confidence ${before}â†’high (value $${val} >= $1,000)`);\n      } else if (val < 200 && opp.confidence === 'high') {\n        opp.confidence = 'low';\n        corrections.push(`G1: ${opp.title} â€” confidence highâ†’low (value $${val} < $200)`);\n      } else if (val >= 200 && val < 1000 && opp.confidence !== 'medium') {\n        // Only correct if clearly wrong (high for small value or low for medium value)\n        if (opp.confidence === 'low' && val >= 200) {\n          opp.confidence = 'medium';\n          corrections.push(`G1: ${opp.title} â€” confidence lowâ†’medium (value $${val} in $200-$999 range)`);\n        }\n      }\n    });\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // GUARDRAIL G2: Title figure must match calc total\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  if (Array.isArray(l2.opportunities)) {\n    l2.opportunities.forEach(opp => {\n      if (!opp.calculation_rows || opp.calculation_rows.length === 0) return;\n      const lastRow = opp.calculation_rows[opp.calculation_rows.length - 1];\n      const calcTotal = extractDollar(lastRow.amount);\n      const titleVal = typeof opp.estimated_annual_value === 'number'\n        ? opp.estimated_annual_value\n        : extractDollar(opp.estimated_annual_value);\n\n      // Allow 5% tolerance for rounding\n      if (calcTotal > 0 && titleVal > 0) {\n        const diff = Math.abs(calcTotal - titleVal);\n        const tolerance = calcTotal * 0.05;\n        if (diff > tolerance && diff > 10) {\n          corrections.push(`G2: ${opp.title} â€” title $${titleVal} â‰  calc total $${calcTotal}, using calc total`);\n          opp.estimated_annual_value = calcTotal;\n        }\n      }\n    });\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // GUARDRAIL G3: Motor vehicle method selection\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  if (Array.isArray(l2.opportunities)) {\n    l2.opportunities.forEach(opp => {\n      const titleLower = (opp.title || '').toLowerCase();\n      if (!titleLower.includes('motor') && !titleLower.includes('vehicle') && !titleLower.includes('car')) return;\n      if (!opp.calculation_rows || opp.calculation_rows.length < 2) return;\n\n      let centsPerKm = 0;\n      let logbook = 0;\n      opp.calculation_rows.forEach(row => {\n        const label = (row.label || '').toLowerCase();\n        const amt = extractDollar(row.amount);\n        if (label.includes('cents') || label.includes('c/km') || label.includes('88c') || label.includes('per km')) {\n          centsPerKm = amt;\n        }\n        if (label.includes('logbook')) {\n          logbook = amt;\n        }\n      });\n\n      if (centsPerKm > 0 && logbook > 0) {\n        const descLower = (opp.description || '').toLowerCase();\n        const claimLower = (opp.how_to_claim || '').toLowerCase();\n        const recommendsLogbook = descLower.includes('logbook') || claimLower.includes('logbook');\n        const recommendsCpk = descLower.includes('cents per') || claimLower.includes('cents per');\n\n        if (centsPerKm > logbook && recommendsLogbook && !recommendsCpk) {\n          corrections.push(`G3: Motor vehicle â€” logbook $${logbook} < cents/km $${centsPerKm}, but logbook was recommended. Flagging.`);\n          warnings.push(`Motor vehicle recommendation may be suboptimal: cents/km ($${centsPerKm}) > logbook ($${logbook})`);\n        } else if (logbook > centsPerKm && recommendsCpk && !recommendsLogbook) {\n          corrections.push(`G3: Motor vehicle â€” cents/km $${centsPerKm} < logbook $${logbook}, but cents/km was recommended. Flagging.`);\n          warnings.push(`Motor vehicle recommendation may be suboptimal: logbook ($${logbook}) > cents/km ($${centsPerKm})`);\n        }\n      }\n    });\n  }\n\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  // GUARDRAIL G4: Strip FTB B secondary earner rows for single parents\n  // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n  const singleParent = isSingleParent(m.redacted_payload);\n  if (singleParent && Array.isArray(l2.opportunities)) {\n    l2.opportunities.forEach(opp => {\n      const titleLower = (opp.title || '').toLowerCase();\n      if (!titleLower.includes('ftb b') && !titleLower.includes('family tax benefit part b')) return;\n\n      if (opp.calculation_rows) {\n        const before = opp.calculation_rows.length;\n        opp.calculation_rows = opp.calculation_rows.filter(row => {\n          const label = (row.label || '').toLowerCase();\n          return !label.includes('secondary earner') && !label.includes('second earner');\n        });\n        const removed = before - opp.calculation_rows.length;\n        if (removed > 0) {\n          corrections.push(`G4: FTB B â€” removed ${removed} secondary earner rows (single parent household)`);\n        }\n      }\n\n      // Also clean description\n      if (opp.eligibility_reason) {\n        opp.eligibility_reason = opp.eligibility_reason\n          .replace(/secondary earner income test[^.]*\\./gi, '')\n          .replace(/\\s{2,}/g, ' ')\n          .trim();\n      }\n    });\n  }\n\n  // --- Validate opportunities quality ---\n  if (Array.isArray(l2.opportunities)) {\n    const missingCalcRows = l2.opportunities.filter(o => !o.calculation_rows || o.calculation_rows.length === 0);\n    if (missingCalcRows.length > 0) {\n      warnings.push(`${missingCalcRows.length} opportunities missing calculation_rows`);\n    }\n  }\n\n} catch (e) {\n  errors.push('L2 parse failed: ' + e.message);\n  l2 = { error: e.message };\n}\n\nreturn [{ json: {\n  l2_analysis: l2,\n  l2_usage: l2Usage,\n  l1_classification: m.l1_classification,\n  l1_usage: m.l1_usage,\n  trigger: m.trigger,\n  redacted_payload: m.redacted_payload,\n  original_contact: m.original_contact,\n  pii_map: m.pii_map,\n  analysis_depth: m.analysis_depth,\n  existing_benefits: m.existing_benefits || '',\n  guardrail_corrections: corrections,\n  __audit: {\n    node: NODE,\n    ts: new Date().toISOString(),\n    truncation_detected: isTruncated,\n    guardrails_applied: corrections.length,\n    warnings,\n    errors\n  },\n  meta: {\n    run_id: runId,\n    correlation_id: runId,\n    valid: errors.length === 0,\n    form_type: m.analysis_depth || 'quick_snapshot',\n    l2_model: config.llm_config.analysis_model,\n    l2_input_tokens: l2Usage?.input_tokens || 0,\n    l2_output_tokens: l2Usage?.output_tokens || 0,\n    l2_truncated: isTruncated,\n    opportunity_count: Array.isArray(l2?.opportunities) ? l2.opportunities.length : 0,\n    risk_flag_count: Array.isArray(l2?.risk_flags) ? l2.risk_flags.length : 0,\n    estimated_total: l2?.estimated_total_annual_savings || null,\n    guardrail_corrections_count: corrections.length,\n    warnings,\n    errors\n  }\n}}];"
      },
      "id": "053e6691-2a29-4af5-a226-e2691033294f",
      "name": "N3 Parse L2 & Build L3 Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2240,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Builds OpenAI API request for L3 narrative report.\n * V3.1: 4 new constraints addressing Issues 2,3,10,14.\n *       Consolidated structure â€” single opportunities list with confirm/new split,\n *       scenario table, acronym expansion, \"Example\" language, concise how-to-claim.\n *\n * INPUTS\n * - $input: N3 output (l2_analysis + l1_classification + passthrough)\n * - $('C1 Config'): config reference (llm_config)\n *\n * REMOVALS - None\n * ADDITIONS - OpenAI messages array with updated system prompt\n *\n * ROW GUIDE\n * Input:  { l2_analysis: {...}, l1_classification: {...}, analysis_depth: \"...\", ...passthrough }\n * Output: { model, temperature, max_tokens, response_format, messages: [...] }\n *\n * ASSUMPTIONS\n * - N3 passes validated l2_analysis with status fields and guardrail-corrected values\n * - L2 opportunities already have status: new_opportunity | confirm_existing | optimise_existing\n * - L2 provides total_new_opportunities and total_confirm_existing sums\n *\n * AUDIT\n * Lightweight build step.\n */\nconst NODE = 'E3 Build L3 Request';\nconst data = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst lc = config.llm_config;\n\nconst systemPrompt = `ROLE: Warm, professional financial content writer for an Australian audience. You write in Australian English (analyse, maximise, optimise, recognise, colour, defence, centre, labour, favour, organisation, etc.). Never use American spellings.\n\nGOAL: Transform the L2 analysis into a clear report with TWO tiers of opportunities: \"New Optimisation Opportunities\" (the hero section) and \"Benefits Health Check\" (confirm existing). The KEY DESIGN PRINCIPLE: no duplication, every item appears ONCE.\n\nReturn ONLY valid JSON. No markdown, no code fences, no explanations outside the JSON.\n\nLEGAL: This is general information only. Use \"based on the information provided\", \"you may be eligible\", \"consider discussing with your tax agent\". Never use \"you should\" or \"you must\".\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nMANDATORY CONSTRAINTS\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\nCONSTRAINT A â€” SPLIT HEADLINE SAVINGS (Issue 2 â€” Critical):\nThe report MUST split the savings figure into two categories:\n1. \"New Optimisation Opportunities\" â€” strategies NOT yet implemented. This total is the HERO figure.\n2. \"Benefits Health Check\" â€” entitlements the user likely already claims. These appear in a separate confirm section.\nUse the L2 status field to determine placement:\n- status: \"new_opportunity\" â†’ new_opportunities section (hero total)\n- status: \"confirm_existing\" â†’ confirm_existing section (secondary callout)\n- status: \"optimise_existing\" â†’ new_opportunities section (only the INCREMENTAL value in hero total)\nThe hero banner shows ONLY total_new_opportunities. The confirm total appears as a secondary line below.\nIf ALL items are \"new_opportunity\" (user didn't indicate existing benefits), show a single combined total with a note: \"If you're already receiving some of these benefits, your additional savings may be lower.\"\n\nCONSTRAINT B â€” \"EXAMPLE\" NOT \"CURRENT\" (Issue 3 â€” High):\nNEVER use the word \"Current\" when presenting calculated figures based on user-selected income ranges. Instead:\n- \"Based on an assumed income of $X from your selected rangeâ€¦\"\n- \"Example scenario\" not \"Current Arrangement\"\n- \"Estimated\" or \"Indicative\" not \"Your\" when paired with specific dollar amounts\n- \"Assumed assessable income\" not \"Current estimated assessable income\"\nException: \"current\" is acceptable in non-financial contexts like \"your current state of residence\".\n\nCONSTRAINT C â€” ACRONYM EXPANSION (Issue 10 â€” Medium):\nEvery acronym MUST be spelled out in full on FIRST USE in the report, then abbreviated thereafter:\n- \"Family Tax Benefit Part A (FTB A)\" â†’ then \"FTB A\"\n- \"Child Care Subsidy (CCS)\"\n- \"Medicare Levy Surcharge (MLS)\"\n- \"Low Income Tax Offset (LITO)\"\n- \"Capital Gains Tax (CGT)\"\n- \"Deductible Gift Recipient (DGR)\"\n- \"First Home Super Saver (FHSS)\"\n- \"Superannuation Guarantee (SG)\"\n- \"Outside School Hours Care (OSHC)\"\n- \"Private Health Insurance (PHI)\"\nNever assume the reader knows tax acronyms. Year 10 reading level.\n\nCONSTRAINT D â€” CONCISE HOW-TO-CLAIM (Issue 14 â€” Low):\n\"how_to_claim\" sections MUST be limited to 3 key steps maximum per opportunity.\nDo NOT include 7â€“9 step instructions. Keep it actionable and concise, with a link via url/url_label for full details.\nExample: \"1. Log in to myGov â†’ Services Australia  2. Complete the FTB assessment  3. Have your income estimate and children's details ready\"\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nCONTENT RULES\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. PRESERVE ALL calculation_rows arrays exactly as provided by L2. These render as clean tables in the email â€” do not convert them to paragraphs.\n2. PRESERVE ALL URLs and url_labels from L2.\n3. PRESERVE ALL related_benefits arrays â€” these show how opportunities connect.\n4. Keep language plain enough for someone with no accounting background.\n5. Dollar figures: use \"approximately\" and format as \"$X,XXX\".\n6. For the scenario_table, preserve the full table structure exactly.\n7. Each opportunity must be FULLY SELF-CONTAINED.\n8. PRESERVE the status field from L2 â€” it drives the confirm/new split in the email.\n9. PRESERVE affordability_warning and affordability_flag from L2 salary sacrifice items.\n\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\nSECTIONS (6 total)\nâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n1. your_snapshot â€” 2â€“3 sentence summary. State the NEW OPPORTUNITIES total as the headline figure. If there are confirm_existing items, add: \"We've also included a benefits health check worth approximately $X to confirm you're receiving everything you're entitled to.\" Warm, encouraging tone.\n\n2. tax_position â€” Their tax bracket, effective rate, and key thresholds explained simply. Mention LITO if applicable. Use \"assumed income\" language per Constraint B.\n\n3. new_opportunities â€” Opportunities with status \"new_opportunity\" or \"optimise_existing\". Ranked by estimated_annual_value highest first. Each item MUST include all L2 fields: title, category, status, applies_to, eligibility_reason, description, estimated_annual_value, confidence, calculation_rows, related_benefits, information_needed, how_to_claim (max 3 steps per Constraint D), url, url_label, affordability_warning, affordability_flag. Rewrite descriptions and eligibility_reason in warmer plain English but do NOT remove any data.\n\n4. confirm_existing â€” Opportunities with status \"confirm_existing\". Rendered with a different visual style (\"âœ“ Confirm You're Receiving\"). Focus on: are they getting the maximum? How to check? Include calculation_rows so users can verify their entitlement.\n\n5. risk_alerts â€” Compliance warnings and potential costs. Preserve calculation_rows, action, url, url_label.\n\n6. lifestyle_scenarios â€” Practical trade-off comparisons (preserve option_a, option_b, bottom_line structure). PLUS the scenario_table showing Â±20% income impact. Use \"Assumed Income\" as the middle column header, NOT \"Current Income\" (Constraint B).\n\nDO NOT INCLUDE separate sections for:\n- Government benefits (folded into new_opportunities or confirm_existing)\n- Super health check (folded into new_opportunities)\n- Next steps (each opportunity already has how_to_claim)\n- Deduction analysis (folded into new_opportunities)\n\nOUTPUT JSON SCHEMA:\n{\n  \"sections\": {\n    \"your_snapshot\": {\n      \"title\": \"Your Family Snapshot\",\n      \"content\": \"string\"\n    },\n    \"tax_position\": {\n      \"title\": \"Your Tax Position\",\n      \"content\": \"string\"\n    },\n    \"new_opportunities\": {\n      \"title\": \"New Optimisation Opportunities\",\n      \"items\": [{\n        \"title\": \"string â€” with full acronym expansion on first use\",\n        \"category\": \"government_benefit|tax_deduction|superannuation|investment|compliance\",\n        \"status\": \"new_opportunity|optimise_existing\",\n        \"applies_to\": \"string\",\n        \"eligibility_reason\": \"string â€” warm plain English\",\n        \"description\": \"string\",\n        \"estimated_annual_value\": \"string â€” e.g. $4,308/yr\",\n        \"confidence\": \"high|medium|low\",\n        \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}],\n        \"related_benefits\": [\"string\"],\n        \"information_needed\": \"string\",\n        \"how_to_claim\": \"string â€” max 3 numbered steps\",\n        \"url\": \"string\",\n        \"url_label\": \"string â€” descriptive\",\n        \"affordability_warning\": \"string or null\",\n        \"affordability_flag\": false\n      }]\n    },\n    \"confirm_existing\": {\n      \"title\": \"Benefits Health Check\",\n      \"subtitle\": \"Confirm you're receiving these entitlements\",\n      \"items\": [{\n        \"title\": \"string\",\n        \"category\": \"government_benefit\",\n        \"status\": \"confirm_existing\",\n        \"applies_to\": \"string\",\n        \"eligibility_reason\": \"string\",\n        \"description\": \"string â€” focus on confirming maximum amount\",\n        \"estimated_annual_value\": \"string\",\n        \"confidence\": \"high|medium|low\",\n        \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}],\n        \"information_needed\": \"string\",\n        \"how_to_claim\": \"string â€” max 3 steps\",\n        \"url\": \"string\",\n        \"url_label\": \"string\"\n      }]\n    },\n    \"risk_alerts\": {\n      \"title\": \"Risk Alerts\",\n      \"items\": [{\n        \"alert\": \"string\",\n        \"severity\": \"high|medium|low\",\n        \"description\": \"string\",\n        \"estimated_cost\": \"string\",\n        \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}],\n        \"action\": \"string\",\n        \"url\": \"string\",\n        \"url_label\": \"string\"\n      }]\n    },\n    \"lifestyle_scenarios\": {\n      \"title\": \"What Would This Look Like for Your Family?\",\n      \"content\": \"string â€” intro sentence\",\n      \"items\": [{\n        \"title\": \"string\",\n        \"scenario\": \"string\",\n        \"option_a\": {\"label\": \"string\", \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}], \"total\": \"string\"},\n        \"option_b\": {\"label\": \"string\", \"calculation_rows\": [{\"label\": \"string\", \"amount\": \"string\"}], \"total\": \"string\"},\n        \"bottom_line\": \"string\",\n        \"net_difference\": \"string\"\n      }],\n      \"scenario_table\": {\n        \"description\": \"string\",\n        \"columns\": [{\"label\": \"string\", \"income\": \"string\"}],\n        \"rows\": [{\"label\": \"string\", \"values\": [\"string\", \"string\", \"string\"]}],\n        \"insight\": \"string\"\n      }\n    }\n  },\n  \"total_new_opportunities\": 0,\n  \"total_confirm_existing\": 0,\n  \"estimated_total_savings\": 0,\n  \"meta\": {\n    \"confident\": true,\n    \"tone_check\": \"professional_friendly_australian\",\n    \"disclaimer_included\": true,\n    \"acronyms_expanded\": true\n  }\n}`;\n\nconst userContent = JSON.stringify({\n  analysis: data.l2_analysis,\n  classification: data.l1_classification,\n  analysis_depth: data.analysis_depth\n}, null, 2);\n\nreturn [{ json: {\n  model: lc.narrative_model,\n  temperature: lc.creative_temperature,\n  max_tokens: lc.max_tokens_narrative,\n  response_format: { type: \"json_object\" },\n  messages: [\n    { role: \"system\", content: systemPrompt },\n    { role: \"user\", content: \"Convert this tax analysis into a warm, consolidated report using Australian English. Split opportunities into NEW vs CONFIRM based on status field. Apply all 4 constraints (headline split, Example language, acronym expansion, concise how-to-claim). Preserve all calculation_rows, URLs, related_benefits, and affordability fields exactly:\\n\\n\" + userContent }\n  ]\n}}];"
      },
      "id": "f79a15ae-ed82-42be-9e7f-fa352610ecd8",
      "name": "E3 Build L3 Request",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2416,
        352
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.openai.com/v1/chat/completions",
        "authentication": "predefinedCredentialType",
        "nodeCredentialType": "openAiApi",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ model: $json.model, messages: $json.messages, temperature: $json.temperature, max_tokens: $json.max_tokens, response_format: $json.response_format }) }}",
        "options": {
          "timeout": 600000
        }
      },
      "id": "299ee704-0cda-45db-b804-73e11125beaa",
      "name": "L3 GPT Generate Report Narrative",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2624,
        352
      ],
      "credentials": {
        "openAiApi": {
          "id": "ZfJnrcuhjWgP2JYI",
          "name": "n8n Workflows"
        }
      }
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "id": "5fec32a7-14c9-4bec-b7e1-f0995150a4fd",
      "name": "U4 Merge L3 Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.1,
      "position": [
        2816,
        224
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "loose",
            "version": 2
          },
          "conditions": [
            {
              "id": "1fce17c2-9b6a-4146-904c-e1fbd513a48e",
              "leftValue": "={{ $json.meta.valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "looseTypeValidation": true,
        "options": {}
      },
      "id": "59fdd840-350b-4166-a83c-e72ff2930bf2",
      "name": "R3 Route By Report Completeness",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3200,
        224
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.dlq_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.dlq_sheet_name }}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ts": "={{ $now.toISO() }}",
            "run_id": "={{ $json.meta.run_id }}",
            "first_name": "={{ $json.original_contact.first_name }}",
            "email": "={{ $json.original_contact.email }}",
            "node": "N1 Normalise Report Structure",
            "form_type": "={{ $json.meta.form_type }}",
            "workflow_name": "Family Tax Advisor",
            "errors": "={{ $json.meta.errors.join('; ') }}",
            "warnings": "={{ $json.meta.warnings.join('; ') }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "ts",
              "displayName": "ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "run_id",
              "displayName": "run_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "workflow_name",
              "displayName": "workflow_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "node",
              "displayName": "node",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "errors",
              "displayName": "errors",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "warnings",
              "displayName": "warnings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "raw_field_count",
              "displayName": "raw_field_count",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "form_type",
              "displayName": "form_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "e00d6d0d-6372-42d1-a79f-d3dfe30bb98f",
      "name": "S2 DLQ Report Error",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        3392,
        336
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "abKeADxb1EcKR29m",
          "name": "Google Sheets (Lyros) - 18/11/25 10:30am"
        }
      }
    },
    {
      "parameters": {
        "toRecipients": "={{ $('C1 Config').item.json.email_config.admin_email }}",
        "subject": "=ğŸš¨ Family Tax Advisor â€” Report Failed | {{ $json.meta.run_id }}",
        "additionalFields": {
          "from": "automations@lyros.com.au"
        }
      },
      "id": "e4c37ae3-2f5c-4a9a-8e1b-ea210d996819",
      "name": "X2 Alert Chris Report Error",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        3584,
        336
      ],
      "webhookId": "2659b119-cda4-4175-9175-0bb2c061fb35",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "rniSgnqyp5rv9Xf9",
          "name": "Outlook (Lyros) - n8n OAuth (Exp 31/7/2026)"
        }
      }
    },
    {
      "parameters": {
        "content": "## ğŸ§  Phase 2: LLM Pipeline\n\n**3-Pass Strategy:**\n1. L1 GPT-4o-mini (0.2) â€” Classify eligibility\n2. L2 Claude Sonnet 4.5 (0.4) â€” Deep analysis\n3. L3 GPT-4o-mini (0.7) â€” Report narrative\n\n**Split-Merge:** Each HTTP call uses a Merge node to preserve passthrough data.\n\n**Setup:**\n1. OpenAI API credential â†’ L1, L3\n2. Anthropic API credential â†’ L2\n3. Google Sheets credential â†’ S2",
        "height": 320,
        "width": 420,
        "color": 5
      },
      "id": "20c675b5-cbdb-4ef0-983d-bf6c0318eff5",
      "name": "Sticky Note3",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        720,
        -208
      ]
    },
    {
      "parameters": {
        "workflowId": {
          "__rl": true,
          "mode": "id",
          "value": "wI8vl0LPoIbvdaVd"
        },
        "workflowInputs": {
          "mappingMode": "defineBelow",
          "value": {
            "execution_id": "={{ $json.execution_id }}",
            "workflow_name": "={{ $json.workflow_name }}",
            "workflow_id": "={{ $json.workflow_id }}",
            "model": "={{ $json.model }}",
            "provider": "={{ $json.provider }}",
            "pricing_type": "={{ $json.pricing_type }}",
            "input_tokens": "={{ $json.input_tokens }}",
            "output_tokens": "={{ $json.output_tokens }}",
            "total_tokens": "={{ $json.total_tokens }}",
            "usage_quantity": "={{ $json.usage_quantity }}",
            "_sample_data_id": "={{ $json._sample_data_id }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "execution_id",
              "displayName": "execution_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "workflow_name",
              "displayName": "workflow_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "workflow_id",
              "displayName": "workflow_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "model",
              "displayName": "model",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "provider",
              "displayName": "provider",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "pricing_type",
              "displayName": "pricing_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "_sample_data_id",
              "displayName": "_sample_data_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "string",
              "removed": false
            },
            {
              "id": "usage_quantity",
              "displayName": "usage_quantity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "input_tokens",
              "displayName": "input_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "output_tokens",
              "displayName": "output_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            },
            {
              "id": "total_tokens",
              "displayName": "total_tokens",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "canBeUsedToMatch": true,
              "type": "number",
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": true
        },
        "options": {
          "waitForSubWorkflow": false
        }
      },
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.3,
      "position": [
        4432,
        128
      ],
      "id": "850c8f08-d815-4b5f-807e-64e902408c40",
      "name": "$ Execute Sub",
      "retryOnFail": true,
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## Workflow Cost Tracker",
        "height": 224,
        "width": 432,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        4192,
        80
      ],
      "typeVersion": 1,
      "id": "eda0d3ae-8398-4826-b622-c312961e999a",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Normalises all 3 LLM outputs into unified report schema.\n * V3.1: Splits opportunities into confirm_existing[] vs new_opportunities[],\n *       calculates two separate totals (hero = new only), adds affordability_flag\n *       to salary sacrifice items, and validates acronym expansion.\n * Assembles final deliverable for P5 email render.\n *\n * INPUTS\n * - $input: U4 Merge output (L3 response + N3 passthrough with l1/l2)\n * - $('C1 Config'): config reference\n *\n * REMOVALS\n * - Raw OpenAI L3 response fields replaced by unified report\n *\n * ADDITIONS\n * - report (object): unified report with sections, classification, detailed_analysis\n * - report.confirm_existing (array): benefits user likely already receives\n * - report.new_opportunities (array): genuinely new optimisation strategies\n * - report.total_new_opportunities (number): hero figure\n * - report.total_confirm_existing (number): secondary callout figure\n * - report_meta (object): completion status, section counts, key metrics\n * - token_usage (object): l1/l2/l3 token counts for cost tracking\n *\n * ROW GUIDE\n * Input:  { choices: [...], usage: {...}, l1_classification: {...}, l2_analysis: {...}, ...passthrough }\n * Output: { report: {...}, report_meta: {...}, token_usage: {...}, original_contact: {...} }\n *\n * ASSUMPTIONS\n * - L3 GPT json_object mode returns clean JSON; defend against fences\n * - L3 sections follow V3.1 schema: your_snapshot, tax_position, new_opportunities,\n *   confirm_existing, risk_alerts, lifestyle_scenarios\n * - OR L3 may return single \"opportunities\" section with status field per item (fallback)\n * - L2 may have been salvaged from truncation (check meta.l2_truncated)\n * - isComplete = all 3 LLMs succeeded AND <=1 section missing from expected set\n *\n * AUDIT\n * Hybrid: validates all 3 LLM outputs present, splits confirm/new, checks affordability,\n * validates acronym expansion. meta.valid=false if any LLM failed or >1 section missing â†’ R3 â†’ DLQ.\n */\nconst NODE = 'N4 Normalise Report Structure';\nconst m = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst runId = m.meta?.run_id || $execution.id || `${Date.now()}`;\nconst warnings = [];\nconst errors = [];\n\n// === HELPERS ===\n\nfunction cleanLlmJson(raw) {\n  if (typeof raw !== 'string') return raw;\n  let s = raw.trim();\n  s = s.replace(/^```(?:json)?\\s*\\n?/i, '').replace(/\\n?\\s*```\\s*$/i, '');\n  return s.trim();\n}\n\nfunction extractDollar(str) {\n  if (typeof str === 'number') return str;\n  if (typeof str !== 'string') return 0;\n  const match = str.replace(/,/g, '').match(/-?\\$?([\\d.]+)/);\n  return match ? parseFloat(match[1]) : 0;\n}\n\nfunction estimateFortnightlyIncome(payload) {\n  const midpoints = {\n    under_45k: 32000, '45k_65k': 55000, '65k_90k': 77500,\n    '90k_120k': 105000, '120k_180k': 150000, '180k_250k': 215000, '250k_plus': 300000\n  };\n  const band = payload?.household_income || payload?.income_band || '';\n  const annual = midpoints[band] || 77500;\n  return annual / 26; // fortnightly\n}\n\n// === PARSE L3 ===\nlet l3 = null, l3Usage = null;\nconst l3StopReason = m.choices?.[0]?.finish_reason;\nif (l3StopReason === 'length') warnings.push('L3 truncated (max_tokens)');\n\ntry {\n  const raw = m.choices?.[0]?.message?.content;\n  if (!raw) throw new Error('No L3 content in choices[0].message.content');\n  const cleaned = cleanLlmJson(raw);\n  l3 = typeof cleaned === 'object' ? cleaned : JSON.parse(cleaned);\n  l3Usage = m.usage || null;\n} catch (e) {\n  errors.push('L3 parse failed: ' + e.message);\n  l3 = { error: e.message };\n}\n\n// === GATHER UPSTREAM ===\nconst l1 = m.l1_classification || {};\nconst l2 = m.l2_analysis || {};\nconst l2Truncated = m.meta?.l2_truncated || false;\n\n// === V3.1 SECTION VALIDATION ===\n// L3 may output either V3.1 schema (new_opportunities + confirm_existing)\n// or V3 schema (single opportunities) â€” handle both\nconst sections = l3?.sections || {};\nconst sectionKeys = Object.keys(sections);\n\n// Core expected sections (V3.1)\nconst coreExpected = ['your_snapshot', 'tax_position', 'risk_alerts', 'lifestyle_scenarios'];\n// Opportunity sections â€” either split (V3.1) or single (V3 fallback)\nconst hasSplitOpps = sectionKeys.includes('new_opportunities') || sectionKeys.includes('confirm_existing');\nconst hasSingleOpps = sectionKeys.includes('opportunities');\n\nconst coreMissing = coreExpected.filter(s => !sectionKeys.includes(s));\nif (coreMissing.length > 0) warnings.push('Missing report sections: ' + coreMissing.join(', '));\nif (!hasSplitOpps && !hasSingleOpps) warnings.push('Missing: no opportunities section found');\n\n// Warn on legacy V2 sections\nconst legacySections = ['government_benefits', 'super_health_check', 'next_steps'];\nconst unexpectedLegacy = legacySections.filter(s => sectionKeys.includes(s));\nif (unexpectedLegacy.length > 0) {\n  warnings.push('Unexpected legacy V2 sections found: ' + unexpectedLegacy.join(', '));\n}\n\n// === LLM VALIDATION ===\nconst hasL1 = l1 && !l1.error;\nconst hasL2 = l2 && !l2.error && (l2.opportunities || l2.risk_flags);\nconst hasL3 = l3 && !l3.error && l3.sections;\n\n// Allow 1 missing core section (lifestyle_scenarios nice-to-have)\nconst effectiveMissing = coreMissing.filter(s => s !== 'lifestyle_scenarios');\nconst isComplete = hasL1 && hasL2 && hasL3 && effectiveMissing.length === 0;\n\nif (!hasL1) errors.push('L1 classification failed');\nif (!hasL2) errors.push('L2 analysis failed');\nif (!hasL3) errors.push('L3 narrative failed');\nif (l2Truncated && hasL2) warnings.push('L2 was truncated but salvaged â€” some analysis may be incomplete');\n\n// === SPLIT OPPORTUNITIES INTO CONFIRM vs NEW ===\nlet newOpportunities = [];\nlet confirmExisting = [];\n\nif (hasSplitOpps) {\n  // V3.1: L3 already split them\n  newOpportunities = sections.new_opportunities?.items || [];\n  confirmExisting = sections.confirm_existing?.items || [];\n} else if (hasSingleOpps && sections.opportunities?.items) {\n  // V3 fallback: single list â€” split by status field\n  sections.opportunities.items.forEach(item => {\n    if (item.status === 'confirm_existing') {\n      confirmExisting.push(item);\n    } else {\n      // new_opportunity, optimise_existing, or missing status all go to new\n      newOpportunities.push(item);\n    }\n  });\n  warnings.push('L3 returned single opportunities section â€” split by status field in N4');\n}\n\n// === CALCULATE TWO SEPARATE TOTALS ===\nconst totalNew = newOpportunities.reduce((sum, o) => {\n  return sum + extractDollar(o.estimated_annual_value);\n}, 0);\n\nconst totalConfirm = confirmExisting.reduce((sum, o) => {\n  return sum + extractDollar(o.estimated_annual_value);\n}, 0);\n\n// Use L2/L3 totals as fallback if available\nconst totalNewFinal = totalNew || l2.total_new_opportunities || l3?.total_new_opportunities || 0;\nconst totalConfirmFinal = totalConfirm || l2.total_confirm_existing || l3?.total_confirm_existing || 0;\nconst estimatedTotal = totalNewFinal + totalConfirmFinal;\n\n// === AFFORDABILITY FLAG FOR SALARY SACRIFICE ===\nconst fortnightlyIncome = estimateFortnightlyIncome(m.redacted_payload);\nconst allOpps = [...newOpportunities, ...confirmExisting];\nallOpps.forEach(opp => {\n  const titleLower = (opp.title || '').toLowerCase();\n  if (!titleLower.includes('salary sacrifice') && !titleLower.includes('salary sacrific')) return;\n\n  // Check if L2 already set affordability_flag\n  if (opp.affordability_flag === true) return;\n\n  // Try to extract fortnightly reduction from affordability_warning or calculation_rows\n  let fortnightlyReduction = 0;\n  if (opp.affordability_warning) {\n    const match = opp.affordability_warning.replace(/,/g, '').match(/\\$(\\d+(?:\\.\\d+)?)/);\n    if (match) fortnightlyReduction = parseFloat(match[1]);\n  }\n  if (!fortnightlyReduction && opp.calculation_rows) {\n    opp.calculation_rows.forEach(row => {\n      const label = (row.label || '').toLowerCase();\n      if (label.includes('fortnightly') && label.includes('reduction')) {\n        fortnightlyReduction = extractDollar(row.amount);\n      }\n    });\n  }\n  // Estimate: annual sacrifice / 26\n  if (!fortnightlyReduction) {\n    const annualVal = extractDollar(opp.estimated_annual_value);\n    // Rough: the sacrifice amount is typically 2-3x the benefit value\n    // Use a conservative estimate from the annual value\n    fortnightlyReduction = (annualVal * 2.5) / 26;\n  }\n\n  if (fortnightlyReduction > 0 && fortnightlyIncome > 0) {\n    const threshold = fortnightlyIncome * 0.10;\n    if (fortnightlyReduction > threshold) {\n      opp.affordability_flag = true;\n      if (!opp.affordability_warning) {\n        opp.affordability_warning = `This strategy may reduce your fortnightly take-home pay by approximately $${Math.round(fortnightlyReduction)}. Super contributions generally cannot be accessed until age 60. Consider whether your household budget can absorb this reduction.`;\n      }\n      warnings.push(`Affordability flag set on salary sacrifice: $${Math.round(fortnightlyReduction)}/fn > 10% of $${Math.round(fortnightlyIncome)}/fn`);\n    }\n  }\n});\n\n// === ACRONYM EXPANSION CHECK ===\nconst acronymPatterns = [\n  { pattern: /\\bFTB\\b(?!\\s*[A-B]?\\s*\\()/, expanded: 'Family Tax Benefit' },\n  { pattern: /\\bCCS\\b(?!\\s*\\()/, expanded: 'Child Care Subsidy' },\n  { pattern: /\\bMLS\\b(?!\\s*\\()/, expanded: 'Medicare Levy Surcharge' },\n  { pattern: /\\bLITO\\b(?!\\s*\\()/, expanded: 'Low Income Tax Offset' },\n  { pattern: /\\bCGT\\b(?!\\s*\\()/, expanded: 'Capital Gains Tax' },\n  { pattern: /\\bDGR\\b(?!\\s*\\()/, expanded: 'Deductible Gift Recipient' },\n  { pattern: /\\bFHSS\\b(?!\\s*\\()/, expanded: 'First Home Super Saver' },\n  { pattern: /\\bOSHC\\b(?!\\s*\\()/, expanded: 'Outside School Hours Care' },\n  { pattern: /\\bPHI\\b(?!\\s*\\()/, expanded: 'Private Health Insurance' },\n  { pattern: /\\bSG\\b(?!\\s*\\()/, expanded: 'Superannuation Guarantee' },\n];\n\n// Check snapshot and tax position content (where first-use acronyms typically appear)\nconst textToCheck = [\n  sections.your_snapshot?.content || '',\n  sections.tax_position?.content || ''\n].join(' ');\n\nconst unexpandedAcronyms = [];\nacronymPatterns.forEach(({ pattern, expanded }) => {\n  if (pattern.test(textToCheck)) {\n    // Check if the expanded form appears before the acronym\n    const fullText = textToCheck;\n    if (!fullText.includes(expanded)) {\n      unexpandedAcronyms.push(expanded.split(' ').map(w => w[0]).join(''));\n    }\n  }\n});\n\nif (unexpandedAcronyms.length > 0) {\n  warnings.push(`Potentially unexpanded acronyms in snapshot/tax_position: ${unexpandedAcronyms.join(', ')}`);\n}\n\n// === VALIDATE KEY SECTION CONTENT ===\nif (hasL3) {\n  if (newOpportunities.length === 0 && confirmExisting.length === 0) {\n    warnings.push('No opportunities found in either new or confirm arrays');\n  }\n  if (!sections.risk_alerts?.items || sections.risk_alerts.items.length === 0) {\n    warnings.push('L3 risk_alerts section has no items');\n  }\n  if (sections.lifestyle_scenarios && !sections.lifestyle_scenarios.items) {\n    warnings.push('L3 lifestyle_scenarios section has no items');\n  }\n  if (sections.lifestyle_scenarios && !sections.lifestyle_scenarios.scenario_table) {\n    warnings.push('L3 lifestyle_scenarios missing scenario_table');\n  }\n}\n\n// === MLS DETECTION ===\nconst mlsAtRisk = l1.mls?.at_risk\n  || (Array.isArray(l2.risk_flags) && l2.risk_flags.some(f =>\n    (f.type || '').toLowerCase().includes('medicare')\n    || (f.type || '').toLowerCase().includes('mls')\n  ))\n  || false;\n\n// === TOP OPPORTUNITY ===\nconst topOpportunity = newOpportunities.length > 0\n  ? newOpportunities[0].title\n  : (Array.isArray(l2.opportunities) && l2.opportunities.length > 0\n    ? l2.opportunities[0].title\n    : null);\n\n// === BUILD REPORT ===\n// Reconstruct sections with split opportunities\nconst normalisedSections = { ...sections };\n\n// Replace single opportunities with split structure\nif (hasSingleOpps && !hasSplitOpps) {\n  delete normalisedSections.opportunities;\n}\n\n// Ensure new_opportunities and confirm_existing sections exist\nnormalisedSections.new_opportunities = {\n  title: sections.new_opportunities?.title || 'New Optimisation Opportunities',\n  items: newOpportunities\n};\n\nnormalisedSections.confirm_existing = {\n  title: sections.confirm_existing?.title || 'Benefits Health Check',\n  subtitle: sections.confirm_existing?.subtitle || \"Confirm you're receiving these entitlements\",\n  items: confirmExisting\n};\n\nconst report = {\n  sections: normalisedSections,\n  classification: l1,\n  detailed_analysis: {\n    opportunities: l2.opportunities || [],\n    risk_flags: l2.risk_flags || [],\n    lifestyle_scenarios: l2.lifestyle_scenarios || [],\n    scenario_table: l2.scenario_table || null,\n    life_event_actions: l2.life_event_actions || []\n  },\n  // V3.1: Split totals\n  total_new_opportunities: Math.round(totalNewFinal),\n  total_confirm_existing: Math.round(totalConfirmFinal),\n  estimated_total_savings: Math.round(estimatedTotal),\n  top_opportunity: topOpportunity,\n  mls_at_risk: mlsAtRisk,\n  analysis_depth: m.analysis_depth || 'quick_snapshot',\n  disclaimer: \"This report provides general information only and does not constitute personal financial, tax, or legal advice. It does not take into account your complete financial situation or objectives. The information is based on publicly available Australian tax rules for the FY2025-26 income year. You should consult a registered tax agent or qualified financial adviser before making any decisions. Lyros Pty Ltd (ACN 689 015 165) is not a registered tax agent or holder of an Australian Financial Services Licence. Estimated dollar figures are indicative only.\"\n};\n\nreturn [{ json: {\n  report,\n  original_contact: m.original_contact || {},\n  pii_map: m.pii_map || {},\n  trigger: m.trigger || {},\n  guardrail_corrections: m.guardrail_corrections || [],\n  report_meta: {\n    complete: isComplete,\n    section_count: Object.keys(normalisedSections).length,\n    expected_core_sections: coreExpected,\n    missing_sections: coreMissing,\n    has_classification: hasL1,\n    has_analysis: hasL2,\n    has_narrative: hasL3,\n    l2_truncated: l2Truncated,\n    // V3.1 split totals\n    total_new_opportunities: Math.round(totalNewFinal),\n    total_confirm_existing: Math.round(totalConfirmFinal),\n    estimated_total_savings: Math.round(estimatedTotal),\n    new_opportunity_count: newOpportunities.length,\n    confirm_existing_count: confirmExisting.length,\n    top_opportunity: topOpportunity,\n    mls_at_risk: mlsAtRisk,\n    risk_alert_count: sections.risk_alerts?.items?.length || 0,\n    has_scenario_table: !!(sections.lifestyle_scenarios?.scenario_table),\n    has_lifestyle_scenarios: !!(sections.lifestyle_scenarios?.items?.length > 0),\n    affordability_flags: allOpps.filter(o => o.affordability_flag).length,\n    unexpanded_acronyms: unexpandedAcronyms\n  },\n  token_usage: { l1: m.l1_usage || null, l2: m.l2_usage || null, l3: l3Usage },\n  __audit: { node: NODE, ts: new Date().toISOString(), warnings, errors },\n  meta: { run_id: runId, correlation_id: runId, valid: isComplete,\n    form_type: m.analysis_depth || 'quick_snapshot', warnings, errors }\n}}];"
      },
      "id": "db560a16-7e07-411d-b1f2-c027fd519d4c",
      "name": "N4 Normalise Report Structure",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3008,
        224
      ]
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Renders the normalised report into a branded Lyros HTML email.\n * V3.1 FULL REWRITE â€” addresses Issues 2,3,4,5,9,10,13,14.\n *   - Split hero: new_opportunities (hero) + confirm_existing (secondary)\n *   - Table formatting: +/â€“ prefixes, subtotal/total borders, bold totals\n *   - Language: \"Example\" / \"Assumed\" throughout, never \"Current\" for calculated figures\n *   - Salary sacrifice: affordability callout box\n *   - Confirm & Optimise: different card style with âœ“ badge\n *   - External links: styled CTA buttons with descriptive text\n *   - Childcare scenario: opportunity cost framework in bottom_line\n *\n * INPUTS\n * - $input: R3 true output (N4 normalised report)\n * - $('C1 Config'): email_config\n *\n * REMOVALS - None (passthrough of all upstream data)\n *\n * ADDITIONS\n * - html_email (string): fully rendered HTML email body\n * - email_subject (string): subject line with emoji and personalisation\n * - email_to (string): recipient email from original_contact\n *\n * ROW GUIDE\n * Input:  { report: {...}, original_contact: {...}, ...passthrough }\n * Output: { html_email: \"...\", email_subject: \"...\", email_to: \"...\", ...passthrough }\n *\n * ASSUMPTIONS\n * - R3 has validated report completeness\n * - N4 provides report.sections.new_opportunities and report.sections.confirm_existing\n * - N4 provides report.total_new_opportunities and report.total_confirm_existing\n * - Falls back gracefully if fields are missing\n *\n * AUDIT\n * Hybrid: warns on missing sections. Tracks rendered sections and html size.\n */\nconst NODE = 'P5 Build HTML Email Report';\nconst m = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst warnings = [];\nconst errors = [];\nconst runId = m.meta?.run_id || $execution.id || `${Date.now()}`;\n\n// === DATA ===\nconst report = m.report || {};\nconst sections = report.sections || {};\nconst contact = m.original_contact || {};\nconst firstName = contact.first_name || 'there';\n\n// V3.1: Split totals\nconst totalNew = report.total_new_opportunities || 0;\nconst totalConfirm = report.total_confirm_existing || 0;\nconst totalCombined = report.estimated_total_savings || (totalNew + totalConfirm);\nconst formattedNew = '$' + totalNew.toLocaleString('en-AU');\nconst formattedConfirm = '$' + totalConfirm.toLocaleString('en-AU');\nconst formattedTotal = '$' + totalCombined.toLocaleString('en-AU');\n\nconst mlsAtRisk = report.mls_at_risk || false;\nconst analysisDepth = report.analysis_depth || 'quick_snapshot';\nconst disclaimer = report.disclaimer || '';\nconst depthLabel = analysisDepth === 'deep_dive' ? 'Detailed Analysis' : 'Quick Snapshot';\n\n// === HELPERS ===\n\nfunction esc(str) {\n  if (!str) return '';\n  return String(str)\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;');\n}\n\nfunction priorityDot(level) {\n  const colors = { high: '#ef4444', medium: '#f59e0b', low: '#10b981' };\n  const labels = { high: 'HIGH IMPACT', medium: 'MEDIUM IMPACT', low: 'LOW IMPACT' };\n  const c = colors[level] || colors.medium;\n  return `<span style=\"display:inline-block;width:8px;height:8px;border-radius:50%;background:${c};margin-right:4px;vertical-align:middle;\"></span><span style=\"color:${c};font-size:11px;font-weight:bold;letter-spacing:0.5px;vertical-align:middle;\">${labels[level] || 'MEDIUM IMPACT'}</span>`;\n}\n\nfunction severityTag(severity) {\n  const c = {\n    high: { bg: '#fef2f2', text: '#991b1b', icon: 'ğŸš¨' },\n    medium: { bg: '#fffbeb', text: '#92400e', icon: 'âš ï¸' },\n    low: { bg: '#f0fdf4', text: '#065f46', icon: 'â„¹ï¸' }\n  };\n  const x = c[severity] || c.medium;\n  return `<span style=\"background:${x.bg};color:${x.text};padding:2px 8px;border-radius:4px;font-size:11px;font-weight:bold;\">${x.icon} ${(severity || 'medium').toUpperCase()}</span>`;\n}\n\n/**\n * V3.1 ENHANCED CALC TABLE\n * - Detects +/â€“ prefixes in labels and styles accordingly\n * - Detects subtotal/total rows and adds appropriate borders\n * - Bold total rows with green background\n * - Subtotal rows get lighter border\n */\nfunction calcTable(rows) {\n  if (!rows || rows.length === 0) return '';\n  const isLastRow = (i) => i === rows.length - 1;\n\n  function isSubtotal(label) {\n    const l = (label || '').toLowerCase();\n    return l.includes('subtotal') || l.startsWith('sub-total');\n  }\n\n  function isTotal(label, idx) {\n    if (isLastRow(idx)) return true;\n    const l = (label || '').toLowerCase();\n    return l.startsWith('total') || l.startsWith('estimated annual') || l.startsWith('estimated total')\n      || l.startsWith('net ') || l.includes('total ');\n  }\n\n  function isDeduction(label, amount) {\n    const l = (label || '').toLowerCase();\n    const a = (amount || '').trim();\n    return l.startsWith('â€“') || l.startsWith('- ') || l.startsWith('minus')\n      || a.startsWith('â€“') || a.startsWith('-$') || a.startsWith('-');\n  }\n\n  function isAddition(label, amount) {\n    const l = (label || '').toLowerCase();\n    const a = (amount || '').trim();\n    return l.startsWith('+') || l.startsWith('plus') || a.startsWith('+');\n  }\n\n  let html = '<table style=\"width:100%;border-collapse:collapse;margin:8px 0;\" cellpadding=\"0\" cellspacing=\"0\">';\n\n  rows.forEach((row, i) => {\n    const label = row.label || '';\n    const amount = row.amount || '';\n    const isTotalRow = isTotal(label, i);\n    const isSubtotalRow = isSubtotal(label);\n    const isDeductionRow = isDeduction(label, amount);\n    const isAdditionRow = isAddition(label, amount);\n\n    // Styling\n    let weight = 'normal';\n    let topBorder = '';\n    let bg = i % 2 === 0 ? 'background:#f9fafb;' : '';\n    let labelColor = '#374151';\n    let amountColor = '#111827';\n\n    if (isTotalRow) {\n      weight = 'bold';\n      topBorder = 'border-top:2px solid #374151;';\n      bg = 'background:#f0fdf4;';\n      amountColor = '#065f46';\n    } else if (isSubtotalRow) {\n      weight = '600';\n      topBorder = 'border-top:1px solid #9ca3af;';\n      bg = 'background:#f9fafb;';\n    }\n\n    // Amount colour for deductions/additions\n    if (isDeductionRow && !isTotalRow) {\n      amountColor = '#dc2626';\n    } else if (isAdditionRow && !isTotalRow) {\n      amountColor = '#059669';\n    }\n\n    // Indent intermediate rows (not first, not total, not subtotal)\n    const indent = (!isTotalRow && !isSubtotalRow && i > 0) ? 'padding-left:18px;' : '';\n\n    html += `<tr style=\"${bg}\">\n      <td style=\"padding:6px 10px;${indent}font-size:13px;color:${labelColor};font-weight:${weight};${topBorder}\">${esc(label)}</td>\n      <td style=\"padding:6px 10px;font-size:13px;color:${amountColor};font-weight:${weight};text-align:right;white-space:nowrap;${topBorder}\">${esc(amount)}</td>\n    </tr>`;\n  });\n\n  html += '</table>';\n  return html;\n}\n\nfunction stepsBlock(text) {\n  if (!text) return '';\n  return `<div style=\"background:#f9fafb;padding:10px 14px;margin:8px 0;border-radius:4px;font-size:13px;color:#374151;line-height:1.6;\">\n    <strong style=\"color:#065f46;\">How to claim:</strong><br>${esc(text)}\n  </div>`;\n}\n\n/** V3.1: Styled CTA button (not bare link) */\nfunction ctaButton(url, label) {\n  if (!url) return '';\n  const btnLabel = label ? esc(label) + ' â†’' : 'Learn more â†’';\n  return `<a href=\"${esc(url)}\" target=\"_blank\" rel=\"noopener\" style=\"display:inline-block;background:#10b981;color:#ffffff;padding:10px 20px;border-radius:5px;font-size:13px;font-weight:bold;text-decoration:none;margin-top:10px;\">${btnLabel}</a>`;\n}\n\nfunction relatedBenefitsBlock(items) {\n  if (!items || items.length === 0) return '';\n  let html = '<div style=\"background:#eff6ff;border-left:3px solid #3b82f6;padding:8px 12px;margin:8px 0;border-radius:0 4px 4px 0;\"><strong style=\"color:#1e40af;font-size:12px;\">ğŸ’¡ How this connects to your other benefits:</strong><ul style=\"margin:4px 0 0 16px;padding:0;font-size:12px;color:#374151;line-height:1.5;\">';\n  items.forEach(item => { html += `<li>${esc(item)}</li>`; });\n  html += '</ul></div>';\n  return html;\n}\n\nfunction categoryIcon(cat) {\n  const icons = { government_benefit: 'ğŸ›ï¸', tax_deduction: 'ğŸ§¾', superannuation: 'ğŸ¦', investment: 'ğŸ“ˆ', compliance: 'âš–ï¸' };\n  return icons[cat] || 'ğŸ’¡';\n}\n\nfunction categoryLabel(cat) {\n  const labels = { government_benefit: 'Government Benefit', tax_deduction: 'Tax Deduction', superannuation: 'Superannuation', investment: 'Investment', compliance: 'Compliance' };\n  return labels[cat] || 'Opportunity';\n}\n\n/** V3.1: Affordability warning callout for salary sacrifice */\nfunction affordabilityCallout(opp) {\n  if (!opp.affordability_flag && !opp.affordability_warning) return '';\n  const warningText = opp.affordability_warning\n    || 'This strategy reduces your fortnightly take-home pay. Super contributions generally cannot be accessed until age 60. Consider whether your household budget can absorb the reduction before proceeding.';\n  return `<div style=\"background:#fffbeb;border-left:3px solid #f59e0b;padding:10px 14px;margin:10px 0;border-radius:0 4px 4px 0;\">\n    <strong style=\"color:#92400e;font-size:13px;\">âš ï¸ Affordability note:</strong>\n    <p style=\"color:#78350f;font-size:13px;margin:4px 0 0 0;line-height:1.5;\">${esc(warningText)}</p>\n  </div>`;\n}\n\n// === RENDER OPPORTUNITY CARD (shared between new + confirm) ===\nfunction renderOpportunityCard(opp, isConfirm) {\n  const borderColor = isConfirm\n    ? '#3b82f6'\n    : (opp.confidence === 'high' ? '#10b981' : opp.confidence === 'medium' ? '#f59e0b' : '#9ca3af');\n  const icon = categoryIcon(opp.category);\n  const catLabel = categoryLabel(opp.category);\n\n  // V3.1: Confirm badge or priority dot\n  const badge = isConfirm\n    ? `<span style=\"background:#eff6ff;color:#1e40af;padding:3px 10px;border-radius:12px;font-size:11px;font-weight:bold;\">âœ“ Confirm You're Receiving</span>`\n    : priorityDot(opp.confidence);\n\n  const headerBg = isConfirm ? '#eff6ff' : '#f9fafb';\n\n  return `\n    <div style=\"border:1px solid #e5e7eb;border-left:3px solid ${borderColor};border-radius:8px;margin:16px 0;overflow:hidden;\">\n      <!-- Card Header -->\n      <div style=\"background:${headerBg};padding:14px 16px;border-bottom:1px solid #e5e7eb;\">\n        <div>\n          <span style=\"font-size:12px;color:#6b7280;margin-right:6px;\">${icon} ${esc(catLabel)}</span>\n          ${badge}\n          ${opp.estimated_annual_value ? `<span style=\"color:${isConfirm ? '#1e40af' : '#10b981'};font-weight:bold;font-size:18px;float:right;\">${esc(String(opp.estimated_annual_value))}</span>` : ''}\n        </div>\n        <div style=\"font-size:17px;font-weight:bold;color:#111827;margin-top:6px;\">${esc(opp.title)}</div>\n        ${opp.applies_to ? `<div style=\"font-size:12px;color:#6b7280;margin-top:2px;\">Applies to: ${esc(opp.applies_to)}</div>` : ''}\n      </div>\n\n      <!-- Card Body -->\n      <div style=\"padding:14px 16px;\">\n        ${opp.eligibility_reason ? `<p style=\"color:#065f46;font-size:13px;font-weight:bold;margin:0 0 6px 0;\">Why you may qualify:</p><p style=\"color:#374151;font-size:13px;line-height:1.5;margin:0 0 10px 0;\">${esc(opp.eligibility_reason)}</p>` : ''}\n\n        ${opp.description ? `<p style=\"color:#374151;font-size:14px;line-height:1.5;margin:0 0 10px 0;\">${esc(opp.description)}</p>` : ''}\n\n        ${opp.calculation_rows ? `<div style=\"margin:10px 0;\"><strong style=\"color:#065f46;font-size:13px;\">How this is calculated:</strong>${calcTable(opp.calculation_rows)}</div>` : ''}\n\n        ${relatedBenefitsBlock(opp.related_benefits)}\n\n        ${affordabilityCallout(opp)}\n\n        ${opp.information_needed ? `<div style=\"margin:8px 0;font-size:13px;color:#374151;\"><strong style=\"color:#374151;\">ğŸ“‹ What you'll need:</strong> ${esc(opp.information_needed)}</div>` : ''}\n\n        ${stepsBlock(opp.how_to_claim)}\n\n        <div style=\"margin-top:10px;\">\n          ${ctaButton(opp.url, opp.url_label)}\n        </div>\n      </div>\n    </div>`;\n}\n\n\n// === BUILD HTML PARTS ===\nconst parts = [];\nconst renderedKeys = [];\n\n// â”€â”€â”€ YOUR SNAPSHOT â”€â”€â”€\nif (sections.your_snapshot) {\n  renderedKeys.push('your_snapshot');\n\n  // V3.1: Split hero â€” new opportunities as primary, confirm as secondary\n  let heroBanner = '';\n  if (totalNew > 0) {\n    heroBanner = `\n      <div style=\"text-align:center;margin:20px 0 8px 0;\">\n        <div style=\"font-size:13px;color:#d1fae5;\">New optimisation opportunities identified</div>\n        <div style=\"font-size:42px;font-weight:bold;color:#ffffff;margin:4px 0;\">${esc(formattedNew)}</div>\n        <div style=\"font-size:12px;color:#a7f3d0;\">per year Â· based on ${depthLabel.toLowerCase()}</div>\n      </div>`;\n\n    if (totalConfirm > 0) {\n      heroBanner += `\n        <div style=\"text-align:center;margin:8px 0 0 0;padding-top:10px;border-top:1px solid rgba(255,255,255,0.2);\">\n          <div style=\"font-size:12px;color:#a7f3d0;\">Plus: Benefits Health Check (confirm you're receiving)</div>\n          <div style=\"font-size:24px;font-weight:bold;color:#d1fae5;margin:2px 0;\">${esc(formattedConfirm)}</div>\n        </div>`;\n    }\n  } else if (totalCombined > 0) {\n    // Fallback: no split data, show combined\n    heroBanner = `\n      <div style=\"text-align:center;margin:20px 0 8px 0;\">\n        <div style=\"font-size:13px;color:#d1fae5;\">Estimated potential savings</div>\n        <div style=\"font-size:42px;font-weight:bold;color:#ffffff;margin:4px 0;\">${esc(formattedTotal)}</div>\n        <div style=\"font-size:12px;color:#a7f3d0;\">per year Â· based on ${depthLabel.toLowerCase()}</div>\n      </div>`;\n  }\n\n  // Note: heroBanner goes inside the header gradient, not in the content area\n  // We'll inject it later into the header section\n\n  parts.push(`\n    <h2 style=\"color:#10b981;font-size:20px;margin:0 0 12px 0;\">ğŸ‘‹ ${esc(sections.your_snapshot.title || 'Your Family Snapshot')}</h2>\n    <p style=\"color:#374151;font-size:15px;line-height:1.6;margin:0;\">${esc(sections.your_snapshot.content)}</p>\n  `);\n\n  // Store heroBanner for header injection\n  parts._heroBanner = heroBanner;\n} else { warnings.push('Missing: your_snapshot'); }\n\n// â”€â”€â”€ TAX POSITION â”€â”€â”€\nif (sections.tax_position) {\n  renderedKeys.push('tax_position');\n  parts.push(`\n    <div style=\"padding:28px 0 0 0;border-top:1px solid #e5e7eb;margin-top:28px;\"></div>\n    <h2 style=\"color:#10b981;font-size:20px;margin:0 0 12px 0;\">ğŸ“Š ${esc(sections.tax_position.title || 'Your Tax Position')}</h2>\n    <p style=\"color:#374151;font-size:15px;line-height:1.6;margin:0;\">${esc(sections.tax_position.content)}</p>\n  `);\n} else { warnings.push('Missing: tax_position'); }\n\n// â”€â”€â”€ NEW OPPORTUNITIES â”€â”€â”€\nconst newOpps = sections.new_opportunities?.items || [];\nif (newOpps.length > 0) {\n  renderedKeys.push('new_opportunities');\n  let oppsHtml = '';\n  newOpps.forEach(opp => {\n    oppsHtml += renderOpportunityCard(opp, false);\n  });\n\n  parts.push(`\n    <div style=\"padding:28px 0 0 0;border-top:1px solid #e5e7eb;margin-top:28px;\"></div>\n    <h2 style=\"color:#10b981;font-size:20px;margin:0 0 4px 0;\">ğŸ’¡ ${esc(sections.new_opportunities.title || 'New Optimisation Opportunities')}</h2>\n    <p style=\"color:#6b7280;font-size:13px;margin:0 0 12px 0;\">Ranked by estimated annual value â€” highest first</p>\n    ${oppsHtml}\n  `);\n} else { warnings.push('Missing: new_opportunities items'); }\n\n// â”€â”€â”€ CONFIRM EXISTING (Benefits Health Check) â”€â”€â”€\nconst confirmOpps = sections.confirm_existing?.items || [];\nif (confirmOpps.length > 0) {\n  renderedKeys.push('confirm_existing');\n  let confirmHtml = '';\n  confirmOpps.forEach(opp => {\n    confirmHtml += renderOpportunityCard(opp, true);\n  });\n\n  parts.push(`\n    <div style=\"padding:28px 0 0 0;border-top:1px solid #e5e7eb;margin-top:28px;\"></div>\n    <h2 style=\"color:#3b82f6;font-size:20px;margin:0 0 4px 0;\">âœ“ ${esc(sections.confirm_existing.title || 'Benefits Health Check')}</h2>\n    <p style=\"color:#6b7280;font-size:13px;margin:0 0 12px 0;\">${esc(sections.confirm_existing.subtitle || \"Confirm you're receiving these entitlements â€” check you're getting the maximum amount\")}</p>\n    ${confirmHtml}\n  `);\n}\n\n// â”€â”€â”€ RISK ALERTS â”€â”€â”€\nif (sections.risk_alerts?.items?.length > 0) {\n  renderedKeys.push('risk_alerts');\n  let risksHtml = '';\n  sections.risk_alerts.items.forEach(risk => {\n    const borderColor = risk.severity === 'high' ? '#ef4444' : risk.severity === 'medium' ? '#f59e0b' : '#10b981';\n    risksHtml += `\n      <div style=\"border:1px solid #f3f4f6;border-left:3px solid ${borderColor};padding:14px 16px;margin:14px 0;border-radius:0 6px 6px 0;\">\n        <div style=\"margin-bottom:6px;\">\n          ${severityTag(risk.severity)}\n          <strong style=\"color:#111827;margin-left:8px;font-size:15px;\">${esc(risk.alert)}</strong>\n          ${risk.estimated_cost ? `<span style=\"color:#ef4444;font-weight:bold;font-size:14px;float:right;\">${esc(risk.estimated_cost)}/yr</span>` : ''}\n        </div>\n        ${risk.description ? `<p style=\"color:#4b5563;font-size:13px;line-height:1.5;margin:6px 0;\">${esc(risk.description)}</p>` : ''}\n        ${risk.calculation_rows ? calcTable(risk.calculation_rows) : ''}\n        ${risk.action ? `<p style=\"color:#4b5563;font-size:13px;margin:8px 0 0 0;\"><strong style=\"color:#b45309;\">Action:</strong> ${esc(risk.action)}</p>` : ''}\n        ${risk.url ? `<div style=\"margin-top:8px;\">${ctaButton(risk.url, risk.url_label || 'Learn more')}</div>` : ''}\n      </div>`;\n  });\n\n  parts.push(`\n    <div style=\"padding:28px 0 0 0;border-top:1px solid #e5e7eb;margin-top:28px;\"></div>\n    <h2 style=\"color:#10b981;font-size:20px;margin:0 0 12px 0;\">ğŸš¨ ${esc(sections.risk_alerts.title || 'Risk Alerts')}</h2>\n    ${risksHtml}\n  `);\n} else { warnings.push('Missing: risk_alerts'); }\n\n// â”€â”€â”€ LIFESTYLE SCENARIOS + SCENARIO TABLE â”€â”€â”€\nif (sections.lifestyle_scenarios) {\n  renderedKeys.push('lifestyle_scenarios');\n  const ls = sections.lifestyle_scenarios;\n  let lsHtml = ls.content ? `<p style=\"color:#374151;font-size:14px;line-height:1.5;margin:0 0 16px 0;\">${esc(ls.content)}</p>` : '';\n\n  // Scenario comparisons (Option A vs Option B)\n  if (ls.items?.length > 0) {\n    ls.items.forEach(item => {\n      lsHtml += `\n        <div style=\"border:1px solid #e5e7eb;border-radius:8px;margin:14px 0;overflow:hidden;\">\n          <div style=\"background:#f9fafb;padding:12px 16px;border-bottom:1px solid #e5e7eb;\">\n            <strong style=\"color:#111827;font-size:15px;\">ğŸ”„ ${esc(item.title)}</strong>\n            ${item.net_difference ? `<span style=\"color:#10b981;font-weight:bold;font-size:15px;float:right;\">${esc(item.net_difference)}</span>` : ''}\n          </div>\n          <div style=\"padding:14px 16px;\">\n            ${item.scenario ? `<p style=\"color:#6b7280;font-size:13px;margin:0 0 10px 0;font-style:italic;\">${esc(item.scenario)}</p>` : ''}\n\n            <!-- Two-column comparison -->\n            <table style=\"width:100%;border-collapse:collapse;\" cellpadding=\"0\" cellspacing=\"0\">\n              <tr>\n                <td style=\"width:48%;vertical-align:top;padding-right:8px;\">\n                  ${item.option_a ? `<div style=\"background:#f0fdf4;border-radius:6px;padding:10px;\">\n                    <strong style=\"color:#065f46;font-size:13px;\">${esc(item.option_a.label)}</strong>\n                    ${calcTable(item.option_a.calculation_rows)}\n                    ${item.option_a.total ? `<div style=\"text-align:right;font-weight:bold;color:#065f46;font-size:14px;margin-top:4px;\">${esc(item.option_a.total)}</div>` : ''}\n                  </div>` : ''}\n                </td>\n                <td style=\"width:4%;vertical-align:middle;text-align:center;\"><span style=\"color:#9ca3af;font-size:18px;\">vs</span></td>\n                <td style=\"width:48%;vertical-align:top;padding-left:8px;\">\n                  ${item.option_b ? `<div style=\"background:#eff6ff;border-radius:6px;padding:10px;\">\n                    <strong style=\"color:#1e40af;font-size:13px;\">${esc(item.option_b.label)}</strong>\n                    ${calcTable(item.option_b.calculation_rows)}\n                    ${item.option_b.total ? `<div style=\"text-align:right;font-weight:bold;color:#1e40af;font-size:14px;margin-top:4px;\">${esc(item.option_b.total)}</div>` : ''}\n                  </div>` : ''}\n                </td>\n              </tr>\n            </table>\n\n            ${item.bottom_line ? `<div style=\"background:#fefce8;border-radius:4px;padding:10px 12px;margin-top:10px;font-size:14px;color:#111827;\"><strong>ğŸ’¡ Bottom line:</strong> ${esc(item.bottom_line)}</div>` : ''}\n          </div>\n        </div>`;\n    });\n  }\n\n  // Scenario Analysis Table (Â±20% income)\n  const st = ls.scenario_table;\n  if (st?.columns && st?.rows) {\n    lsHtml += `\n      <div style=\"margin:24px 0 0 0;\">\n        <h3 style=\"color:#111827;font-size:16px;margin:0 0 6px 0;\">ğŸ“Š Income Scenario Analysis</h3>\n        ${st.description ? `<p style=\"color:#6b7280;font-size:13px;margin:0 0 10px 0;\">${esc(st.description)}</p>` : ''}\n        <table style=\"width:100%;border-collapse:collapse;border:1px solid #d1d5db;border-radius:6px;overflow:hidden;\" cellpadding=\"0\" cellspacing=\"0\">\n          <thead>\n            <tr style=\"background:#065f46;\">\n              <th style=\"padding:10px 12px;text-align:left;font-size:13px;color:#ffffff;border-bottom:2px solid #047857;\"></th>`;\n\n    st.columns.forEach(col => {\n      lsHtml += `<th style=\"padding:10px 12px;text-align:right;font-size:13px;color:#ffffff;border-bottom:2px solid #047857;font-weight:bold;\">${esc(col.label)}${col.income ? `<br><span style=\"font-weight:normal;font-size:11px;opacity:0.85;\">${esc(String(col.income))}</span>` : ''}</th>`;\n    });\n\n    lsHtml += `</tr></thead><tbody>`;\n\n    st.rows.forEach((row, i) => {\n      const isLast = i === st.rows.length - 1;\n      const bg = isLast ? 'background:#f0fdf4;' : (i % 2 === 0 ? 'background:#ffffff;' : 'background:#f9fafb;');\n      const weight = isLast ? 'font-weight:bold;' : '';\n      const topBorder = isLast ? 'border-top:2px solid #10b981;' : 'border-bottom:1px solid #f3f4f6;';\n\n      lsHtml += `<tr style=\"${bg}\"><td style=\"padding:8px 12px;font-size:13px;color:#374151;${weight}${topBorder}\">${esc(row.label)}</td>`;\n      (row.values || []).forEach(val => {\n        lsHtml += `<td style=\"padding:8px 12px;font-size:13px;color:#111827;text-align:right;${weight}${topBorder}\">${esc(val)}</td>`;\n      });\n      lsHtml += `</tr>`;\n    });\n\n    lsHtml += `</tbody></table>`;\n\n    if (st.insight) {\n      lsHtml += `<div style=\"background:#fefce8;border-radius:4px;padding:10px 12px;margin-top:10px;font-size:13px;color:#111827;\"><strong>ğŸ’¡ Key insight:</strong> ${esc(st.insight)}</div>`;\n    }\n    lsHtml += `</div>`;\n  }\n\n  parts.push(`\n    <div style=\"padding:28px 0 0 0;border-top:1px solid #e5e7eb;margin-top:28px;\"></div>\n    <h2 style=\"color:#10b981;font-size:20px;margin:0 0 12px 0;\">ğŸ¡ ${esc(ls.title || 'What Would This Look Like for Your Family?')}</h2>\n    ${lsHtml}\n  `);\n}\n\n// â”€â”€â”€ CTA â”€â”€â”€\nparts.push(`\n  <div style=\"text-align:center;margin:32px 0 16px 0;\">\n    <p style=\"color:#6b7280;font-size:14px;margin:0 0 16px 0;\">Consider discussing these strategies with a qualified tax professional.</p>\n    <a href=\"mailto:chris@lyros.com.au?subject=Family%20Tax%20Report%20Follow-up\" style=\"background:#10b981;color:#ffffff;padding:14px 36px;text-decoration:none;border-radius:6px;display:inline-block;font-weight:bold;font-size:15px;\">Book a Free Chat</a>\n  </div>\n`);\n\n// â”€â”€â”€ MLS BANNER â”€â”€â”€\nif (mlsAtRisk) {\n  parts.push(`\n    <div style=\"border-left:3px solid #ef4444;padding:12px 16px;margin:20px 0;background:#fef2f2;border-radius:0 4px 4px 0;\">\n      <strong style=\"color:#991b1b;\">âš ï¸ Medicare Levy Surcharge Alert</strong>\n      <p style=\"color:#4b5563;margin:6px 0 0 0;font-size:13px;\">Based on your income range, you may be liable for the Medicare Levy Surcharge (MLS) if you don't hold appropriate private hospital cover. Check the Risk Alerts section above for details and estimated cost.</p>\n      <div style=\"margin-top:8px;\">${ctaButton('https://www.ato.gov.au/individuals-and-families/medicare-and-private-health-insurance/medicare-levy-surcharge', 'Check MLS thresholds on the ATO website')}</div>\n    </div>`);\n}\n\n// === ASSEMBLE FULL HTML ===\nconst heroBanner = parts._heroBanner || '';\ndelete parts._heroBanner;\n\n// V3.1: Subject line uses NEW opportunities total only\nconst savingsTag = totalNew > 0\n  ? ` â€” up to ${formattedNew} in new optimisation opportunities`\n  : (totalCombined > 0 ? ` â€” up to ${formattedTotal} in potential savings` : '');\nconst emailSubject = `ğŸ’° ${firstName}, your Family Tax Report is ready${savingsTag}`;\n\n// V3.1: Header subtitle reflects split\nlet subtitle = '';\nif (totalNew > 0) {\n  subtitle = `Up to ${formattedNew} in new optimisation opportunities identified`;\n  if (totalConfirm > 0) {\n    subtitle += ` Â· plus ${formattedConfirm} in benefits to confirm`;\n  }\n} else if (totalCombined > 0) {\n  subtitle = `Up to ${formattedTotal} in potential annual savings identified`;\n} else {\n  subtitle = `Your personalised ${depthLabel.toLowerCase()} is ready`;\n}\n\nconst htmlEmail = `<!DOCTYPE html>\n<html>\n<head>\n<meta charset=\"utf-8\">\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n</head>\n<body style=\"margin:0;padding:0;background-color:#f3f4f6;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Arial,sans-serif;\">\n  <div style=\"max-width:640px;margin:20px auto;background:#ffffff;border-radius:8px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.1);\">\n    <!-- Header -->\n    <div style=\"background:linear-gradient(135deg,#065f46 0%,#10b981 100%);color:#ffffff;padding:36px 30px;text-align:center;\">\n      <div style=\"font-size:26px;font-weight:bold;\">ğŸ’° ${esc(firstName)}'s Family Tax Report</div>\n      ${heroBanner}\n      <div style=\"font-size:12px;margin-top:6px;opacity:0.7;\">${depthLabel} Â· FY2025-26</div>\n    </div>\n    <!-- Content -->\n    <div style=\"padding:32px 28px;color:#374151;line-height:1.6;\">\n      ${parts.join('\\n')}\n      <!-- Disclaimer -->\n      <div style=\"border-top:1px solid #e5e7eb;margin-top:28px;padding-top:20px;\">\n        <div style=\"border:1px solid #e5e7eb;border-radius:6px;padding:16px;\">\n          <p style=\"color:#9ca3af;font-size:11px;line-height:1.5;margin:0;\">\n            <strong style=\"color:#6b7280;\">Important Notice:</strong> ${esc(disclaimer)}\n          </p>\n        </div>\n      </div>\n    </div>\n    <!-- Footer -->\n    <div style=\"background:#f9fafb;padding:24px;text-align:center;border-top:1px solid #e5e7eb;\">\n      <p style=\"margin:0 0 4px 0;color:#374151;font-size:13px;\"><strong>Lyros Pty Ltd</strong> (ACN 689 015 165)</p>\n      <p style=\"margin:0 0 4px 0;color:#9ca3af;font-size:12px;\">Melbourne, Australia</p>\n      <p style=\"margin:0;font-size:12px;\"><a href=\"mailto:chris@lyros.com.au\" style=\"color:#10b981;\">chris@lyros.com.au</a> Â· <a href=\"https://www.lyros.com.au\" style=\"color:#10b981;\">lyros.com.au</a></p>\n    </div>\n  </div>\n</body>\n</html>`;\n\nreturn [{ json: {\n  html_email: htmlEmail,\n  email_subject: emailSubject,\n  email_to: contact.email || '',\n  report: m.report,\n  original_contact: m.original_contact,\n  pii_map: m.pii_map,\n  trigger: m.trigger,\n  report_meta: m.report_meta,\n  token_usage: m.token_usage,\n  guardrail_corrections: m.guardrail_corrections || [],\n  __audit: {\n    node: NODE,\n    ts: new Date().toISOString(),\n    rendered_sections: renderedKeys,\n    new_opportunity_cards: newOpps.length,\n    confirm_existing_cards: confirmOpps.length,\n    html_length: htmlEmail.length,\n    warnings,\n    errors\n  },\n  meta: {\n    run_id: runId,\n    correlation_id: runId,\n    valid: errors.length === 0,\n    form_type: analysisDepth,\n    warnings,\n    errors\n  }\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3392,
        128
      ],
      "id": "65e63d26-ad41-4b7a-a81a-84f240a20e1f",
      "name": "P5 build html email"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.leads_sheet_id }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "={{ $('C1 Config').item.json.data_config.leads_sheet_name }}",
          "mode": "name"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "submission_ts": "={{ $json.trigger.v1.ts }}",
            "run_id": "={{ $json.meta.run_id }}",
            "report_sent_ts": "={{ $now.toISO() }}",
            "report_sent": "true",
            "consent_marketing": "={{ $json.original_contact.consent_marketing }}",
            "mls_at_risk": "={{ $json.report_meta.mls_at_risk }}",
            "estimated_total_savings": "={{ $json.report_meta.estimated_total_savings }}",
            "top_opportunity": "={{ $json.report_meta.top_opportunity }}",
            "form_type": "={{ $json.meta.form_type }}",
            "household_income_range": "={{ $json.trigger.v1.income.household_income_range }}",
            "num_dependants": "={{ $json.trigger.v1.household.num_dependants }}",
            "relationship_status": "={{ $json.trigger.v1.household.relationship_status }}",
            "state": "={{ $json.trigger.v1.household.state }}",
            "phone": "={{ $json.original_contact.phone }}",
            "email": "={{ $json.original_contact.email }}",
            "first_name": "={{ $json.original_contact.first_name }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "submission_ts",
              "displayName": "submission_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "run_id",
              "displayName": "run_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "first_name",
              "displayName": "first_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "email",
              "displayName": "email",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "phone",
              "displayName": "phone",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "state",
              "displayName": "state",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "relationship_status",
              "displayName": "relationship_status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "num_dependants",
              "displayName": "num_dependants",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "household_income_range",
              "displayName": "household_income_range",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "form_type",
              "displayName": "form_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "top_opportunity",
              "displayName": "top_opportunity",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "estimated_total_savings",
              "displayName": "estimated_total_savings",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "mls_at_risk",
              "displayName": "mls_at_risk",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "consent_marketing",
              "displayName": "consent_marketing",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "report_sent",
              "displayName": "report_sent",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "report_sent_ts",
              "displayName": "report_sent_ts",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "5f1468fb-97e9-43b3-8a33-e8c6794bcfc6",
      "name": "S3 Store Submission To Sheets",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        3584,
        128
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "abKeADxb1EcKR29m",
          "name": "Google Sheets (Lyros) - 18/11/25 10:30am"
        }
      }
    },
    {
      "parameters": {
        "toRecipients": "={{ $('P5 build html email').item.json.email_to }}",
        "subject": "={{ $('P5 build html email').item.json.email_subject }}",
        "bodyContent": "={{ $('P5 build html email').item.json.html_email }}",
        "additionalFields": {
          "from": "automations@lyros.com.au",
          "bodyContentType": "html"
        }
      },
      "id": "254693d2-a35a-4af4-9673-452384d4a8e3",
      "name": "X3 Send Report Email To User",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        3792,
        128
      ],
      "webhookId": "2659b119-cda4-4175-9175-0bb2c061fb35",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "rniSgnqyp5rv9Xf9",
          "name": "Outlook (Lyros) - n8n OAuth (Exp 31/7/2026)"
        }
      }
    },
    {
      "parameters": {
        "toRecipients": "={{ $('C1 Config').item.json.email_config.admin_email }}",
        "subject": "=ğŸ”” New Family Tax Lead:{{ $('P5 build html email').item.json.original_contact.first_name }}  ({{ $('P5 build html email').item.json.meta.form_type }}) â€” {{ $('P5 build html email').item.json.report_meta.estimated_total_savings }}",
        "bodyContent": "=<b>New Lead</b><br><br>\n<b>Name:</b> {{ $('P5 build html email').item.json.original_contact.first_name }}<br>\n<b>Email:</b> {{ $('P5 build html email').item.json.original_contact.email }}<br>\n<b>State:</b> {{ $('P5 build html email').item.json.trigger.v1.household.state }}<br>\n<b>Income:</b> {{ $('P5 build html email').item.json.trigger.v1.income.household_income_range }}<br>\n<b>Form:</b> {{ $('P5 build html email').item.json.meta.form_type }}<br><br>\n<b>Top Opportunity:</b> {{ $('P5 build html email').item.json.report_meta.top_opportunity }}<br>\n<b>Est. Savings:</b> ${{ $('P5 build html email').item.json.report_meta.estimated_total_savings }}<br>\n<b>MLS At Risk:</b> {{ $('P5 build html email').item.json.report_meta.mls_at_risk }}<br>\n<b>Marketing Consent:</b> {{ $('P5 build html email').item.json.original_contact.consent_marketing }}<br><br>\n<b>L1 tokens:</b> {{ $('P5 build html email').item.json.token_usage.l1.total_tokens }}<br>\n<b>L2 tokens:</b> {{ $('P5 build html email').item.json.token_usage.l2.input_tokens + $('P5 build html email').item.json.token_usage.l2.output_tokens }}<br>\n<b>L3 tokens:</b> {{ $('P5 build html email').item.json.token_usage.l3.total_tokens }}",
        "additionalFields": {
          "from": "automations@lyros.com.au",
          "bodyContentType": "html"
        }
      },
      "id": "1fa169e3-0de5-479d-8a8b-5aa721dbcb57",
      "name": "X4 Send Lead Alert To Chris",
      "type": "n8n-nodes-base.microsoftOutlook",
      "typeVersion": 2,
      "position": [
        4000,
        128
      ],
      "webhookId": "2659b119-cda4-4175-9175-0bb2c061fb35",
      "credentials": {
        "microsoftOutlookOAuth2Api": {
          "id": "rniSgnqyp5rv9Xf9",
          "name": "Outlook (Lyros) - n8n OAuth (Exp 31/7/2026)"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "/**\n * PURPOSE\n * Extracts cost data for all 3 LLM calls (L1 GPT, L2 Claude, L3 GPT)\n * from the aggregated token_usage object. Returns 3 items for $ Execute Sub.\n *\n * INPUTS\n * - $input: X4 passthrough with token_usage.l1, .l2, .l3\n * - $('C1 Config'): llm_config for model names\n *\n * ADDITIONS\n * - 3 standardized cost rows matching $ Execute Sub schema\n *\n * ROW GUIDE\n * Input:  { token_usage: { l1: { prompt_tokens, completion_tokens, total_tokens }, l2: { input_tokens, output_tokens }, l3: { ... } } }\n * Output: [{ execution_id, provider, model, input_tokens, output_tokens, ... }, x3]\n *\n * ASSUMPTIONS\n * - L1/L3 are OpenAI format (prompt_tokens/completion_tokens)\n * - L2 is Anthropic format (input_tokens/output_tokens)\n * - $ Execute Sub calls wI8vl0LPoIbvdaVd\n *\n * AUDIT\n * Warnings logged per-call if tokens are zero.\n */\nconst NODE = '$ Cost Config L1';\nconst m = $input.item.json;\nconst config = $('C1 Config').item.json;\nconst tu = m.token_usage || {};\n\nconst calls = [\n  {\n    label: 'L1_classify',\n    provider: 'openai',\n    model: config.llm_config.classification_model,\n    input: tu.l1?.prompt_tokens || 0,\n    output: tu.l1?.completion_tokens || 0,\n    total: tu.l1?.total_tokens || 0\n  },\n  {\n    label: 'L2_analyse',\n    provider: 'anthropic',\n    model: config.llm_config.analysis_model,\n    input: tu.l2?.input_tokens || 0,\n    output: tu.l2?.output_tokens || 0,\n    total: (tu.l2?.input_tokens || 0) + (tu.l2?.output_tokens || 0)\n  },\n  {\n    label: 'L3_narrate',\n    provider: 'openai',\n    model: config.llm_config.narrative_model,\n    input: tu.l3?.prompt_tokens || 0,\n    output: tu.l3?.completion_tokens || 0,\n    total: tu.l3?.total_tokens || 0\n  }\n];\n\nreturn calls.map(c => ({\n  json: {\n    execution_id: $execution.id,\n    workflow_name: $workflow.name,\n    workflow_id: $workflow.id,\n    status: 'Success',\n    provider: c.provider,\n    model: c.model,\n    pricing_type: 'token',\n    input_tokens: c.input,\n    output_tokens: c.output,\n    total_tokens: c.total,\n    usage_quantity: c.total,\n    duration_seconds: 0,\n    binary_size_mb: 0,\n    _sample_data_id: c.label,\n    _extraction_warnings: c.total === 0 ? [`No tokens for ${c.label}`] : [],\n    _extraction_path: 'token'\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4240,
        128
      ],
      "id": "c5f227e5-c28b-45ad-b1c0-68d176cd5f43",
      "name": "V1 Universal Costing"
    }
  ],
  "pinData": {
    "T1 Webhook Form Submit": [
      {
        "json": {
          "headers": {
            "host": "n8n.lyroshq.com",
            "user-agent": "Mozilla/5.0 (iPhone; CPU iPhone OS 18_7 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/26.2 Mobile/15E148 Safari/604.1",
            "content-length": "1080",
            "accept": "*/*",
            "accept-encoding": "gzip, deflate, br",
            "accept-language": "en-NZ,en-AU;q=0.9,en;q=0.8",
            "content-type": "application/json",
            "origin": "https://www.lyros.com.au",
            "priority": "u=3, i",
            "referer": "https://www.lyros.com.au/",
            "sec-fetch-dest": "empty",
            "sec-fetch-mode": "cors",
            "sec-fetch-site": "cross-site",
            "via": "2.0 Caddy",
            "x-forwarded-for": "104.28.90.34",
            "x-forwarded-host": "n8n.lyroshq.com",
            "x-forwarded-proto": "https"
          },
          "params": {},
          "query": {},
          "body": {
            "state": "VIC",
            "relationship_status": "married",
            "num_dependants": "2",
            "dependant_ages": "2-4,5-12",
            "adult_ages": "30-54",
            "existing_benefits": "ftb_a,ccs",
            "household_income_range": "250k_plus",
            "income_split": "one_earner_dominant",
            "income_types": "salary,sole_trader,rental",
            "salary_sacrifice": "yes",
            "work_from_home": "1_2_days",
            "home_status": "renting",
            "investment_property": "yes_1",
            "shares_or_funds": "yes_50k_250k",
            "crypto": "no",
            "private_health": "hospital_extras",
            "first_name": "Example",
            "email": "example@lyros.com.au",
            "phone": "0400000000",
            "consent_marketing": "true",
            "consent_disclaimer": "true",
            "page_url": "https://www.lyros.com.au/family-tax",
            "super_balance_range": "200k_500k",
            "voluntary_contributions": "salary_sacrifice",
            "super_fund_type": "industry",
            "spouse_super_low": "no",
            "motor_vehicle_work": "over_5000km",
            "deduction_flags": "self_education,union_fees,income_protection",
            "donations": "5000_plus",
            "phi_cover_level": "gold",
            "phi_all_covered": "no",
            "childcare_type": "long_day_care,oshc",
            "childcare_days": "3",
            "child_disability": "no",
            "life_events": "changed_jobs,started_business,inheritance"
          },
          "webhookUrl": "https://n8n.lyroshq.com/webhook/family-tax-advisor",
          "executionMode": "production"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "L2 Claude Deep Tax Analysis": [
      {
        "json": {
          "model": "claude-sonnet-4-5-20250929",
          "id": "msg_01Y8RArxWwgowdvGcHHdHGWd",
          "type": "message",
          "role": "assistant",
          "content": [
            {
              "type": "text",
              "text": "```json\n{\n  \"opportunities\": [\n    {\n      \"category\": \"compliance\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Avoid Medicare Levy Surcharge â€” estimated $4,500 annual cost\",\n      \"applies_to\": \"Household\",\n      \"eligibility_reason\": \"Your estimated household income of $300,000 exceeds the MLS Tier 3 threshold ($168,000 for singles, $336,000 for families with 2 children). You currently have Gold hospital cover but not all household members are covered, which means the MLS applies at 1.5%.\",\n      \"description\": \"The Medicare Levy Surcharge (MLS) is an additional tax on high-income earners without appropriate private hospital insurance for all household members. You may be paying approximately $4,500 annually that could be avoided.\",\n      \"estimated_annual_value\": 4500,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated household income\", \"amount\": \"$300,000\"},\n        {\"label\": \"MLS Tier 3 rate (income >$168,000 singles / >$336,000 families)\", \"amount\": \"1.5%\"},\n        {\"label\": \"Estimated annual MLS cost\", \"amount\": \"$4,500\"}\n      ],\n      \"related_benefits\": [\n        \"Upgrading private hospital insurance to cover all household members eliminates this $4,500 annual cost\",\n        \"The cost of adding dependants to your Gold hospital cover is typically $1,500â€“$2,500 annually, resulting in net savings of $2,000â€“$3,000\"\n      ],\n      \"information_needed\": \"Current private health insurance policy details, including who is covered and annual premium cost. Quotes for family coverage from your current insurer.\",\n      \"how_to_claim\": \"1. Contact your private health insurer to add all household members to your Gold hospital cover (or higher)\\n2. Ensure coverage is in place for the full financial year to avoid MLS\\n3. Retain your certificate of insurance for tax return purposes\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/medicare-and-private-health-insurance/medicare-levy-surcharge\",\n      \"url_label\": \"Check MLS thresholds and requirements on the ATO\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"government_benefit\",\n      \"status\": \"optimise_existing\",\n      \"title\": \"Optimise Family Tax Benefit Part A â€” increase by approximately $2,900 annually\",\n      \"applies_to\": \"Household\",\n      \"eligibility_reason\": \"You are already claiming FTB A for your 2 children. Your estimated household income of $300,000 currently results in base rate FTB A only. Through strategic salary sacrifice to superannuation, you may reduce your assessable income for FTB purposes and increase your FTB A entitlement.\",\n      \"description\": \"Family Tax Benefit Part A provides fortnightly payments for families with dependent children. Your current entitlement is approximately $2,224 annually (base rate). By salary sacrificing approximately $50,000 to superannuation, you could reduce your assessable income to approximately $250,000, increasing your FTB A to approximately $5,100 annually â€” an increase of approximately $2,900.\",\n      \"estimated_annual_value\": 2900,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Current estimated FTB A (base rate, 2 children)\", \"amount\": \"$2,224\"},\n        {\"label\": \"Potential FTB A with reduced assessable income\", \"amount\": \"$5,100\"},\n        {\"label\": \"FTB A maximum rate (child 0â€“4: $5,773.04, child 5â€“12: $5,773.04)\", \"amount\": \"$11,546.08\"},\n        {\"label\": \"â€“ Income test reduction ($250,000 â€“ $117,390) Ã— 0.30 Ã— 2\", \"amount\": \"â€“$79,566\"},\n        {\"label\": \"Base rate applies ($71.26/fn Ã— 26 Ã— 2)\", \"amount\": \"$3,705.52\"},\n        {\"label\": \"+ Optimisation through salary sacrifice (~$50k)\", \"amount\": \"+$2,900\"},\n        {\"label\": \"Estimated optimised annual FTB A\", \"amount\": \"$5,100\"}\n      ],\n      \"related_benefits\": [\n        \"Salary sacrifice to super reduces assessable income, increasing FTB A entitlement\",\n        \"Salary sacrifice also provides superannuation tax concessions (see separate opportunity)\",\n        \"Reduced assessable income may also increase Child Care Subsidy percentage\"\n      ],\n      \"information_needed\": \"Current salary sacrifice arrangements, employer's willingness to increase salary sacrifice, confirmation of current FTB A payments received, household budget capacity to absorb reduced take-home pay.\",\n      \"how_to_claim\": \"1. Arrange increased salary sacrifice with your employer (approximately $50,000 annually)\\n2. Update your income estimate with Services Australia via myGov\\n3. Services Australia will automatically recalculate your FTB A entitlement based on your revised income estimate\",\n      \"url\": \"https://www.servicesaustralia.gov.au/income-estimate-for-family-assistance-and-child-care-subsidy-payments\",\n      \"url_label\": \"Update your income estimate on Services Australia\",\n      \"affordability_warning\": \"This strategy reduces fortnightly take-home pay by approximately $1,923 ($50,000 Ã· 26 fortnights). The FTB A increase of approximately $112 per fortnight partially offsets this, but you will still see a net reduction of approximately $1,811 per fortnight in immediate cash flow. The remaining benefit ($1,811 Ã— 26 = $47,086 annually) is locked in superannuation until preservation age (currently 60). Consider whether your household budget can absorb this reduction.\",\n      \"affordability_flag\": true\n    },\n    {\n      \"category\": \"government_benefit\",\n      \"status\": \"confirm_existing\",\n      \"title\": \"Confirm Child Care Subsidy â€” estimated $24,570 annual value\",\n      \"applies_to\": \"Household\",\n      \"eligibility_reason\": \"You are already claiming Child Care Subsidy (CCS) for your 2 children. With an estimated household income of $300,000, your subsidy percentage is approximately 47%. This analysis confirms your current entitlement and identifies potential optimisation through income reduction strategies.\",\n      \"description\": \"Child Care Subsidy helps with the cost of approved childcare. Your current subsidy percentage is approximately 47% based on your estimated income. You have one child aged 2â€“4 using long day care (3 days/week) and one child aged 5â€“12 using Outside School Hours Care (OSHC, 3 days/week). The annual value of your subsidy is approximately $24,570.\",\n      \"estimated_annual_value\": 24570,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Child 1 (aged 2â€“4): Long day care\", \"amount\": \"\"},\n        {\"label\": \"  Hourly cap (centre-based)\", \"amount\": \"$13.73\"},\n        {\"label\": \"  Hours per session (typical)\", \"amount\": \"10 hours\"},\n        {\"label\": \"  Sessions per week\", \"amount\": \"3 days\"},\n        {\"label\": \"  Annual sessions (3 days Ã— 48 weeks)\", \"amount\": \"144 sessions\"},\n        {\"label\": \"  Total annual hours (144 Ã— 10)\", \"amount\": \"1,440 hours\"},\n        {\"label\": \"  Maximum annual cost (1,440 Ã— $13.73)\", \"amount\": \"$19,771\"},\n        {\"label\": \"  CCS subsidy percentage (income $300,000)\", \"amount\": \"47%\"},\n        {\"label\": \"  Child 1 CCS value (47% Ã— $19,771)\", \"amount\": \"$9,292\"},\n        {\"label\": \"Child 2 (aged 5â€“12): OSHC\", \"amount\": \"\"},\n        {\"label\": \"  Hourly cap (OSHC)\", \"amount\": \"$13.41\"},\n        {\"label\": \"  Hours per session (before/after school)\", \"amount\": \"3.5 hours\"},\n        {\"label\": \"  Sessions per week (school term)\", \"amount\": \"3 days\"},\n        {\"label\": \"  Annual sessions (3 days Ã— 40 school weeks)\", \"amount\": \"120 sessions\"},\n        {\"label\": \"  Total annual hours (120 Ã— 3.5)\", \"amount\": \"420 hours\"},\n        {\"label\": \"  Maximum annual cost (420 Ã— $13.41)\", \"amount\": \"$5,632\"},\n        {\"label\": \"  CCS subsidy percentage (income $300,000)\", \"amount\": \"47%\"},\n        {\"label\": \"  Child 2 CCS value (47% Ã— $5,632)\", \"amount\": \"$2,647\"},\n        {\"label\": \"+ Vacation care (estimated 4 weeks, 8hrs/day, 5 days/week)\", \"amount\": \"\"},\n        {\"label\": \"  Vacation care hours (4 weeks Ã— 5 days Ã— 8 hours)\", \"amount\": \"160 hours\"},\n        {\"label\": \"  Maximum cost (160 Ã— $13.41)\", \"amount\": \"$2,146\"},\n        {\"label\": \"  CCS value (47% Ã— $2,146)\", \"amount\": \"$1,009\"},\n        {\"label\": \"Total CCS subsidy value (Child 1 + Child 2 + vacation care)\", \"amount\": \"$12,948\"},\n        {\"label\": \"+ Potential increase through salary sacrifice optimisation\", \"amount\": \"+$11,622\"},\n        {\"label\": \"Estimated total annual CCS value\", \"amount\": \"$24,570\"}\n      ],\n      \"related_benefits\": [\n        \"Reducing assessable income through salary sacrifice increases CCS subsidy percentage â€” every $5,000 reduction in income increases subsidy by 1%\",\n        \"With salary sacrifice of $50,000, your income would reduce to $250,000, increasing subsidy percentage from 47% to 57% (10 percentage points)\",\n        \"This would increase your annual CCS value by approximately $11,622 (from $12,948 to $24,570)\"\n      ],\n      \"information_needed\": \"Actual childcare fees paid (may differ from hourly caps), current CCS percentage received, confirmation of childcare days and hours per week, vacation care usage.\",\n      \"how_to_claim\": \"1. Confirm your current income estimate is accurate via myGov\\n2. If you implement salary sacrifice strategies, update your income estimate with Services Australia\\n3. Services Australia will automatically recalculate your CCS percentage based on your revised income\",\n      \"url\": \"https://www.servicesaustralia.gov.au/child-care-subsidy\",\n      \"url_label\": \"Check your CCS entitlement on Services Australia\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"superannuation\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Salary sacrifice to superannuation â€” estimated $23,500 annual tax saving\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You are already salary sacrificing to superannuation. With an estimated income of $300,000 and a marginal tax rate of 45% (plus 2% Medicare Levy), you may benefit from maximising concessional contributions up to the $30,000 cap. Your super balance is between $200,000â€“$500,000, making you eligible for carry-forward unused concessional contributions from previous years.\",\n      \"description\": \"Salary sacrifice allows you to contribute pre-tax income to superannuation, taxed at 15% instead of your marginal rate of 47%. By maximising your concessional contributions to $30,000 annually (including employer Superannuation Guarantee), you may save approximately $23,500 in tax. However, you face Div 293 tax (additional 15% on super contributions) due to your high income, reducing the net benefit.\",\n      \"estimated_annual_value\": 23500,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated income (primary earner)\", \"amount\": \"$300,000\"},\n        {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n        {\"label\": \"Concessional contributions cap\", \"amount\": \"$30,000\"},\n        {\"label\": \"Employer SG (12% Ã— $300,000, capped at $30,000)\", \"amount\": \"$30,000\"},\n        {\"label\": \"Available salary sacrifice capacity\", \"amount\": \"$0\"},\n        {\"label\": \"Note: Already at concessional cap via SG\", \"amount\": \"\"},\n        {\"label\": \"Alternative: Use carry-forward unused cap\", \"amount\": \"\"},\n        {\"label\": \"Carry-forward available (if TSB <$500k)\", \"amount\": \"Eligible\"},\n        {\"label\": \"Potential additional contribution (using carry-forward)\", \"amount\": \"$50,000\"},\n        {\"label\": \"Tax saving on additional contribution (47% â€“ 15%)\", \"amount\": \"32%\"},\n        {\"label\": \"Gross tax saving ($50,000 Ã— 32%)\", \"amount\": \"$16,000\"},\n        {\"label\": \"â€“ Div 293 additional tax (15% on $50,000)\", \"amount\": \"â€“$7,500\"},\n        {\"label\": \"Net tax saving after Div 293\", \"amount\": \"$8,500\"},\n        {\"label\": \"+ FTB A increase from reduced assessable income\", \"amount\": \"+$2,900\"},\n        {\"label\": \"+ CCS increase from reduced assessable income\", \"amount\": \"+$11,622\"},\n        {\"label\": \"+ MLS saving (if PHI upgraded)\", \"amount\": \"+$4,500\"},\n        {\"label\": \"Estimated total annual benefit (immediate + long-term)\", \"amount\": \"$27,522\"},\n        {\"label\": \"Immediate household benefit (FTB A + CCS + MLS)\", \"amount\": \"$19,022\"},\n        {\"label\": \"Long-term wealth building (super tax saving, locked until age 60)\", \"amount\": \"$8,500\"}\n      ],\n      \"related_benefits\": [\n        \"Reduces assessable income, which may increase FTB A by approximately $2,900\",\n        \"Reduces assessable income, which may increase CCS subsidy percentage from 47% to 57%, increasing annual CCS value by approximately $11,622\",\n        \"Reduced assessable income may allow you to drop below MLS Tier 3 threshold, saving $4,500 if combined with PHI upgrade\",\n        \"Carry-forward unused concessional cap from previous years (if total super balance <$500,000 on 30 June prior year)\"\n      ],\n      \"information_needed\": \"Total super balance as at 30 June 2024 (to confirm carry-forward eligibility), unused concessional cap amounts from FY2018-19 onwards, current salary sacrifice amount, employer's capacity to increase salary sacrifice, household budget capacity.\",\n      \"how_to_claim\": \"1. Confirm your total super balance as at 30 June 2024 is below $500,000 (required for carry-forward)\\n2. Request a statement from the ATO showing your unused concessional cap amounts from previous years\\n3. Arrange increased salary sacrifice with your employer to utilise carry-forward cap\\n4. Update your income estimate with Services Australia to trigger FTB A and CCS recalculations\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/super/growing-and-keeping-track-of-your-super/how-to-save-more-in-your-super/salary-sacrificing-super\",\n      \"url_label\": \"Learn about salary sacrificing to super on the ATO\",\n      \"affordability_warning\": \"This strategy reduces fortnightly take-home pay by approximately $1,923 ($50,000 Ã· 26 fortnights). The immediate household benefits (FTB A increase $112/fn + CCS increase $447/fn + MLS saving $173/fn = $732/fn) partially offset this, resulting in a net reduction of approximately $1,191 per fortnight in immediate cash flow. The remaining benefit ($8,500 super tax saving) is locked in superannuation until preservation age (currently 60). Consider whether your household budget can absorb this reduction.\",\n      \"affordability_flag\": true\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Motor vehicle work deduction â€” estimated $4,400 annual deduction ($2,068 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have indicated motor vehicle work use exceeding 5,000km annually. With a marginal tax rate of 47%, you may claim a deduction using either the cents per kilometre method (capped at 5,000km) or the logbook method (if work use exceeds 50% and total vehicle costs are high).\",\n      \"description\": \"You may claim a tax deduction for work-related motor vehicle expenses. The cents per kilometre method allows you to claim 88 cents per kilometre for up to 5,000km without detailed records. This provides a maximum deduction of $4,400, resulting in a tax saving of approximately $2,068 at your marginal rate.\",\n      \"estimated_annual_value\": 2068,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Method 1: Cents per kilometre\", \"amount\": \"\"},\n        {\"label\": \"  Maximum claimable kilometres\", \"amount\": \"5,000 km\"},\n        {\"label\": \"  Rate per kilometre (FY2025-26)\", \"amount\": \"$0.88\"},\n        {\"label\": \"  Maximum deduction (5,000 Ã— $0.88)\", \"amount\": \"$4,400\"},\n        {\"label\": \"  Tax saving (47% Ã— $4,400)\", \"amount\": \"$2,068\"},\n        {\"label\": \"Method 2: Logbook method\", \"amount\": \"\"},\n        {\"label\": \"  Requires: 12-week logbook, all vehicle expense records\", \"amount\": \"\"},\n        {\"label\": \"  Example: Total vehicle costs $15,000, work use 40%\", \"amount\": \"\"},\n        {\"label\": \"  Deduction ($15,000 Ã— 40%)\", \"amount\": \"$6,000\"},\n        {\"label\": \"  Tax saving (47% Ã— $6,000)\", \"amount\": \"$2,820\"},\n        {\"label\": \"Recommended method: Cents per km (unless logbook shows >50% work use)\", \"amount\": \"\"},\n        {\"label\": \"Estimated annual tax saving (cents per km method)\", \"amount\": \"$2,068\"}\n      ],\n      \"related_benefits\": [\n        \"If your actual vehicle costs exceed $17,500 annually and work use exceeds 50%, the logbook method may provide a higher deduction\",\n        \"Logbook method requires maintaining a 12-week logbook and retaining all vehicle expense receipts (fuel, insurance, registration, servicing, depreciation)\"\n      ],\n      \"information_needed\": \"Estimate of work-related kilometres driven (if using cents per km method), or comprehensive vehicle expense records and 12-week logbook (if using logbook method).\",\n      \"how_to_claim\": \"1. Calculate your work-related kilometres for the financial year (must be reasonable estimate)\\n2. Claim the deduction in your tax return using the cents per kilometre method (up to 5,000km)\\n3. Alternatively, if you maintain a logbook and have higher vehicle costs, calculate using the logbook method and claim the higher amount\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/transport-and-travel-expenses/car-expenses\",\n      \"url_label\": \"Claim car expenses via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Charitable donations deduction â€” estimated $5,000+ deduction ($2,350+ tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have indicated charitable donations of $5,000 or more annually. Donations to Deductible Gift Recipients (DGRs) are 100% tax deductible at your marginal rate of 47%.\",\n      \"description\": \"Donations to registered charities and DGRs are fully tax deductible. With donations of $5,000 or more, you may claim a tax deduction resulting in a tax saving of approximately $2,350 (assuming $5,000 donated). Ensure all donations are to DGR-registered organisations and you retain receipts.\",\n      \"estimated_annual_value\": 2350,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated annual donations\", \"amount\": \"$5,000\"},\n        {\"label\": \"Deduction percentage (DGR-registered charities)\", \"amount\": \"100%\"},\n        {\"label\": \"Tax deduction\", \"amount\": \"$5,000\"},\n        {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $5,000)\", \"amount\": \"$2,350\"}\n      ],\n      \"related_benefits\": [\n        \"If you donate more than $5,000, your tax saving increases proportionally (e.g. $10,000 donation = $4,700 tax saving)\",\n        \"Consider workplace giving programs which allow pre-tax donations via salary sacrifice, providing immediate tax benefit\"\n      ],\n      \"information_needed\": \"Receipts for all donations showing the charity's DGR status, total amount donated during FY2025-26.\",\n      \"how_to_claim\": \"1. Verify all charities you donated to are registered DGRs (check ABN Lookup)\\n2. Gather all donation receipts showing amounts and dates\\n3. Claim the total deduction in your tax return via myTax\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/gifts-and-donations\",\n      \"url_label\": \"Claim donation deductions via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Investment property deductions â€” estimated $8,000â€“$15,000 annual deduction ($3,760â€“$7,050 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You own one investment property generating rental income. You may claim deductions for all expenses incurred in earning that rental income, including interest on loans, property management fees, council rates, insurance, repairs and maintenance, and depreciation.\",\n      \"description\": \"Investment property expenses are fully deductible against your rental income (and other income if negatively geared). Common deductions include loan interest, property management fees (typically 6-8% of rent), council rates, insurance, repairs and maintenance, and depreciation on building and fixtures. Estimated total deductions range from $8,000 to $15,000 annually, depending on your property's loan amount and expenses.\",\n      \"estimated_annual_value\": 5405,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated loan interest (assuming $500k loan at 6.5%)\", \"amount\": \"$32,500\"},\n        {\"label\": \"Property management fees (7% of $30k annual rent)\", \"amount\": \"$2,100\"},\n        {\"label\": \"Council rates\", \"amount\": \"$2,000\"},\n        {\"label\": \"Landlord insurance\", \"amount\": \"$800\"},\n        {\"label\": \"Repairs and maintenance (average)\", \"amount\": \"$2,000\"},\n        {\"label\": \"Depreciation (building + fixtures, average)\", \"amount\": \"$5,000\"},\n        {\"label\": \"Total estimated deductions\", \"amount\": \"$44,400\"},\n        {\"label\": \"Less: Rental income received\", \"amount\": \"â€“$30,000\"},\n        {\"label\": \"Net rental loss (negative gearing)\", \"amount\": \"$14,400\"},\n        {\"label\": \"Tax saving on net loss (47% Ã— $14,400)\", \"amount\": \"$6,768\"},\n        {\"label\": \"Conservative estimate (if lower expenses)\", \"amount\": \"$8,000\"},\n        {\"label\": \"Tax saving on conservative estimate (47% Ã— $8,000)\", \"amount\": \"$3,760\"},\n        {\"label\": \"Mid-range estimate (average scenario)\", \"amount\": \"$11,500\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $11,500)\", \"amount\": \"$5,405\"}\n      ],\n      \"related_benefits\": [\n        \"Depreciation deductions do not require cash outlay â€” they are non-cash deductions based on the property's building and fixtures\",\n        \"Consider obtaining a depreciation schedule from a quantity surveyor (cost $500â€“$800) to maximise depreciation claims\",\n        \"Capital works deductions (2.5% of building cost per year for 40 years) apply to buildings constructed after 1987\"\n      ],\n      \"information_needed\": \"Loan statements showing interest paid, property management statements, council rates notices, insurance policies, receipts for repairs and maintenance, depreciation schedule (if available), rental income received.\",\n      \"how_to_claim\": \"1. Gather all investment property expense records for FY2025-26\\n2. If you don't have a depreciation schedule, consider engaging a quantity surveyor\\n3. Complete the rental property schedule in your tax return via myTax or through a registered tax agent\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/residential-rental-properties\",\n      \"url_label\": \"Claim rental property deductions via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Work from home deduction â€” estimated $268 annual deduction ($126 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You work from home 1â€“2 days per week. Using the ATO's fixed rate method (67 cents per hour), you may claim a deduction for electricity, phone, internet, and stationery costs incurred while working from home.\",\n      \"description\": \"The ATO's fixed rate method allows you to claim 67 cents per hour for each hour worked from home, covering electricity, phone, internet, and stationery. Based on 1â€“2 days per week (approximately 8 hours per week, 50 weeks per year = 400 hours), your estimated deduction is $268, resulting in a tax saving of approximately $126.\",\n      \"estimated_annual_value\": 126,\n      \"confidence\": \"high\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated hours worked from home per week\", \"amount\": \"8 hours\"},\n        {\"label\": \"Weeks worked per year\", \"amount\": \"50 weeks\"},\n        {\"label\": \"Total hours worked from home\", \"amount\": \"400 hours\"},\n        {\"label\": \"Fixed rate per hour (FY2025-26)\", \"amount\": \"$0.67\"},\n        {\"label\": \"Total deduction (400 Ã— $0.67)\", \"amount\": \"$268\"},\n        {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $268)\", \"amount\": \"$126\"}\n      ],\n      \"related_benefits\": [\n        \"If you work from home more frequently, your deduction increases proportionally (e.g. 3 days/week = 600 hours = $402 deduction = $189 tax saving)\",\n        \"The fixed rate method is simple and does not require detailed records of actual expenses â€” only a record of hours worked from home\"\n      ],\n      \"information_needed\": \"Record of hours worked from home during FY2025-26 (diary, timesheet, or roster).\",\n      \"how_to_claim\": \"1. Maintain a record of hours worked from home (diary, timesheet, or roster)\\n2. Calculate total hours worked from home for the financial year\\n3. Claim the deduction in your tax return using the fixed rate method (67c per hour)\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/home-office-expenses\",\n      \"url_label\": \"Claim work from home deductions via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Self-education expenses deduction â€” estimated $2,000â€“$5,000 deduction ($940â€“$2,350 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have flagged self-education expenses. If your course maintains or improves skills required in your current employment, you may claim course fees, textbooks, travel to and from classes, and home office expenses related to study.\",\n      \"description\": \"Self-education expenses are deductible if the course maintains or improves skills required in your current employment, or is likely to lead to increased income from your current employment. Deductible expenses include course fees, textbooks, stationery, travel to classes, and depreciation on equipment (e.g. laptop). The first $250 of self-education expenses is not deductible.\",\n      \"estimated_annual_value\": 1645,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated course fees\", \"amount\": \"$3,000\"},\n        {\"label\": \"Textbooks and materials\", \"amount\": \"$500\"},\n        {\"label\": \"Travel to and from classes (cents per km)\", \"amount\": \"$300\"},\n        {\"label\": \"Home office expenses (study time)\", \"amount\": \"$200\"},\n        {\"label\": \"Total self-education expenses\", \"amount\": \"$4,000\"},\n        {\"label\": \"â€“ Non-deductible threshold\", \"amount\": \"â€“$250\"},\n        {\"label\": \"Deductible amount\", \"amount\": \"$3,750\"},\n        {\"label\": \"Conservative estimate\", \"amount\": \"$2,000\"},\n        {\"label\": \"Tax saving on conservative estimate (47% Ã— $2,000)\", \"amount\": \"$940\"},\n        {\"label\": \"Mid-range estimate\", \"amount\": \"$3,500\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $3,500)\", \"amount\": \"$1,645\"}\n      ],\n      \"related_benefits\": [\n        \"If your course leads to a new profession or is not related to your current employment, it is generally not deductible\",\n        \"HELP/HECS fees are not deductible as they are repaid through the tax system once your income exceeds the repayment threshold\"\n      ],\n      \"information_needed\": \"Course enrolment confirmation showing course name and fees, receipts for textbooks and materials, travel records (if claiming travel), evidence that the course relates to your current employment.\",\n      \"how_to_claim\": \"1. Gather all self-education expense records (course fees, textbooks, travel)\\n2. Confirm the course maintains or improves skills required in your current employment\\n3. Claim the deduction in your tax return (total expenses minus $250 threshold)\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/self-education-expenses\",\n      \"url_label\": \"Claim self-education deductions via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Union fees and professional memberships â€” estimated $500â€“$1,500 deduction ($235â€“$705 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have flagged union fees and professional membership expenses. These are 100% deductible if they relate to your current employment.\",\n      \"description\": \"Union fees and professional membership fees are fully deductible if they relate to your current employment. This includes union membership fees, professional association fees (e.g. CPA, Engineers Australia, Law Society), and subscriptions to professional journals.\",\n      \"estimated_annual_value\": 470,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated union fees\", \"amount\": \"$600\"},\n        {\"label\": \"Professional membership fees\", \"amount\": \"$400\"},\n        {\"label\": \"Total deductible fees\", \"amount\": \"$1,000\"},\n        {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $1,000)\", \"amount\": \"$470\"}\n      ],\n      \"related_benefits\": [\n        \"If you hold multiple professional memberships, all are deductible if they relate to your current employment\",\n        \"Subscriptions to professional journals and industry publications are also deductible\"\n      ],\n      \"information_needed\": \"Receipts or tax statements from your union and professional associations showing fees paid during FY2025-26.\",\n      \"how_to_claim\": \"1. Gather receipts or tax statements from your union and professional associations\\n2. Claim the total deduction in your tax return via myTax\\n3. Many unions and professional bodies provide an annual tax statement summarising fees paid\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/other-work-related-deductions\",\n      \"url_label\": \"Claim union and professional fees via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"tax_deduction\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Income protection insurance premiums â€” estimated $1,500â€“$3,000 deduction ($705â€“$1,410 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have flagged income protection insurance. Premiums for income protection insurance are 100% tax deductible, as the policy provides income replacement if you are unable to work due to illness or injury.\",\n      \"description\": \"Income protection insurance premiums are fully deductible because the policy provides taxable income if you make a claim. This differs from trauma or TPD insurance (not deductible). With estimated premiums of $1,500â€“$3,000 annually, your tax saving is approximately $705â€“$1,410.\",\n      \"estimated_annual_value\": 1058,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Estimated annual income protection premiums\", \"amount\": \"$2,250\"},\n        {\"label\": \"Deduction percentage\", \"amount\": \"100%\"},\n        {\"label\": \"Tax deduction\", \"amount\": \"$2,250\"},\n        {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $2,250)\", \"amount\": \"$1,058\"}\n      ],\n      \"related_benefits\": [\n        \"Income protection insurance provides up to 75% of your income (tax-free during the waiting period, then taxable) if you cannot work due to illness or injury\",\n        \"Premiums are typically lower if held within superannuation, but super-held policies may have different definitions and waiting periods\"\n      ],\n      \"information_needed\": \"Annual statement from your income protection insurer showing premiums paid during FY2025-26. Confirm the policy is income protection (not trauma or TPD).\",\n      \"how_to_claim\": \"1. Obtain your annual insurance statement showing premiums paid\\n2. Confirm the policy is income protection insurance (not trauma, TPD, or life insurance)\\n3. Claim the full premium amount in your tax return via myTax\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/other-work-related-deductions\",\n      \"url_label\": \"Claim income protection premiums via ATO myTax\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"investment\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Shares and managed funds â€” capital gains tax planning\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You hold shares or managed funds valued between $50,000â€“$250,000. Strategic capital gains tax (CGT) planning may reduce your tax liability when you sell investments.\",\n      \"description\": \"Capital gains on shares and managed funds are taxed at your marginal rate, but you receive a 50% CGT discount if you hold the asset for more than 12 months. With a marginal rate of 47%, your effective CGT rate is 23.5% on discounted gains. Consider timing asset sales to minimise tax, utilising capital losses to offset gains, and holding assets for >12 months to access the discount.\",\n      \"estimated_annual_value\": 0,\n      \"confidence\": \"low\",\n      \"calculation_rows\": [\n        {\"label\": \"Example: Sale of shares with $50,000 capital gain\", \"amount\": \"\"},\n        {\"label\": \"  Held >12 months: 50% CGT discount applies\", \"amount\": \"\"},\n        {\"label\": \"  Taxable capital gain ($50,000 Ã— 50%)\", \"amount\": \"$25,000\"},\n        {\"label\": \"  Tax payable (47% Ã— $25,000)\", \"amount\": \"$11,750\"},\n        {\"label\": \"  Effective CGT rate\", \"amount\": \"23.5%\"},\n        {\"label\": \"Held <12 months: No CGT discount\", \"amount\": \"\"},\n        {\"label\": \"  Taxable capital gain\", \"amount\": \"$50,000\"},\n        {\"label\": \"  Tax payable (47% Ã— $50,000)\", \"amount\": \"$23,500\"},\n        {\"label\": \"  Tax saving by holding >12 months\", \"amount\": \"$11,750\"}\n      ],\n      \"related_benefits\": [\n        \"Capital losses can be offset against capital gains in the same year, or carried forward indefinitely to offset future gains\",\n        \"Consider selling loss-making investments before 30 June to crystallise losses and offset gains\",\n        \"Dividend income from Australian shares may include franking credits, reducing your tax liability\"\n      ],\n      \"information_needed\": \"Portfolio holdings, purchase dates and costs, unrealised gains and losses, dividend statements showing franking credits.\",\n      \"how_to_claim\": \"1. Review your share portfolio to identify unrealised gains and losses\\n2. Consider timing of asset sales to maximise CGT discount and utilise capital losses\\n3. Report capital gains and losses in your tax return via myTax or through a registered tax agent\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/shares-and-similar-investments\",\n      \"url_label\": \"Learn about CGT on shares via the ATO\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    },\n    {\n      \"category\": \"investment\",\n      \"status\": \"new_opportunity\",\n      \"title\": \"Sole trader business deductions â€” estimated $5,000â€“$15,000 deduction ($2,350â€“$7,050 tax saving)\",\n      \"applies_to\": \"Primary earner\",\n      \"eligibility_reason\": \"You have started a sole trader business (life event: started_business). As a sole trader, you may claim deductions for all expenses incurred in earning your business income, including home office expenses, equipment, professional fees, insurance, and motor vehicle expenses.\",\n      \"description\": \"Sole traders can claim deductions for all expenses incurred in earning business income. Common deductions include home office expenses (portion of rent/mortgage interest, utilities, internet), equipment and tools, professional fees (accountant, lawyer), business insurance, motor vehicle expenses (business use percentage), and depreciation on assets. Estimated deductions range from $5,000 to $15,000 depending on your business expenses.\",\n      \"estimated_annual_value\": 4700,\n      \"confidence\": \"medium\",\n      \"calculation_rows\": [\n        {\"label\": \"Home office expenses (20% of $15,000 annual costs)\", \"amount\": \"$3,000\"},\n        {\"label\": \"Equipment and tools (laptop, phone, software)\", \"amount\": \"$2,000\"},\n        {\"label\": \"Professional fees (accountant, legal)\", \"amount\": \"$2,500\"},\n        {\"label\": \"Business insurance\", \"amount\": \"$1,200\"},\n        {\"label\": \"Motor vehicle expenses (business use 30% of $10,000)\", \"amount\": \"$3,000\"},\n        {\"label\": \"Marketing and advertising\", \"amount\": \"$1,500\"},\n        {\"label\": \"Total estimated business deductions\", \"amount\": \"$13,200\"},\n        {\"label\": \"Conservative estimate\", \"amount\": \"$10,000\"},\n        {\"label\": \"Estimated tax saving (47% Ã— $10,000)\", \"amount\": \"$4,700\"}\n      ],\n      \"related_benefits\": [\n        \"If your business turnover exceeds $75,000, you must register for GST and can claim GST credits on business expenses\",\n        \"Consider establishing a company or trust structure if business income is substantial, to access lower tax rates and asset protection\",\n        \"Sole trader business losses can be offset against your salary income, reducing your overall tax liability\"\n      ],\n      \"information_needed\": \"Business income and expense records, invoices and receipts, home office usage records, motor vehicle logbook (if claiming vehicle expenses), equipment purchase receipts.\",\n      \"how_to_claim\": \"1. Maintain detailed records of all business income and expenses throughout the year\\n2. Calculate your business profit or loss (income minus expenses)\\n3. Report business income and deductions in your tax return via myTax or through a registered tax agent\",\n      \"url\": \"https://www.ato.gov.au/business/starting-your-own-business\",\n      \"url_label\": \"Learn about sole trader deductions via the ATO\",\n      \"affordability_warning\": null,\n      \"affordability_flag\": false\n    }\n  ],\n  \"risk_flags\": [\n    {\n      \"type\": \"Medicare Levy Surcharge â€” not all household members covered\",\n      \"severity\": \"high\",\n      \"description\": \"You have Gold private hospital insurance but not all household members are covered. This means the Medicare Levy Surcharge (MLS) applies at 1.5% of your estimated household income of $300,000, costing approximately $4,500 annually. Upgrading to family coverage would eliminate this cost.\",\n      \"estimated_annual_cost\": 4500,\n      \"calculation_rows\": [\n        {\"label\": \"Estimated household income\", \"amount\": \"$300,000\"},\n        {\"label\": \"MLS Tier 3 rate (income >$168,000 singles / >$336,000 families)\", \"amount\": \"1.5%\"},\n        {\"label\": \"Estimated annual MLS cost\", \"amount\": \"$4,500\"},\n        {\"label\": \"Typical cost to add dependants to Gold cover\", \"amount\": \"$1,500â€“$2,500\"},\n        {\"label\": \"Net annual saving\", \"amount\": \"$2,000â€“$3,000\"}\n      ],\n      \"action\": \"Contact your private health insurer to add all household members to your Gold hospital cover. Ensure coverage is in place for the full financial year to avoid MLS. Compare policies using the government's Private Health Insurance Ombudsman comparator tool.\",\n      \"url\": \"https://www.privatehealth.gov.au/\",\n      \"url_label\": \"Compare private health insurance policies\"\n    },\n    {\n      \"type\": \"Division 293 tax â€” additional 15% on super contributions\",\n      \"severity\": \"medium\",\n      \"description\": \"With an estimated income of $300,000 plus superannuation contributions, your combined income exceeds $250,000, triggering Division 293 tax. This is an additional 15% tax on concessional super contributions (on top of the standard 15% contributions tax), effectively taxing super contributions at 30% instead of 15%. This reduces the tax benefit of salary sacrificing to super.\",\n      \"estimated_annual_cost\": 4500,\n      \"calculation_rows\": [\n        {\"label\": \"Estimated income\", \"amount\": \"$300,000\"},\n        {\"label\": \"+ Concessional super contributions\", \"amount\": \"$30,000\"},\n        {\"label\": \"Combined income for Div 293 purposes\", \"amount\": \"$330,000\"},\n        {\"label\": \"Div 293 threshold\", \"amount\": \"$250,000\"},\n        {\"label\": \"Excess over threshold\", \"amount\": \"$80,000\"},\n        {\"label\": \"Div 293 tax (15% on concessional contributions capped at excess)\", \"amount\": \"\"},\n        {\"label\": \"Div 293 tax payable (15% Ã— $30,000)\", \"amount\": \"$4,500\"}\n      ],\n      \"action\": \"Be aware that your super contributions are taxed at 30% (15% contributions tax + 15% Div 293 tax) rather than the standard 15%. This reduces the tax benefit of salary sacrifice from 32% (47% marginal rate â€“ 15% super tax) to 17% (47% â€“ 30%). You may choose to pay the Div 293 tax from your super account or personally. Consider whether the reduced tax benefit still makes salary sacrifice worthwhile, particularly given the benefit to FTB A and CCS from reduced assessable income.\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/super/in-detail/growing-your-super/division-293-tax\",\n      \"url_label\": \"Learn about Division 293 tax on the ATO\"\n    },\n    {\n      \"type\": \"Sole trader business structure â€” consider company or trust\",\n      \"severity\": \"low\",\n      \"description\": \"You have started a sole trader business. While this is the simplest business structure, it may not be the most tax-effective or provide asset protection as your business grows. Sole traders pay tax at personal marginal rates (up to 47%), whereas companies pay a flat 25% (if base rate entity) or 30%. Additionally, sole traders have unlimited personal liability for business debts.\",\n      \"estimated_annual_cost\": 0,\n      \"calculation_rows\": [\n        {\"label\": \"Example: $50,000 business profit as sole trader\", \"amount\": \"\"},\n        {\"label\": \"  Tax payable (47% marginal rate)\", \"amount\": \"$23,500\"},\n        {\"label\": \"Example: $50,000 business profit via company\", \"amount\": \"\"},\n        {\"label\": \"  Company tax (30%)\", \"amount\": \"$15,000\"},\n        {\"label\": \"  Potential tax saving\", \"amount\": \"$8,500\"},\n        {\"label\": \"Note: Extracting profit as dividends triggers personal tax\", \"amount\": \"\"}\n      ],\n      \"action\": \"As your business grows, consider engaging an accountant or business adviser to review your business structure. A company or trust structure may provide tax benefits and asset protection, but involves higher setup and compliance costs. This decision depends on your business income, growth plans, and personal circumstances.\",\n      \"url\": \"https://www.ato.gov.au/business/starting-your-own-business/business-structures\",\n      \"url_label\": \"Learn about business structures on the ATO\"\n    },\n    {\n      \"type\": \"Investment property negative gearing â€” cash flow impact\",\n      \"severity\": \"low\",\n      \"description\": \"If your investment property is negatively geared (rental income less than expenses), you will experience a cash flow shortfall that must be funded from your salary or other income. While negative gearing provides tax benefits (deductions offset against your high marginal rate), ensure you have sufficient cash flow to cover the shortfall.\",\n      \"estimated_annual_cost\": 0,\n      \"calculation_rows\": [\n        {\"label\": \"Example: Rental income\", \"amount\": \"$30,000\"},\n        {\"label\": \"â€“ Total property expenses (interest, rates, insurance, etc.)\", \"amount\": \"â€“$44,400\"},\n        {\"label\": \"Net rental loss (negative gearing)\", \"amount\": \"â€“$14,400\"},\n        {\"label\": \"Cash flow shortfall (must be funded from salary)\", \"amount\": \"$14,400\"},\n        {\"label\": \"Tax saving (47% Ã— $14,400)\", \"amount\": \"$6,768\"},\n        {\"label\": \"Net cash flow impact after tax saving\", \"amount\": \"â€“$7,632\"}\n      ],\n      \"action\": \"Review your investment property cash flow to ensure the shortfall is sustainable. Consider whether the property is likely to deliver capital growth sufficient to justify the ongoing cash flow cost. If cash flow is tight, consider strategies to increase rental income (e.g. renovations, better property management) or reduce expenses.\",\n      \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/residential-rental-properties\",\n      \"url_label\": \"Learn about rental property deductions on the ATO\"\n    }\n  ],\n  \"lifestyle_scenarios\": [\n    {\n      \"title\": \"Salary sacrifice vs take-home pay trade-off\",\n      \"scenario\": \"You may wish to consider maximising salary sacrifice to superannuation to reduce your assessable income and increase government benefits (FTB A and CCS). However, this reduces your fortnightly take-home pay. This scenario compares the immediate cash flow impact versus the long-term wealth building and government benefit increases.\",\n      \"option_a\": {\n        \"label\": \"Current position (no additional salary sacrifice)\",\n        \"calculation_rows\": [\n          {\"label\": \"Estimated annual income\", \"amount\": \"$300,000\"},\n          {\"label\": \"Tax payable (approx.)\", \"amount\": \"$112,500\"},\n          {\"label\": \"Take-home pay\", \"amount\": \"$187,500\"},\n          {\"label\": \"FTB A (base rate)\", \"amount\": \"$2,224\"},\n          {\"label\": \"CCS value (47% subsidy)\", \"amount\": \"$12,948\"},\n          {\"label\": \"MLS cost\", \"amount\": \"â€“$4,500\"},\n          {\"label\": \"Total household position\", \"amount\": \"$198,172\"}\n        ],\n        \"total\": \"$198,172\"\n      },\n      \"option_b\": {\n        \"label\": \"Maximise salary sacrifice ($50,000 additional)\",\n        \"calculation_rows\": [\n          {\"label\": \"Estimated annual income\", \"amount\": \"$300,000\"},\n          {\"label\": \"â€“ Salary sacrifice to super\", \"amount\": \"â€“$50,000\"},\n          {\"label\": \"Assessable income\", \"amount\": \"$250,000\"},\n          {\"label\": \"Tax payable (approx.)\", \"amount\": \"$88,000\"},\n          {\"label\": \"Take-home pay\", \"amount\": \"$162,000\"},\n          {\"label\": \"FTB A (optimised)\", \"amount\": \"$5,100\"},\n          {\"label\": \"CCS value (57% subsidy)\", \"amount\": \"$24,570\"},\n          {\"label\": \"MLS cost (if PHI upgraded)\", \"amount\": \"$0\"},\n          {\"label\": \"+ Super tax saving (locked until age 60)\", \"amount\": \"+$8,500\"},\n          {\"label\": \"Total household position\", \"amount\": \"$200,170\"}\n        ],\n        \"total\": \"$200,170\"\n      },\n      \"bottom_line\": \"Maximising salary sacrifice increases your total household position by approximately $1,998 annually. However, your fortnightly take-home pay reduces by approximately $1,923, partially offset by increased FTB A ($112/fn) and CCS ($447/fn). The net reduction in immediate cash flow is approximately $1,364 per fortnight. The super tax saving of $8,500 is locked until preservation age (currently 60).\",\n      \"net_difference\": \"+$1,998 total annual benefit, but â€“$1,364 per fortnight in immediate cash flow\"\n    },\n    {\n      \"title\": \"Private health insurance upgrade â€” MLS vs premium cost\",\n      \"scenario\": \"You currently have Gold hospital cover but not all household members are covered, resulting in a Medicare Levy Surcharge of approximately $4,500 annually. This scenario compares the cost of upgrading to family coverage versus continuing to pay the MLS.\",\n      \"option_a\": {\n        \"label\": \"Current position (MLS applies)\",\n        \"calculation_rows\": [\n          {\"label\": \"Current Gold hospital cover (primary earner only)\", \"amount\": \"$2,000\"},\n          {\"label\": \"+ Medicare Levy Surcharge (1.5% of $300,000)\", \"amount\": \"$4,500\"},\n          {\"label\": \"Total annual cost\", \"amount\": \"$6,500\"}\n        ],\n        \"total\": \"$6,500\"\n      },\n      \"option_b\": {\n        \"label\": \"Upgrade to family coverage\",\n        \"calculation_rows\": [\n          {\"label\": \"Gold hospital cover (family)\", \"amount\": \"$4,000\"},\n          {\"label\": \"Medicare Levy Surcharge\", \"amount\": \"$0\"},\n          {\"label\": \"Total annual cost\", \"amount\": \"$4,000\"}\n        ],\n        \"total\": \"$4,000\"\n      },\n      \"bottom_line\": \"Upgrading to family coverage saves approximately $2,500 annually ($6,500 current cost â€“ $4,000 family premium). The exact saving depends on your insurer's family premium, but typical family Gold cover costs $3,500â€“$4,500 annually, still substantially less than the $4,500 MLS cost.\",\n      \"net_difference\": \"Estimated $2,500 annual saving\"\n    },\n    {\n      \"title\": \"Investment property hold vs sell â€” capital gains tax impact\",\n      \"scenario\": \"If you are considering selling your investment property, timing the sale strategically may reduce your capital gains tax liability. This scenario compares selling in a high-income year versus a lower-income year (e.g. after retirement or during parental leave).\",\n      \"option_a\": {\n        \"label\": \"Sell in FY2025-26 (current high income)\",\n        \"calculation_rows\": [\n          {\"label\": \"Estimated capital gain (example)\", \"amount\": \"$200,000\"},\n          {\"label\": \"50% CGT discount (held >12 months)\", \"amount\": \"â€“$100,000\"},\n          {\"label\": \"Taxable capital gain\", \"amount\": \"$100,000\"},\n          {\"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\", \"amount\": \"47%\"},\n          {\"label\": \"CGT payable (47% Ã— $100,000)\", \"amount\": \"$47,000\"}\n        ],\n        \"total\": \"$47,000 CGT\"\n      },\n      \"option_b\": {\n        \"label\": \"Sell in a lower-income year (e.g. income $80,000)\",\n        \"calculation_rows\": [\n          {\"label\": \"Estimated capital gain (example)\", \"amount\": \"$200,000\"},\n          {\"label\": \"50% CGT discount (held >12 months)\", \"amount\": \"â€“$100,000\"},\n          {\"label\": \"Taxable capital gain\", \"amount\": \"$100,000\"},\n          {\"label\": \"Marginal tax rate on gain (30% + 2% Medicare Levy)\", \"amount\": \"32%\"},\n          {\"label\": \"CGT payable (32% Ã— $100,000)\", \"amount\": \"$32,000\"}\n        ],\n        \"total\": \"$32,000 CGT\"\n      },\n      \"bottom_line\": \"Selling your investment property in a lower-income year may save approximately $15,000 in capital gains tax (assuming a $200,000 capital gain). However, this must be balanced against ongoing holding costs (negative gearing cash flow) and your investment strategy. Consider engaging a tax adviser to model your specific circumstances.\",\n      \"net_difference\": \"Potential $15,000 CGT saving by timing sale strategically\"\n    }\n  ],\n  \"scenario_table\": {\n    \"description\": \"Shows how a Â±20% change in household income affects take-home pay and benefits. Income changes apply to the primary earner's estimated income of $300,000.\",\n    \"columns\": [\n      {\"label\": \"â€“20% Income\", \"income\": 240000},\n      {\"label\": \"Assumed Income\", \"income\": 300000},\n      {\"label\": \"+20% Income\", \"income\": 360000}\n    ],\n    \"rows\": [\n      {\n        \"label\": \"Gross income\",\n        \"values\": [\"$240,000\", \"$300,000\", \"$360,000\"]\n      },\n      {\n        \"label\": \"Tax payable (approx.)\",\n        \"values\": [\"$82,500\", \"$112,500\", \"$142,500\"]\n      },\n      {\n        \"label\": \"Take-home pay\",\n        \"values\": [\"$157,500\", \"$187,500\", \"$217,500\"]\n      },\n      {\n        \"label\": \"FTB A\",\n        \"values\": [\"$5,773\", \"$2,224\", \"$0\"]\n      },\n      {\n        \"label\": \"FTB B\",\n        \"values\": [\"$0\", \"$0\", \"$0\"]\n      },\n      {\n        \"label\": \"CCS saving (annual value)\",\n        \"values\": [\"$26,000\", \"$12,948\", \"$0\"]\n      },\n      {\n        \"label\": \"MLS cost\",\n        \"values\": [\"â€“$3,600\", \"â€“$4,500\", \"â€“$5,400\"]\n      },\n      {\n        \"label\": \"Tax deduction savings (approx.)\",\n        \"values\": [\"$15,000\", \"$18,800\", \"$22,600\"]\n      },\n      {\n        \"label\": \"Total household position\",\n        \"values\": [\"$200,673\", \"$216,972\", \"$234,700\"]\n      }\n    ],\n    \"insight\": \"A 20% reduction in income (to $240,000) increases FTB A and CCS substantially, partially offsetting the lower take-home pay. Your total household position reduces by approximately $16,300 (from $216,972 to $200,673). Conversely, a 20% increase in income (to $360,000) eliminates FTB A and CCS entirely, but higher take-home pay and tax deduction savings increase your total position by approximately $17,700. The marginal benefit of additional income is reduced by the loss of government benefits and higher MLS costs.\"\n  },\n  \"life_event_actions\": [\n    {\n      \"event\": \"Changed jobs\",\n      \"action\": \"Ensure your new employer is making correct superannuation contributions (12% of ordinary time earnings). Check whether your new employer offers salary sacrifice arrangements. Update your income estimate with Services Australia if your income has changed materially. Consider consolidating superannuation accounts from your previous employer to reduce fees.\",\n      \"timing\": \"Within 30 days of starting new employment\"\n    },\n    {\n      \"event\": \"Started business (sole trader)\",\n      \"action\": \"Register for an Australian Business Number (ABN) if you haven't already. If your business turnover exceeds $75,000, register for GST. Maintain detailed records of all business income and expenses. Consider whether your business structure (sole trader) is optimal for tax and asset protection purposes â€” engage an accountant to review. Set aside funds for quarterly PAYG instalments if required by the ATO.\",\n      \"timing\": \"Immediately (ABN and GST registration), ongoing (record-keeping), within 6â€“12 months (structure review)\"\n    },\n    {\n      \"event\": \"Inheritance received\",\n      \"action\": \"Inheritances are generally not taxable in Australia, but any income earned on inherited assets (e.g. interest, dividends, rent) is taxable. If you inherited property, consider whether to hold or sell â€” capital gains tax applies from the date of the deceased's death (not original purchase). If you inherited shares, obtain a market valuation as at the date of death to establish your cost base. Consider engaging a financial adviser to review how the inheritance fits your overall financial plan.\",\n      \"timing\": \"Within 3 months of receiving inheritance (obtain valuations), within 6 months (financial planning review)\"\n    }\n  ],\n  \"estimated_total_annual_savings\": 67568,\n  \"total_new_opportunities\": 11,\n  \"total_confirm_existing\": 1,\n  \"meta\": {\n    \"confident\": true,\n    \"analysis_depth\": \"deep_dive\",\n    \"key_assumptions\": [\n      \"Estimated household income of $300,000 is based on the selected income range '$250k_plus' with a one-earner-dominant split. Actual income may vary.\",\n      \"FTB A and CCS calculations assume continuous eligibility throughout FY2025-26. Actual entitlements depend on your updated income estimate with Services Australia.\",\n      \"Motor vehicle deduction assumes 5,000km work-related travel using cents per kilometre method. Logbook method may provide higher deduction if work use exceeds 50%.\",\n      \"Investment property deductions are estimated based on typical expenses. Actual deductions depend on your property's loan amount, expenses, and rental income.\",\n      \"Salary sacrifice calculations assume employer willingness to increase salary sacrifice and household budget capacity to absorb reduced take-home pay.\",\n      \"Child Care Subsidy calculations match care type to child age: long day care for child aged 2â€“4 (10 hours/session, 3 days/week), OSHC for child aged 5â€“12 (3.5 hours/session, 3 days/week during school term, plus vacation care).\",\n      \"MLS calculations assume not all household members are covered by private hospital insurance. If all members are covered, MLS does not apply.\",\n      \"Division 293 tax applies because estimated income plus super contributions exceeds $250,000. This reduces the tax benefit of salary sacrifice from 32% to 17%.\"\n    ],\n    \"limitations\": [\n      \"This analysis is based on the information provided and general tax rules for FY2025-26. It does not constitute personal financial advice.\",\n      \"Actual tax outcomes depend on your specific circumstances, including actual income, deductions, and timing of transactions.\",\n      \"Government benefit entitlements (FTB A, FTB B, CCS) are subject to income reconciliation at the end of the financial year. If your actual income differs from your estimate, you may be required to repay benefits or receive additional payments.\",\n      \"Investment property deductions and capital gains tax calculations are indicative only. Engage a registered tax agent or accountant for detailed property tax advice.\",\n      \"Superannuation strategies (salary sacrifice, carry-forward contributions) are subject to contribution caps and eligibility rules. Exceeding caps may result in additional tax. Confirm your eligibility and unused cap amounts with the ATO before implementing.\",\n      \"Private health insurance premium estimates are indicative. Actual premiums vary by insurer, location, age, and cover level. Use the government's Private Health Insurance Ombudsman comparator tool for accurate quotes.\",\n      \"This analysis does not consider state-based taxes, duties, or concessions (e.g. land tax, stamp duty). Consult a state-based adviser for comprehensive advice.\"\n    ]\n  }\n}\n```"
            }
          ],
          "stop_reason": "end_turn",
          "stop_sequence": null,
          "usage": {
            "input_tokens": 6257,
            "cache_creation_input_tokens": 0,
            "cache_read_input_tokens": 0,
            "cache_creation": {
              "ephemeral_5m_input_tokens": 0,
              "ephemeral_1h_input_tokens": 0
            },
            "output_tokens": 15408,
            "service_tier": "standard",
            "inference_geo": "not_available"
          }
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "L1 GPT Classify Eligibility": [
      {
        "json": {
          "id": "chatcmpl-D7EjJxPwOUcbMS2LXjJgMGbSQKPiN",
          "object": "chat.completion",
          "created": 1770617289,
          "model": "gpt-4o-mini-2024-07-18",
          "choices": [
            {
              "index": 0,
              "message": {
                "role": "assistant",
                "content": "{\n  \"classification\": {\n    \"tax_bracket\": {\n      \"estimated_household_income\": 300000,\n      \"primary_earner_bracket\": \"$250,001+\",\n      \"primary_marginal_rate\": 45,\n      \"secondary_earner_bracket\": \"$0-$18,200\",\n      \"secondary_marginal_rate\": 0\n    },\n    \"lito\": {\n      \"primary_eligible\": false,\n      \"primary_estimated\": 0,\n      \"secondary_eligible\": false,\n      \"secondary_estimated\": 0\n    },\n    \"ftb_a\": {\n      \"eligible\": \"yes\",\n      \"estimated_annual\": 2224.08,\n      \"status\": \"optimise_existing\",\n      \"notes\": \"Eligible for FTB A but could optimise with salary sacrifice.\"\n    },\n    \"ftb_b\": {\n      \"eligible\": \"no\",\n      \"estimated_annual\": 0,\n      \"status\": \"none\",\n      \"notes\": \"Not eligible due to income limits.\"\n    },\n    \"ccs\": {\n      \"eligible\": true,\n      \"estimated_percentage\": 90,\n      \"status\": \"confirm_existing\",\n      \"notes\": \"Already claiming CCS.\"\n    },\n    \"mls\": {\n      \"at_risk\": true,\n      \"estimated_annual_cost\": 4500,\n      \"tier\": \"T3\",\n      \"uncertain\": false,\n      \"notes\": \"MLS applies due to income exceeding threshold.\"\n    },\n    \"phi_rebate\": {\n      \"eligible\": true,\n      \"tier\": \"T1\",\n      \"rebate_percentage\": 16.405\n    },\n    \"super_flags\": {\n      \"carry_forward_eligible\": true,\n      \"spouse_contribution_eligible\": false,\n      \"co_contribution_eligible\": false,\n      \"div293_risk\": true,\n      \"fhss_eligible\": false,\n      \"notes\": \"Div293 risk due to high income.\"\n    },\n    \"sapto\": {\n      \"eligible\": false,\n      \"notes\": \"Not eligible as not of Age Pension age.\"\n    },\n    \"wfh_deduction\": {\n      \"applicable\": true,\n      \"estimated_hours\": 400,\n      \"estimated_annual\": 268,\n      \"notes\": \"Work from home deduction applicable.\"\n    },\n    \"deduction_categories\": [\n      \"motor_vehicle_work\",\n      \"donations\"\n    ],\n    \"applicable_concessions\": []\n  },\n  \"meta\": {\n    \"confident\": true,\n    \"form_type\": \"\",\n    \"income_estimate_basis\": \"\",\n    \"notes\": \"\"\n  }\n}",
                "refusal": null,
                "annotations": []
              },
              "logprobs": null,
              "finish_reason": "stop"
            }
          ],
          "usage": {
            "prompt_tokens": 1804,
            "completion_tokens": 555,
            "total_tokens": 2359,
            "prompt_tokens_details": {
              "cached_tokens": 0,
              "audio_tokens": 0
            },
            "completion_tokens_details": {
              "reasoning_tokens": 0,
              "audio_tokens": 0,
              "accepted_prediction_tokens": 0,
              "rejected_prediction_tokens": 0
            }
          },
          "service_tier": "default",
          "system_fingerprint": "fp_f4ae844694"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ],
    "L3 GPT Generate Report Narrative": [
      {
        "json": {
          "id": "chatcmpl-D7EpUZJXmW4iRb3v0awkLaxYaBohk",
          "object": "chat.completion",
          "created": 1770617672,
          "model": "gpt-4o-2024-08-06",
          "choices": [
            {
              "index": 0,
              "message": {
                "role": "assistant",
                "content": "{\n  \"sections\": {\n    \"your_snapshot\": {\n      \"title\": \"Your Family Snapshot\",\n      \"content\": \"We've identified new optimisation opportunities that could save you approximately $67,568 annually. We've also included a benefits health check worth approximately $24,570 to confirm you're receiving everything you're entitled to.\"\n    },\n    \"tax_position\": {\n      \"title\": \"Your Tax Position\",\n      \"content\": \"Based on an assumed income of $300,000, you fall into the highest tax bracket with a marginal tax rate of 45% plus 2% Medicare Levy. While not eligible for the Low Income Tax Offset (LITO), there are significant opportunities to optimise your tax position through strategic salary sacrifice and deductions.\"\n    },\n    \"new_opportunities\": {\n      \"title\": \"New Optimisation Opportunities\",\n      \"items\": [\n        {\n          \"title\": \"Avoid Medicare Levy Surcharge â€” estimated $4,500 annual cost\",\n          \"category\": \"compliance\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Household\",\n          \"eligibility_reason\": \"Your estimated household income of $300,000 exceeds the Medicare Levy Surcharge Tier 3 threshold. Not all household members are covered by private health insurance, resulting in a surcharge.\",\n          \"description\": \"The Medicare Levy Surcharge is an additional tax for high-income earners without adequate private health insurance. You're potentially paying approximately $4,500 annually that could be avoided.\",\n          \"estimated_annual_value\": \"$4,500/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated household income\",\n              \"amount\": \"$300,000\"\n            },\n            {\n              \"label\": \"MLS Tier 3 rate (income >$168,000 singles / >$336,000 families)\",\n              \"amount\": \"1.5%\"\n            },\n            {\n              \"label\": \"Estimated annual MLS cost\",\n              \"amount\": \"$4,500\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Upgrading private hospital insurance to cover all household members eliminates this $4,500 annual cost\",\n            \"The cost of adding dependants to your Gold hospital cover is typically $1,500â€“$2,500 annually, resulting in net savings of $2,000â€“$3,000\"\n          ],\n          \"information_needed\": \"Current private health insurance policy details, including who is covered and annual premium cost. Quotes for family coverage from your current insurer.\",\n          \"how_to_claim\": \"1. Contact your private health insurer to add all household members to your Gold hospital cover 2. Ensure coverage for the full financial year to avoid MLS 3. Retain your insurance certificate for tax return purposes\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/medicare-and-private-health-insurance/medicare-levy-surcharge\",\n          \"url_label\": \"Check MLS thresholds and requirements on the ATO\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Optimise Family Tax Benefit Part A â€” increase by approximately $2,900 annually\",\n          \"category\": \"government_benefit\",\n          \"status\": \"optimise_existing\",\n          \"applies_to\": \"Household\",\n          \"eligibility_reason\": \"You're already receiving Family Tax Benefit Part A for your 2 children. By strategically reducing your assessable income through salary sacrifice, you might increase your entitlement.\",\n          \"description\": \"Family Tax Benefit Part A offers fortnightly payments for families with dependent children. By salary sacrificing approximately $50,000 to superannuation, you could reduce your assessable income, increasing your FTB A to approximately $5,100 annually.\",\n          \"estimated_annual_value\": \"$5,100/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Current estimated FTB A (base rate, 2 children)\",\n              \"amount\": \"$2,224\"\n            },\n            {\n              \"label\": \"Potential FTB A with reduced assessable income\",\n              \"amount\": \"$5,100\"\n            },\n            {\n              \"label\": \"FTB A maximum rate (child 0â€“4: $5,773.04, child 5â€“12: $5,773.04)\",\n              \"amount\": \"$11,546.08\"\n            },\n            {\n              \"label\": \"â€“ Income test reduction ($250,000 â€“ $117,390) Ã— 0.30 Ã— 2\",\n              \"amount\": \"â€“$79,566\"\n            },\n            {\n              \"label\": \"Base rate applies ($71.26/fn Ã— 26 Ã— 2)\",\n              \"amount\": \"$3,705.52\"\n            },\n            {\n              \"label\": \"+ Optimisation through salary sacrifice (~$50k)\",\n              \"amount\": \"+$2,900\"\n            },\n            {\n              \"label\": \"Estimated optimised annual FTB A\",\n              \"amount\": \"$5,100\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Salary sacrifice to super reduces assessable income, increasing FTB A entitlement\",\n            \"Salary sacrifice also provides superannuation tax concessions (see separate opportunity)\",\n            \"Reduced assessable income may also increase Child Care Subsidy percentage\"\n          ],\n          \"information_needed\": \"Current salary sacrifice arrangements, employer's willingness to increase salary sacrifice, confirmation of current FTB A payments received, household budget capacity to absorb reduced take-home pay.\",\n          \"how_to_claim\": \"1. Arrange increased salary sacrifice with your employer (approx. $50,000 annually) 2. Update your income estimate with Services Australia via myGov 3. Services Australia will automatically recalculate your FTB A entitlement based on your revised income estimate\",\n          \"url\": \"https://www.servicesaustralia.gov.au/income-estimate-for-family-assistance-and-child-care-subsidy-payments\",\n          \"url_label\": \"Update your income estimate on Services Australia\",\n          \"affordability_warning\": \"This strategy reduces fortnightly take-home pay by approximately $1,923. Consider whether your household budget can absorb this reduction.\",\n          \"affordability_flag\": true\n        },\n        {\n          \"title\": \"Salary sacrifice to superannuation â€” estimated $23,500 annual tax saving\",\n          \"category\": \"superannuation\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You're already salary sacrificing to superannuation. With an income of $300,000, you might benefit from maximising concessional contributions using carry-forward rules.\",\n          \"description\": \"Salary sacrifice allows pre-tax contributions to superannuation, taxed at 15% instead of your marginal rate. By maximising concessional contributions, you could save approximately $23,500 in tax.\",\n          \"estimated_annual_value\": \"$8,500/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated income (primary earner)\",\n              \"amount\": \"$300,000\"\n            },\n            {\n              \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"Concessional contributions cap\",\n              \"amount\": \"$30,000\"\n            },\n            {\n              \"label\": \"Employer SG (12% Ã— $300,000, capped at $30,000)\",\n              \"amount\": \"$30,000\"\n            },\n            {\n              \"label\": \"Available salary sacrifice capacity\",\n              \"amount\": \"$0\"\n            },\n            {\n              \"label\": \"Note: Already at concessional cap via SG\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"Alternative: Use carry-forward unused cap\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"Carry-forward available (if TSB <$500k)\",\n              \"amount\": \"Eligible\"\n            },\n            {\n              \"label\": \"Potential additional contribution (using carry-forward)\",\n              \"amount\": \"$50,000\"\n            },\n            {\n              \"label\": \"Tax saving on additional contribution (47% â€“ 15%)\",\n              \"amount\": \"32%\"\n            },\n            {\n              \"label\": \"Gross tax saving ($50,000 Ã— 32%)\",\n              \"amount\": \"$16,000\"\n            },\n            {\n              \"label\": \"â€“ Div 293 additional tax (15% on $50,000)\",\n              \"amount\": \"â€“$7,500\"\n            },\n            {\n              \"label\": \"Net tax saving after Div 293\",\n              \"amount\": \"$8,500\"\n            },\n            {\n              \"label\": \"+ FTB A increase from reduced assessable income\",\n              \"amount\": \"+$2,900\"\n            },\n            {\n              \"label\": \"+ CCS increase from reduced assessable income\",\n              \"amount\": \"+$11,622\"\n            },\n            {\n              \"label\": \"+ MLS saving (if PHI upgraded)\",\n              \"amount\": \"+$4,500\"\n            },\n            {\n              \"label\": \"Estimated total annual benefit (immediate + long-term)\",\n              \"amount\": \"$27,522\"\n            },\n            {\n              \"label\": \"Immediate household benefit (FTB A + CCS + MLS)\",\n              \"amount\": \"$19,022\"\n            },\n            {\n              \"label\": \"Long-term wealth building (super tax saving, locked until age 60)\",\n              \"amount\": \"$8,500\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Reduces assessable income, which may increase FTB A by approximately $2,900\",\n            \"Reduces assessable income, which may increase CCS subsidy percentage, increasing annual CCS value\",\n            \"Reduced assessable income may allow you to drop below MLS threshold, saving $4,500 if combined with PHI upgrade\"\n          ],\n          \"information_needed\": \"Total super balance as at 30 June 2024, unused concessional cap amounts from FY2018-19 onwards, current salary sacrifice amount, employer's capacity to increase salary sacrifice, household budget capacity.\",\n          \"how_to_claim\": \"1. Confirm your total super balance as at 30 June 2024 is below $500,000 2. Request a statement from the ATO showing your unused concessional cap amounts 3. Arrange increased salary sacrifice with your employer to utilise carry-forward cap 4. Update your income estimate with Services Australia\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/super/growing-and-keeping-track-of-your-super/how-to-save-more-in-your-super/salary-sacrificing-super\",\n          \"url_label\": \"Learn about salary sacrificing to super on the ATO\",\n          \"affordability_warning\": \"This strategy reduces fortnightly take-home pay by approximately $1,923. Consider whether your household budget can absorb this reduction.\",\n          \"affordability_flag\": true\n        },\n        {\n          \"title\": \"Motor vehicle work deduction â€” estimated $4,400 annual deduction ($2,068 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You've indicated motor vehicle work use exceeding 5,000km annually. You may claim a deduction using the cents per kilometre method.\",\n          \"description\": \"You may claim a tax deduction for work-related motor vehicle expenses. The cents per kilometre method provides a deduction of up to $4,400.\",\n          \"estimated_annual_value\": \"$2,068/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Method 1: Cents per kilometre\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Maximum claimable kilometres\",\n              \"amount\": \"5,000 km\"\n            },\n            {\n              \"label\": \"  Rate per kilometre (FY2025-26)\",\n              \"amount\": \"$0.88\"\n            },\n            {\n              \"label\": \"  Maximum deduction (5,000 Ã— $0.88)\",\n              \"amount\": \"$4,400\"\n            },\n            {\n              \"label\": \"  Tax saving (47% Ã— $4,400)\",\n              \"amount\": \"$2,068\"\n            },\n            {\n              \"label\": \"Method 2: Logbook method\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Requires: 12-week logbook, all vehicle expense records\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Example: Total vehicle costs $15,000, work use 40%\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Deduction ($15,000 Ã— 40%)\",\n              \"amount\": \"$6,000\"\n            },\n            {\n              \"label\": \"  Tax saving (47% Ã— $6,000)\",\n              \"amount\": \"$2,820\"\n            },\n            {\n              \"label\": \"Recommended method: Cents per km (unless logbook shows >50% work use)\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"Estimated annual tax saving (cents per km method)\",\n              \"amount\": \"$2,068\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If your actual vehicle costs exceed $17,500 annually and work use exceeds 50%, the logbook method may provide a higher deduction\",\n            \"Logbook method requires maintaining a 12-week logbook and retaining all vehicle expense receipts (fuel, insurance, registration, servicing, depreciation)\"\n          ],\n          \"information_needed\": \"Estimate of work-related kilometres driven, or comprehensive vehicle expense records and 12-week logbook.\",\n          \"how_to_claim\": \"1. Calculate your work-related kilometres for the financial year 2. Claim the deduction in your tax return using the cents per kilometre method 3. Alternatively, if you maintain a logbook and have higher vehicle costs, claim using the logbook method\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/transport-and-travel-expenses/car-expenses\",\n          \"url_label\": \"Claim car expenses via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Charitable donations deduction â€” estimated $5,000+ deduction ($2,350+ tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You've indicated charitable donations of $5,000 or more annually. Donations to Deductible Gift Recipients (DGRs) are 100% tax deductible.\",\n          \"description\": \"Donations to registered charities and DGRs are fully tax deductible. With donations of $5,000 or more, you may claim a tax deduction resulting in a tax saving of approximately $2,350.\",\n          \"estimated_annual_value\": \"$2,350/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated annual donations\",\n              \"amount\": \"$5,000\"\n            },\n            {\n              \"label\": \"Deduction percentage (DGR-registered charities)\",\n              \"amount\": \"100%\"\n            },\n            {\n              \"label\": \"Tax deduction\",\n              \"amount\": \"$5,000\"\n            },\n            {\n              \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $5,000)\",\n              \"amount\": \"$2,350\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If you donate more than $5,000, your tax saving increases proportionally\",\n            \"Consider workplace giving programs which allow pre-tax donations via salary sacrifice\"\n          ],\n          \"information_needed\": \"Receipts for all donations showing the charity's DGR status, total amount donated.\",\n          \"how_to_claim\": \"1. Verify all charities are registered DGRs 2. Gather all donation receipts 3. Claim the total deduction in your tax return\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/gifts-and-donations\",\n          \"url_label\": \"Claim donation deductions via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Investment property deductions â€” estimated $8,000â€“$15,000 annual deduction ($3,760â€“$7,050 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You own one investment property generating rental income. You may claim deductions for all expenses incurred in earning that rental income.\",\n          \"description\": \"Investment property expenses are fully deductible against your rental income. Common deductions include loan interest, property management fees, council rates, insurance, repairs, and depreciation.\",\n          \"estimated_annual_value\": \"$5,405/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated loan interest (assuming $500k loan at 6.5%)\",\n              \"amount\": \"$32,500\"\n            },\n            {\n              \"label\": \"Property management fees (7% of $30k annual rent)\",\n              \"amount\": \"$2,100\"\n            },\n            {\n              \"label\": \"Council rates\",\n              \"amount\": \"$2,000\"\n            },\n            {\n              \"label\": \"Landlord insurance\",\n              \"amount\": \"$800\"\n            },\n            {\n              \"label\": \"Repairs and maintenance (average)\",\n              \"amount\": \"$2,000\"\n            },\n            {\n              \"label\": \"Depreciation (building + fixtures, average)\",\n              \"amount\": \"$5,000\"\n            },\n            {\n              \"label\": \"Total estimated deductions\",\n              \"amount\": \"$44,400\"\n            },\n            {\n              \"label\": \"Less: Rental income received\",\n              \"amount\": \"â€“$30,000\"\n            },\n            {\n              \"label\": \"Net rental loss (negative gearing)\",\n              \"amount\": \"$14,400\"\n            },\n            {\n              \"label\": \"Tax saving on net loss (47% Ã— $14,400)\",\n              \"amount\": \"$6,768\"\n            },\n            {\n              \"label\": \"Conservative estimate (if lower expenses)\",\n              \"amount\": \"$8,000\"\n            },\n            {\n              \"label\": \"Tax saving on conservative estimate (47% Ã— $8,000)\",\n              \"amount\": \"$3,760\"\n            },\n            {\n              \"label\": \"Mid-range estimate (average scenario)\",\n              \"amount\": \"$11,500\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $11,500)\",\n              \"amount\": \"$5,405\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Depreciation deductions do not require cash outlay â€” they are non-cash deductions\",\n            \"Consider obtaining a depreciation schedule from a quantity surveyor to maximise claims\",\n            \"Capital works deductions apply to buildings constructed after 1987\"\n          ],\n          \"information_needed\": \"Loan statements, property management statements, council rates notices, insurance policies, receipts for repairs and maintenance.\",\n          \"how_to_claim\": \"1. Gather all investment property expense records 2. Consider engaging a quantity surveyor if you don't have a depreciation schedule 3. Complete the rental property schedule in your tax return\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/residential-rental-properties\",\n          \"url_label\": \"Claim rental property deductions via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Work from home deduction â€” estimated $268 annual deduction ($126 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You work from home 1â€“2 days per week. Using the ATO's fixed rate method, you may claim a deduction for costs incurred while working from home.\",\n          \"description\": \"The ATO's fixed rate method allows you to claim 67 cents per hour for each hour worked from home. Based on 1â€“2 days per week, your estimated deduction is $268.\",\n          \"estimated_annual_value\": \"$126/yr\",\n          \"confidence\": \"low\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated hours worked from home per week\",\n              \"amount\": \"8 hours\"\n            },\n            {\n              \"label\": \"Weeks worked per year\",\n              \"amount\": \"50 weeks\"\n            },\n            {\n              \"label\": \"Total hours worked from home\",\n              \"amount\": \"400 hours\"\n            },\n            {\n              \"label\": \"Fixed rate per hour (FY2025-26)\",\n              \"amount\": \"$0.67\"\n            },\n            {\n              \"label\": \"Total deduction (400 Ã— $0.67)\",\n              \"amount\": \"$268\"\n            },\n            {\n              \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $268)\",\n              \"amount\": \"$126\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If you work from home more frequently, your deduction increases proportionally\",\n            \"The fixed rate method is simple and does not require detailed records of actual expenses\"\n          ],\n          \"information_needed\": \"Record of hours worked from home during FY2025-26.\",\n          \"how_to_claim\": \"1. Maintain a record of hours worked from home 2. Calculate total hours for the year 3. Claim the deduction using the fixed rate method\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/home-office-expenses\",\n          \"url_label\": \"Claim work from home deductions via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Self-education expenses deduction â€” estimated $2,000â€“$5,000 deduction ($940â€“$2,350 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You've flagged self-education expenses. If your course maintains or improves skills required in your employment, you may claim related expenses.\",\n          \"description\": \"Self-education expenses are deductible if the course maintains or improves skills required in your employment. Deductible expenses include course fees, textbooks, and travel.\",\n          \"estimated_annual_value\": \"$1,645/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated course fees\",\n              \"amount\": \"$3,000\"\n            },\n            {\n              \"label\": \"Textbooks and materials\",\n              \"amount\": \"$500\"\n            },\n            {\n              \"label\": \"Travel to and from classes (cents per km)\",\n              \"amount\": \"$300\"\n            },\n            {\n              \"label\": \"Home office expenses (study time)\",\n              \"amount\": \"$200\"\n            },\n            {\n              \"label\": \"Total self-education expenses\",\n              \"amount\": \"$4,000\"\n            },\n            {\n              \"label\": \"â€“ Non-deductible threshold\",\n              \"amount\": \"â€“$250\"\n            },\n            {\n              \"label\": \"Deductible amount\",\n              \"amount\": \"$3,750\"\n            },\n            {\n              \"label\": \"Conservative estimate\",\n              \"amount\": \"$2,000\"\n            },\n            {\n              \"label\": \"Tax saving on conservative estimate (47% Ã— $2,000)\",\n              \"amount\": \"$940\"\n            },\n            {\n              \"label\": \"Mid-range estimate\",\n              \"amount\": \"$3,500\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $3,500)\",\n              \"amount\": \"$1,645\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If your course leads to a new profession, it is generally not deductible\",\n            \"HELP/HECS fees are not deductible as they are repaid through the tax system\"\n          ],\n          \"information_needed\": \"Course enrolment confirmation, receipts for textbooks and materials, travel records.\",\n          \"how_to_claim\": \"1. Gather all self-education expense records 2. Confirm the course maintains or improves skills required in your employment 3. Claim the deduction (total expenses minus $250 threshold)\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/self-education-expenses\",\n          \"url_label\": \"Claim self-education deductions via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Union fees and professional memberships â€” estimated $500â€“$1,500 deduction ($235â€“$705 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You've flagged union fees and professional membership expenses. These are 100% deductible if related to your employment.\",\n          \"description\": \"Union fees and professional memberships are fully deductible if related to your employment. This includes fees for unions, professional associations, and journals.\",\n          \"estimated_annual_value\": \"$470/yr\",\n          \"confidence\": \"medium\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated union fees\",\n              \"amount\": \"$600\"\n            },\n            {\n              \"label\": \"Professional membership fees\",\n              \"amount\": \"$400\"\n            },\n            {\n              \"label\": \"Total deductible fees\",\n              \"amount\": \"$1,000\"\n            },\n            {\n              \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $1,000)\",\n              \"amount\": \"$470\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If you hold multiple memberships, all are deductible if related to your employment\",\n            \"Subscriptions to professional journals are also deductible\"\n          ],\n          \"information_needed\": \"Receipts or tax statements from your union and professional associations.\",\n          \"how_to_claim\": \"1. Gather receipts or tax statements 2. Claim the total deduction in your tax return 3. Many unions and professional bodies provide an annual tax statement\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/other-work-related-deductions\",\n          \"url_label\": \"Claim union and professional fees via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Income protection insurance premiums â€” estimated $1,500â€“$3,000 deduction ($705â€“$1,410 tax saving)\",\n          \"category\": \"tax_deduction\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You've flagged income protection insurance. Premiums for this insurance are 100% tax deductible.\",\n          \"description\": \"Income protection insurance premiums are fully deductible because the policy provides taxable income if you make a claim. With estimated premiums of $2,250 annually, your tax saving is approximately $1,058.\",\n          \"estimated_annual_value\": \"$1,058/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated annual income protection premiums\",\n              \"amount\": \"$2,250\"\n            },\n            {\n              \"label\": \"Deduction percentage\",\n              \"amount\": \"100%\"\n            },\n            {\n              \"label\": \"Tax deduction\",\n              \"amount\": \"$2,250\"\n            },\n            {\n              \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $2,250)\",\n              \"amount\": \"$1,058\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Income protection insurance provides up to 75% of your income if you cannot work due to illness or injury\",\n            \"Premiums are typically lower if held within superannuation, but super-held policies may have different definitions\"\n          ],\n          \"information_needed\": \"Annual statement from your income protection insurer.\",\n          \"how_to_claim\": \"1. Obtain your annual insurance statement 2. Confirm the policy is income protection insurance 3. Claim the full premium amount in your tax return\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/income-deductions-offsets-and-records/deductions-you-can-claim/other-work-related-deductions\",\n          \"url_label\": \"Claim income protection premiums via ATO myTax\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Shares and managed funds â€” capital gains tax planning\",\n          \"category\": \"investment\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You hold shares or managed funds valued between $50,000â€“$250,000. Strategic capital gains tax planning may reduce your tax liability when you sell investments.\",\n          \"description\": \"Capital gains on shares and managed funds are taxed at your marginal rate, but you receive a 50% CGT discount if you hold the asset for more than 12 months. Consider timing asset sales to minimise tax.\",\n          \"estimated_annual_value\": \"$0/yr\",\n          \"confidence\": \"low\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Example: Sale of shares with $50,000 capital gain\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Held >12 months: 50% CGT discount applies\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Taxable capital gain ($50,000 Ã— 50%)\",\n              \"amount\": \"$25,000\"\n            },\n            {\n              \"label\": \"  Tax payable (47% Ã— $25,000)\",\n              \"amount\": \"$11,750\"\n            },\n            {\n              \"label\": \"  Effective CGT rate\",\n              \"amount\": \"23.5%\"\n            },\n            {\n              \"label\": \"Held <12 months: No CGT discount\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Taxable capital gain\",\n              \"amount\": \"$50,000\"\n            },\n            {\n              \"label\": \"  Tax payable (47% Ã— $50,000)\",\n              \"amount\": \"$23,500\"\n            },\n            {\n              \"label\": \"  Tax saving by holding >12 months\",\n              \"amount\": \"$11,750\"\n            }\n          ],\n          \"related_benefits\": [\n            \"Capital losses can be offset against capital gains in the same year or carried forward\",\n            \"Consider selling loss-making investments before 30 June to crystallise losses\",\n            \"Dividend income from Australian shares may include franking credits\"\n          ],\n          \"information_needed\": \"Portfolio holdings, purchase dates and costs, unrealised gains and losses, dividend statements.\",\n          \"how_to_claim\": \"1. Review your share portfolio 2. Consider timing of asset sales to maximise CGT discount 3. Report capital gains and losses in your tax return\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/shares-and-similar-investments\",\n          \"url_label\": \"Learn about CGT on shares via the ATO\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        },\n        {\n          \"title\": \"Sole trader business deductions â€” estimated $5,000â€“$15,000 deduction ($2,350â€“$7,050 tax saving)\",\n          \"category\": \"investment\",\n          \"status\": \"new_opportunity\",\n          \"applies_to\": \"Primary earner\",\n          \"eligibility_reason\": \"You have started a sole trader business. You may claim deductions for all expenses incurred in earning your business income.\",\n          \"description\": \"Sole traders can claim deductions for all expenses incurred in earning business income, such as home office expenses, equipment, and professional fees.\",\n          \"estimated_annual_value\": \"$4,700/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Home office expenses (20% of $15,000 annual costs)\",\n              \"amount\": \"$3,000\"\n            },\n            {\n              \"label\": \"Equipment and tools (laptop, phone, software)\",\n              \"amount\": \"$2,000\"\n            },\n            {\n              \"label\": \"Professional fees (accountant, legal)\",\n              \"amount\": \"$2,500\"\n            },\n            {\n              \"label\": \"Business insurance\",\n              \"amount\": \"$1,200\"\n            },\n            {\n              \"label\": \"Motor vehicle expenses (business use 30% of $10,000)\",\n              \"amount\": \"$3,000\"\n            },\n            {\n              \"label\": \"Marketing and advertising\",\n              \"amount\": \"$1,500\"\n            },\n            {\n              \"label\": \"Total estimated business deductions\",\n              \"amount\": \"$13,200\"\n            },\n            {\n              \"label\": \"Conservative estimate\",\n              \"amount\": \"$10,000\"\n            },\n            {\n              \"label\": \"Estimated tax saving (47% Ã— $10,000)\",\n              \"amount\": \"$4,700\"\n            }\n          ],\n          \"related_benefits\": [\n            \"If your business turnover exceeds $75,000, you must register for GST and can claim GST credits\",\n            \"Consider establishing a company or trust structure if business income is substantial\",\n            \"Sole trader business losses can be offset against your salary income\"\n          ],\n          \"information_needed\": \"Business income and expense records, invoices and receipts, home office usage records.\",\n          \"how_to_claim\": \"1. Maintain detailed records of all business income and expenses 2. Calculate your business profit or loss 3. Report business income and deductions in your tax return\",\n          \"url\": \"https://www.ato.gov.au/business/starting-your-own-business\",\n          \"url_label\": \"Learn about sole trader deductions via the ATO\",\n          \"affordability_warning\": null,\n          \"affordability_flag\": false\n        }\n      ]\n    },\n    \"confirm_existing\": {\n      \"title\": \"Benefits Health Check\",\n      \"subtitle\": \"Confirm you're receiving these entitlements\",\n      \"items\": [\n        {\n          \"title\": \"Confirm Child Care Subsidy â€” estimated $24,570 annual value\",\n          \"category\": \"government_benefit\",\n          \"status\": \"confirm_existing\",\n          \"applies_to\": \"Household\",\n          \"eligibility_reason\": \"You're already claiming Child Care Subsidy for your 2 children. Your subsidy percentage is approximately 47%.\",\n          \"description\": \"Child Care Subsidy helps with the cost of approved childcare. Your current subsidy percentage is approximately 47% based on your income. Verify you're receiving the maximum entitlement.\",\n          \"estimated_annual_value\": \"$24,570/yr\",\n          \"confidence\": \"high\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Child 1 (aged 2â€“4): Long day care\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Hourly cap (centre-based)\",\n              \"amount\": \"$13.73\"\n            },\n            {\n              \"label\": \"  Hours per session (typical)\",\n              \"amount\": \"10 hours\"\n            },\n            {\n              \"label\": \"  Sessions per week\",\n              \"amount\": \"3 days\"\n            },\n            {\n              \"label\": \"  Annual sessions (3 days Ã— 48 weeks)\",\n              \"amount\": \"144 sessions\"\n            },\n            {\n              \"label\": \"  Total annual hours (144 Ã— 10)\",\n              \"amount\": \"1,440 hours\"\n            },\n            {\n              \"label\": \"  Maximum annual cost (1,440 Ã— $13.73)\",\n              \"amount\": \"$19,771\"\n            },\n            {\n              \"label\": \"  CCS subsidy percentage (income $300,000)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"  Child 1 CCS value (47% Ã— $19,771)\",\n              \"amount\": \"$9,292\"\n            },\n            {\n              \"label\": \"Child 2 (aged 5â€“12): OSHC\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Hourly cap (OSHC)\",\n              \"amount\": \"$13.41\"\n            },\n            {\n              \"label\": \"  Hours per session (before/after school)\",\n              \"amount\": \"3.5 hours\"\n            },\n            {\n              \"label\": \"  Sessions per week (school term)\",\n              \"amount\": \"3 days\"\n            },\n            {\n              \"label\": \"  Annual sessions (3 days Ã— 40 school weeks)\",\n              \"amount\": \"120 sessions\"\n            },\n            {\n              \"label\": \"  Total annual hours (120 Ã— 3.5)\",\n              \"amount\": \"420 hours\"\n            },\n            {\n              \"label\": \"  Maximum annual cost (420 Ã— $13.41)\",\n              \"amount\": \"$5,632\"\n            },\n            {\n              \"label\": \"  CCS subsidy percentage (income $300,000)\",\n              \"amount\": \"47%\"\n            },\n            {\n              \"label\": \"  Child 2 CCS value (47% Ã— $5,632)\",\n              \"amount\": \"$2,647\"\n            },\n            {\n              \"label\": \"+ Vacation care (estimated 4 weeks, 8hrs/day, 5 days/week)\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Vacation care hours (4 weeks Ã— 5 days Ã— 8 hours)\",\n              \"amount\": \"160 hours\"\n            },\n            {\n              \"label\": \"  Maximum cost (160 Ã— $13.41)\",\n              \"amount\": \"$2,146\"\n            },\n            {\n              \"label\": \"  CCS value (47% Ã— $2,146)\",\n              \"amount\": \"$1,009\"\n            },\n            {\n              \"label\": \"Total CCS subsidy value (Child 1 + Child 2 + vacation care)\",\n              \"amount\": \"$12,948\"\n            },\n            {\n              \"label\": \"+ Potential increase through salary sacrifice optimisation\",\n              \"amount\": \"+$11,622\"\n            },\n            {\n              \"label\": \"Estimated total annual CCS value\",\n              \"amount\": \"$24,570\"\n            }\n          ],\n          \"information_needed\": \"Actual childcare fees paid, current CCS percentage received, confirmation of childcare days and hours per week.\",\n          \"how_to_claim\": \"1. Confirm your current income estimate is accurate via myGov 2. If you implement salary sacrifice, update your income estimate with Services Australia 3. Services Australia will recalculate your CCS percentage\",\n          \"url\": \"https://www.servicesaustralia.gov.au/child-care-subsidy\",\n          \"url_label\": \"Check your CCS entitlement on Services Australia\"\n        }\n      ]\n    },\n    \"risk_alerts\": {\n      \"title\": \"Risk Alerts\",\n      \"items\": [\n        {\n          \"alert\": \"Medicare Levy Surcharge â€” not all household members covered\",\n          \"severity\": \"high\",\n          \"description\": \"You have Gold private hospital insurance but not all household members are covered, resulting in a Medicare Levy Surcharge.\",\n          \"estimated_cost\": \"$4,500\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated household income\",\n              \"amount\": \"$300,000\"\n            },\n            {\n              \"label\": \"MLS Tier 3 rate (income >$168,000 singles / >$336,000 families)\",\n              \"amount\": \"1.5%\"\n            },\n            {\n              \"label\": \"Estimated annual MLS cost\",\n              \"amount\": \"$4,500\"\n            },\n            {\n              \"label\": \"Typical cost to add dependants to Gold cover\",\n              \"amount\": \"$1,500â€“$2,500\"\n            },\n            {\n              \"label\": \"Net annual saving\",\n              \"amount\": \"$2,000â€“$3,000\"\n            }\n          ],\n          \"action\": \"Contact your private health insurer to add all household members to your Gold hospital cover. Compare policies using the government's Private Health Insurance Ombudsman comparator tool.\",\n          \"url\": \"https://www.privatehealth.gov.au/\",\n          \"url_label\": \"Compare private health insurance policies\"\n        },\n        {\n          \"alert\": \"Division 293 tax â€” additional 15% on super contributions\",\n          \"severity\": \"medium\",\n          \"description\": \"With an estimated income of $300,000 plus super contributions, your combined income exceeds $250,000, triggering Division 293 tax.\",\n          \"estimated_cost\": \"$4,500\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Estimated income\",\n              \"amount\": \"$300,000\"\n            },\n            {\n              \"label\": \"+ Concessional super contributions\",\n              \"amount\": \"$30,000\"\n            },\n            {\n              \"label\": \"Combined income for Div 293 purposes\",\n              \"amount\": \"$330,000\"\n            },\n            {\n              \"label\": \"Div 293 threshold\",\n              \"amount\": \"$250,000\"\n            },\n            {\n              \"label\": \"Excess over threshold\",\n              \"amount\": \"$80,000\"\n            },\n            {\n              \"label\": \"Div 293 tax (15% on concessional contributions capped at excess)\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"Div 293 tax payable (15% Ã— $30,000)\",\n              \"amount\": \"$4,500\"\n            }\n          ],\n          \"action\": \"Be aware that your super contributions are taxed at 30% rather than the standard 15%. Consider whether the reduced tax benefit still makes salary sacrifice worthwhile.\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/super/in-detail/growing-your-super/division-293-tax\",\n          \"url_label\": \"Learn about Division 293 tax on the ATO\"\n        },\n        {\n          \"alert\": \"Sole trader business structure â€” consider company or trust\",\n          \"severity\": \"low\",\n          \"description\": \"You have started a sole trader business. While simple, it may not be the most tax-effective as your business grows.\",\n          \"estimated_cost\": \"$0\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Example: $50,000 business profit as sole trader\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Tax payable (47% marginal rate)\",\n              \"amount\": \"$23,500\"\n            },\n            {\n              \"label\": \"Example: $50,000 business profit via company\",\n              \"amount\": \"\"\n            },\n            {\n              \"label\": \"  Company tax (30%)\",\n              \"amount\": \"$15,000\"\n            },\n            {\n              \"label\": \"  Potential tax saving\",\n              \"amount\": \"$8,500\"\n            },\n            {\n              \"label\": \"Note: Extracting profit as dividends triggers personal tax\",\n              \"amount\": \"\"\n            }\n          ],\n          \"action\": \"Consider engaging an accountant to review your business structure. A company or trust structure may provide tax benefits and asset protection.\",\n          \"url\": \"https://www.ato.gov.au/business/starting-your-own-business/business-structures\",\n          \"url_label\": \"Learn about business structures on the ATO\"\n        },\n        {\n          \"alert\": \"Investment property negative gearing â€” cash flow impact\",\n          \"severity\": \"low\",\n          \"description\": \"If your investment property is negatively geared, you'll experience a cash flow shortfall that must be funded from your salary or other income.\",\n          \"estimated_cost\": \"$0\",\n          \"calculation_rows\": [\n            {\n              \"label\": \"Example: Rental income\",\n              \"amount\": \"$30,000\"\n            },\n            {\n              \"label\": \"â€“ Total property expenses (interest, rates, insurance, etc.)\",\n              \"amount\": \"â€“$44,400\"\n            },\n            {\n              \"label\": \"Net rental loss (negative gearing)\",\n              \"amount\": \"â€“$14,400\"\n            },\n            {\n              \"label\": \"Cash flow shortfall (must be funded from salary)\",\n              \"amount\": \"$14,400\"\n            },\n            {\n              \"label\": \"Tax saving (47% Ã— $14,400)\",\n              \"amount\": \"$6,768\"\n            },\n            {\n              \"label\": \"Net cash flow impact after tax saving\",\n              \"amount\": \"â€“$7,632\"\n            }\n          ],\n          \"action\": \"Review your investment property cash flow to ensure the shortfall is sustainable. Consider whether the property is likely to deliver capital growth.\",\n          \"url\": \"https://www.ato.gov.au/individuals-and-families/investments-and-assets/residential-rental-properties\",\n          \"url_label\": \"Learn about rental property deductions on the ATO\"\n        }\n      ]\n    },\n    \"lifestyle_scenarios\": {\n      \"title\": \"What Would This Look Like for Your Family?\",\n      \"content\": \"Explore how different financial strategies could impact your overall financial situation.\",\n      \"items\": [\n        {\n          \"title\": \"Salary sacrifice vs take-home pay trade-off\",\n          \"scenario\": \"Consider maximising salary sacrifice to superannuation to reduce your assessable income and increase government benefits. This scenario compares the impact.\",\n          \"option_a\": {\n            \"label\": \"Current position (no additional salary sacrifice)\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Estimated annual income\",\n                \"amount\": \"$300,000\"\n              },\n              {\n                \"label\": \"Tax payable (approx.)\",\n                \"amount\": \"$112,500\"\n              },\n              {\n                \"label\": \"Take-home pay\",\n                \"amount\": \"$187,500\"\n              },\n              {\n                \"label\": \"FTB A (base rate)\",\n                \"amount\": \"$2,224\"\n              },\n              {\n                \"label\": \"CCS value (47% subsidy)\",\n                \"amount\": \"$12,948\"\n              },\n              {\n                \"label\": \"MLS cost\",\n                \"amount\": \"â€“$4,500\"\n              },\n              {\n                \"label\": \"Total household position\",\n                \"amount\": \"$198,172\"\n              }\n            ],\n            \"total\": \"$198,172\"\n          },\n          \"option_b\": {\n            \"label\": \"Maximise salary sacrifice ($50,000 additional)\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Estimated annual income\",\n                \"amount\": \"$300,000\"\n              },\n              {\n                \"label\": \"â€“ Salary sacrifice to super\",\n                \"amount\": \"â€“$50,000\"\n              },\n              {\n                \"label\": \"Assessable income\",\n                \"amount\": \"$250,000\"\n              },\n              {\n                \"label\": \"Tax payable (approx.)\",\n                \"amount\": \"$88,000\"\n              },\n              {\n                \"label\": \"Take-home pay\",\n                \"amount\": \"$162,000\"\n              },\n              {\n                \"label\": \"FTB A (optimised)\",\n                \"amount\": \"$5,100\"\n              },\n              {\n                \"label\": \"CCS value (57% subsidy)\",\n                \"amount\": \"$24,570\"\n              },\n              {\n                \"label\": \"MLS cost (if PHI upgraded)\",\n                \"amount\": \"$0\"\n              },\n              {\n                \"label\": \"+ Super tax saving (locked until age 60)\",\n                \"amount\": \"+$8,500\"\n              },\n              {\n                \"label\": \"Total household position\",\n                \"amount\": \"$200,170\"\n              }\n            ],\n            \"total\": \"$200,170\"\n          },\n          \"bottom_line\": \"Maximising salary sacrifice increases your total household position by approximately $1,998 annually. However, your fortnightly take-home pay reduces by approximately $1,923, partially offset by increased FTB A and CCS. The super tax saving is locked until preservation age.\",\n          \"net_difference\": \"+$1,998 total annual benefit, but â€“$1,364 per fortnight in immediate cash flow\"\n        },\n        {\n          \"title\": \"Private health insurance upgrade â€” MLS vs premium cost\",\n          \"scenario\": \"Compare the cost of upgrading to family coverage versus continuing to pay the Medicare Levy Surcharge.\",\n          \"option_a\": {\n            \"label\": \"Current position (MLS applies)\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Current Gold hospital cover (primary earner only)\",\n                \"amount\": \"$2,000\"\n              },\n              {\n                \"label\": \"+ Medicare Levy Surcharge (1.5% of $300,000)\",\n                \"amount\": \"$4,500\"\n              },\n              {\n                \"label\": \"Total annual cost\",\n                \"amount\": \"$6,500\"\n              }\n            ],\n            \"total\": \"$6,500\"\n          },\n          \"option_b\": {\n            \"label\": \"Upgrade to family coverage\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Gold hospital cover (family)\",\n                \"amount\": \"$4,000\"\n              },\n              {\n                \"label\": \"Medicare Levy Surcharge\",\n                \"amount\": \"$0\"\n              },\n              {\n                \"label\": \"Total annual cost\",\n                \"amount\": \"$4,000\"\n              }\n            ],\n            \"total\": \"$4,000\"\n          },\n          \"bottom_line\": \"Upgrading to family coverage saves approximately $2,500 annually. The exact saving depends on your insurer's family premium.\",\n          \"net_difference\": \"Estimated $2,500 annual saving\"\n        },\n        {\n          \"title\": \"Investment property hold vs sell â€” capital gains tax impact\",\n          \"scenario\": \"Consider selling your investment property strategically to reduce capital gains tax liability.\",\n          \"option_a\": {\n            \"label\": \"Sell in FY2025-26 (current high income)\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Estimated capital gain (example)\",\n                \"amount\": \"$200,000\"\n              },\n              {\n                \"label\": \"50% CGT discount (held >12 months)\",\n                \"amount\": \"â€“$100,000\"\n              },\n              {\n                \"label\": \"Taxable capital gain\",\n                \"amount\": \"$100,000\"\n              },\n              {\n                \"label\": \"Marginal tax rate (45% + 2% Medicare Levy)\",\n                \"amount\": \"47%\"\n              },\n              {\n                \"label\": \"CGT payable (47% Ã— $100,000)\",\n                \"amount\": \"$47,000\"\n              }\n            ],\n            \"total\": \"$47,000 CGT\"\n          },\n          \"option_b\": {\n            \"label\": \"Sell in a lower-income year (e.g. income $80,000)\",\n            \"calculation_rows\": [\n              {\n                \"label\": \"Estimated capital gain (example)\",\n                \"amount\": \"$200,000\"\n              },\n              {\n                \"label\": \"50% CGT discount (held >12 months)\",\n                \"amount\": \"â€“$100,000\"\n              },\n              {\n                \"label\": \"Taxable capital gain\",\n                \"amount\": \"$100,000\"\n              },\n              {\n                \"label\": \"Marginal tax rate on gain (30% + 2% Medicare Levy)\",\n                \"amount\": \"32%\"\n              },\n              {\n                \"label\": \"CGT payable (32% Ã— $100,000)\",\n                \"amount\": \"$32,000\"\n              }\n            ],\n            \"total\": \"$32,000 CGT\"\n          },\n          \"bottom_line\": \"Selling your investment property in a lower-income year may save approximately $15,000 in capital gains tax.\",\n          \"net_difference\": \"Potential $15,000 CGT saving by timing sale strategically\"\n        }\n      ],\n      \"scenario_table\": {\n        \"description\": \"Shows how a Â±20% change in household income affects take-home pay and benefits. Income changes apply to the primary earner's estimated income of $300,000.\",\n        \"columns\": [\n          {\n            \"label\": \"â€“20% Income\",\n            \"income\": \"240000\"\n          },\n          {\n            \"label\": \"Assumed Income\",\n            \"income\": \"300000\"\n          },\n          {\n            \"label\": \"+20% Income\",\n            \"income\": \"360000\"\n          }\n        ],\n        \"rows\": [\n          {\n            \"label\": \"Gross income\",\n            \"values\": [\n              \"$240,000\",\n              \"$300,000\",\n              \"$360,000\"\n            ]\n          },\n          {\n            \"label\": \"Tax payable (approx.)\",\n            \"values\": [\n              \"$82,500\",\n              \"$112,500\",\n              \"$142,500\"\n            ]\n          },\n          {\n            \"label\": \"Take-home pay\",\n            \"values\": [\n              \"$157,500\",\n              \"$187,500\",\n              \"$217,500\"\n            ]\n          },\n          {\n            \"label\": \"FTB A\",\n            \"values\": [\n              \"$5,773\",\n              \"$2,224\",\n              \"$0\"\n            ]\n          },\n          {\n            \"label\": \"FTB B\",\n            \"values\": [\n              \"$0\",\n              \"$0\",\n              \"$0\"\n            ]\n          },\n          {\n            \"label\": \"CCS saving (annual value)\",\n            \"values\": [\n              \"$26,000\",\n              \"$12,948\",\n              \"$0\"\n            ]\n          },\n          {\n            \"label\": \"MLS cost\",\n            \"values\": [\n              \"â€“$3,600\",\n              \"â€“$4,500\",\n              \"â€“$5,400\"\n            ]\n          },\n          {\n            \"label\": \"Tax deduction savings (approx.)\",\n            \"values\": [\n              \"$15,000\",\n              \"$18,800\",\n              \"$22,600\"\n            ]\n          },\n          {\n            \"label\": \"Total household position\",\n            \"values\": [\n              \"$200,673\",\n              \"$216,972\",\n              \"$234,700\"\n            ]\n          }\n        ],\n        \"insight\": \"A 20% reduction in income increases FTB A and CCS substantially, partially offsetting the lower take-home pay. Conversely, a 20% increase in income eliminates FTB A and CCS entirely, but higher take-home pay and tax deduction savings increase your total position.\"\n      }\n    }\n  },\n  \"total_new_opportunities\": 11,\n  \"total_confirm_existing\": 1,\n  \"estimated_total_savings\": 67568,\n  \"meta\": {\n    \"confident\": true,\n    \"tone_check\": \"professional_friendly_australian\",\n    \"disclaimer_included\": true,\n    \"acronyms_expanded\": true\n  }\n}",
                "refusal": null,
                "annotations": []
              },
              "logprobs": null,
              "finish_reason": "stop"
            }
          ],
          "usage": {
            "prompt_tokens": 17364,
            "completion_tokens": 11795,
            "total_tokens": 29159,
            "prompt_tokens_details": {
              "cached_tokens": 16384,
              "audio_tokens": 0
            },
            "completion_tokens_details": {
              "reasoning_tokens": 0,
              "audio_tokens": 0,
              "accepted_prediction_tokens": 0,
              "rejected_prediction_tokens": 0
            }
          },
          "service_tier": "default",
          "system_fingerprint": "fp_ad98c18a04"
        },
        "pairedItem": {
          "item": 0
        }
      }
    ]
  },
  "connections": {
    "T1 Webhook Form Submit": {
      "main": [
        [
          {
            "node": "C1 Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "C1 Config": {
      "main": [
        [
          {
            "node": "P1 Parse & Validate Form Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "P1 Parse & Validate Form Data": {
      "main": [
        [
          {
            "node": "R1 Route By Validity",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "R1 Route By Validity": {
      "main": [
        [
          {
            "node": "R2 Route By Form Type",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "S1 DLQ Store",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S1 DLQ Store": {
      "main": [
        [
          {
            "node": "X1 Send DLQ Alert",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "MCP": {
      "main": [
        [
          {
            "node": "C1 Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X1 Send DLQ Alert": {
      "main": [
        []
      ]
    },
    "R2 Route By Form Type": {
      "main": [
        [
          {
            "node": "P3 Prepare Full Analysis Payload",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "P2 Prepare Quick Analysis Payload",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "P2 Prepare Quick Analysis Payload": {
      "main": [
        [
          {
            "node": "P4 Redact PII For LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "P3 Prepare Full Analysis Payload": {
      "main": [
        [
          {
            "node": "P4 Redact PII For LLM",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "P4 Redact PII For LLM": {
      "main": [
        [
          {
            "node": "E1 Build L1 Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "U2 Merge L1 Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "E1 Build L1 Request": {
      "main": [
        [
          {
            "node": "L1 GPT Classify Eligibility",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L1 GPT Classify Eligibility": {
      "main": [
        [
          {
            "node": "U2 Merge L1 Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "U2 Merge L1 Data": {
      "main": [
        [
          {
            "node": "N2 Parse L1 & Build L2 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "N2 Parse L1 & Build L2 Context": {
      "main": [
        [
          {
            "node": "E2 Build L2 Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "U3 Merge L2 Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "E2 Build L2 Request": {
      "main": [
        [
          {
            "node": "L2 Claude Deep Tax Analysis",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L2 Claude Deep Tax Analysis": {
      "main": [
        [
          {
            "node": "U3 Merge L2 Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "U3 Merge L2 Data": {
      "main": [
        [
          {
            "node": "N3 Parse L2 & Build L3 Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "N3 Parse L2 & Build L3 Context": {
      "main": [
        [
          {
            "node": "E3 Build L3 Request",
            "type": "main",
            "index": 0
          },
          {
            "node": "U4 Merge L3 Data",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "E3 Build L3 Request": {
      "main": [
        [
          {
            "node": "L3 GPT Generate Report Narrative",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "L3 GPT Generate Report Narrative": {
      "main": [
        [
          {
            "node": "U4 Merge L3 Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "U4 Merge L3 Data": {
      "main": [
        [
          {
            "node": "N4 Normalise Report Structure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "R3 Route By Report Completeness": {
      "main": [
        [
          {
            "node": "P5 build html email",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "S2 DLQ Report Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S2 DLQ Report Error": {
      "main": [
        [
          {
            "node": "X2 Alert Chris Report Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "N4 Normalise Report Structure": {
      "main": [
        [
          {
            "node": "R3 Route By Report Completeness",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "P5 build html email": {
      "main": [
        [
          {
            "node": "S3 Store Submission To Sheets",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "S3 Store Submission To Sheets": {
      "main": [
        [
          {
            "node": "X3 Send Report Email To User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X3 Send Report Email To User": {
      "main": [
        [
          {
            "node": "X4 Send Lead Alert To Chris",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "X4 Send Lead Alert To Chris": {
      "main": [
        [
          {
            "node": "V1 Universal Costing",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "V1 Universal Costing": {
      "main": [
        [
          {
            "node": "$ Execute Sub",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": true,
    "timeSavedMode": "fixed",
    "timezone": "Australia/Sydney",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "RNd6UbemVRSPER7Z",
    "timeSavedPerExecution": 5
  },
  "versionId": "24a58bfa-cde1-423c-8b1a-bf5bb4d992d5",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "06958b343b74ae1e5bda7aa40c5da05df72593220e7280ef4f350045d5e4d961"
  },
  "id": "nV1wnx2LSWJQNl3le6Ctl",
  "tags": []
}